<%- include('../partials/head') %>
    <%- include('../partials/navbar') %>
        <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
        <style>
            /* Custom Quill Editor Styling for Comments */
            .ql-toolbar.ql-snow {
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1) !important;
                border-radius: 12px 12px 0 0;
                padding: 4px 8px !important;
            }

            .ql-container.ql-snow {
                background: rgba(255, 255, 255, 0.02);
                border: 1px solid rgba(255, 255, 255, 0.1) !important;
                border-top: none !important;
                border-radius: 0 0 12px 12px;
                color: #f3f4f6;
            }

            .ql-editor {
                font-size: 0.875rem;
            }

            #commentEditor .ql-editor {
                min-height: 80px;
                padding: 8px 12px !important;
            }

            .timeline-item .ql-editor {
                padding: 0 !important;
                min-height: unset !important;
                line-height: 1.3 !important;
                white-space: normal !important;
            }

            .timeline-item .ql-editor * {
                margin: 0 !important;
                padding: 0 !important;
                white-space: normal !important;
            }

            .timeline-item .ql-editor p {
                margin: 0 !important;
                padding: 0 !important;
                line-height: 1.3 !important;
                white-space: normal !important;
            }

            .timeline-item .prose p {
                margin-top: 0 !important;
                margin-bottom: 0 !important;
            }

            .timeline-item .prose>* {
                margin-top: 0 !important;
                margin-bottom: 0 !important;
            }

            .ql-toolbar.ql-snow .ql-stroke {
                stroke: #9ca3af !important;
            }

            .ql-toolbar.ql-snow .ql-fill {
                fill: #9ca3af !important;
            }

            .ql-toolbar.ql-snow .ql-picker {
                color: #9ca3af !important;
            }

            .custom-scrollbar::-webkit-scrollbar {
                width: 4px;
            }

            .custom-scrollbar::-webkit-scrollbar-track {
                background: rgba(255, 255, 255, 0.05);
            }

            .custom-scrollbar::-webkit-scrollbar-thumb {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 10px;
            }

            .timeline-container {
                position: relative;
                padding-left: 2rem;
            }

            .timeline-line {
                position: absolute;
                left: 0.5rem;
                top: 0;
                bottom: 0;
                width: 2px;
                background: rgba(99, 102, 241, 0.2);
            }

            .timeline-item {
                position: relative;
                margin-bottom: 0.75rem;
            }

            .timeline-dot {
                position: absolute;
                left: -1.85rem;
                top: 0.25rem;
                width: 0.75rem;
                height: 0.75rem;
                border-radius: 50%;
                background: #6366f1;
                border: 2px solid rgba(255, 255, 255, 0.1);
                box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
            }

            .timeline-dot.log {
                background: #10b981;
                box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
            }
        </style>

        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col lg:flex-row gap-6">
                <!-- Main Content (Left) -->
                <div class="lg:w-2/3">
                    <div class="glass-card overflow-hidden shadow-2xl">
                        <div class="p-4 sm:p-6">
                            <div class="mb-4 border-b border-white/10 pb-4">
                                <div class="mb-2">
                                    <h1 class="text-2xl sm:text-3xl font-black text-gray-100 mb-2 leading-tight">
                                        <%= complaint.judul %>
                                    </h1>
                                    <div class="flex flex-wrap items-center gap-2 text-xs font-medium">
                                        <span
                                            class="flex items-center px-2 py-0.5 rounded-full border
                                            <%= complaint.status === 'pending' ? 'text-yellow-300 bg-yellow-500/10 border-yellow-500/20' : 
                                                complaint.status === 'proses' ? 'text-blue-300 bg-blue-500/10 border-blue-500/20' : 
                                                complaint.status === 'selesai' ? 'text-emerald-300 bg-emerald-500/10 border-emerald-500/20' : 'text-red-300 bg-red-500/10 border-red-500/20' %>">
                                            <svg class="mr-1 h-3 w-3" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <%= complaint.status.toUpperCase() %>
                                        </span>
                                        <span
                                            class="flex items-center text-gray-400 bg-white/5 px-2 py-0.5 rounded-full border border-white/10">
                                            <svg class="mr-1 h-3 w-3" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z">
                                                </path>
                                            </svg>
                                            <% if (complaint.is_anonim && complaint.nama_warga) { const
                                                words=complaint.nama_warga.split(' ');
                                                const parts = words.map(w => {
                                                    if (w.length <= 1) return { first: w, blur: '' };
                                                    return { first: w[0], blur: w.substring(1) };
                                                });
                                            %>
                                                <% parts.forEach((part, idx) => { %><%= part.first %><% if (part.blur) { %><span class="blur-sm select-none" style="filter: blur(4px)"><%= part.blur %></span><% } %><% if (idx < parts.length - 1) { %> <% } %><% }); %>
                                            <% } else { %>
                                                <%= complaint.nama_warga || ' User' %>
                                                <% } %>
                                        </span>
                                        <span
                                            class="flex items-center text-gray-400 bg-white/5 px-2 py-0.5 rounded-full border border-white/10">
                                            <svg class="mr-1 h-3 w-3" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <%= complaint.formattedDate %>
                                        </span>
                                    </div>
                                </div>

                                <div class="flex flex-wrap gap-2">
                                    <a href="/pengaduan"
                                        class="flex items-center justify-center px-3 py-1.5 rounded-lg text-sm glass-button text-gray-300 font-bold border border-white/10 hover:bg-white/10 transition-all">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                        </svg>
                                        Kembali
                                    </a>
                                    <button onclick="shareToWA()"
                                        class="flex items-center justify-center px-3 py-1.5 rounded-lg text-sm bg-green-500/10 hover:bg-green-500/20 text-green-400 font-bold border border-green-500/20 transition-all">
                                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                            <path
                                                d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.463 1.065 2.876 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z" />
                                        </svg>
                                        Share WA
                                    </button>

                                    <% if (['admin', 'ketua' , 'bendahara' ].includes(user.role) ||
                                        (user.warga_id==complaint.warga_id)) { %>
                                        <a href="/pengaduan/delete/<%= complaint.id %>"
                                            onclick="return confirm('Apakah anda yakin ingin menghapus pengaduan ini? Data yang dihapus tidak dapat dikembalikan.')"
                                            class="flex items-center justify-center px-3 py-1.5 rounded-lg text-sm bg-red-500/10 hover:bg-red-500/20 text-red-400 font-bold border border-red-500/20 transition-all">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                                </path>
                                            </svg>
                                            Hapus
                                        </a>
                                        <% } %>
                                </div>
                            </div>

                            <div class="prose prose-invert max-w-none text-gray-200 mb-4" style="line-height: 1.6;">
                                <%= complaint.deskripsi %>
                            </div>

                            <% if(complaint.foto) { %>
                                <div class="mt-6 border-t border-white/10 pt-4">
                                    <h3 class="text-lg font-bold text-gray-100 mb-3 flex items-center">
                                        <svg class="w-5 h-5 mr-2 text-indigo-400" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                            </path>
                                        </svg>
                                        Bukti Foto
                                    </h3>
                                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                        <div class="relative group cursor-pointer overflow-hidden rounded-2xl border border-white/10 bg-white/5 aspect-square flex items-center justify-center transition-all hover:border-indigo-500/50"
                                            onclick="openPreview('<%= complaint.foto %>')">
                                            <img src="<%= complaint.foto %>"
                                                class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                                            <div
                                                class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7">
                                                    </path>
                                                </svg>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <% } %>
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar -->
                <div class="lg:w-1/3 space-y-6">
                    <!-- Diskusi & Aktivitas Card -->
                    <div class="glass-card p-4 sm:p-6 rounded-xl shadow-2xl sticky top-24">
                        <h3
                            class="text-lg font-bold text-gray-100 mb-4 border-b border-white/10 pb-2 flex items-center gap-2">
                            <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
                                </path>
                            </svg>
                            Diskusi & Aktivitas
                        </h3>

                        <!-- Status Update Form -->
                        <form action="/pengaduan/<%= complaint.id %>/update" method="POST"
                            class="mb-6 p-4 bg-white/5 rounded-xl border border-white/10">
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-2">Update
                                    Status</label>
                                <div class="flex gap-2">
                                    <select name="status"
                                        class="glass-input flex-1 px-3 py-2 rounded-lg bg-black/20 border border-white/10 text-gray-200 focus:bg-gray-800 text-sm">
                                        <option value="pending" <%=complaint.status==='pending' ? 'selected' : '' %>
                                            >Pending</option>
                                        <option value="proses" <%=complaint.status==='proses' ? 'selected' : '' %>
                                            >Sedang Diproses</option>
                                        <option value="selesai" <%=complaint.status==='selesai' ? 'selected' : '' %>
                                            >Selesai</option>
                                        <% if(user && (['admin', 'bendahara' , 'ketua' ].includes(user.role))) { %>
                                            <option value="ditolak" <%=complaint.status==='ditolak' ? 'selected' : '' %>
                                                >Ditolak</option>
                                            <% } %>
                                    </select>
                                    <button type="submit"
                                        class="glass-button bg-indigo-600/20 hover:bg-indigo-600/30 text-white font-bold px-4 py-2 rounded-lg border border-indigo-500/30 transition shadow-lg shadow-indigo-500/10 text-sm">
                                        Update
                                    </button>
                                </div>
                            </div>
                            <input type="text" name="tanggapan" placeholder="Catatan perubahan status... (Opsional)"
                                class="glass-input w-full px-3 py-2 rounded-lg bg-black/20 border border-white/10 text-gray-200 text-xs focus:bg-gray-800">
                        </form>

                        <!-- Timeline List -->
                        <div class="timeline-container mb-6 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar">
                            <div class="timeline-line"></div>

                            <!-- Initial Post Log -->
                            <div class="timeline-item">
                                <div class="timeline-dot log"></div>
                                <div class="bg-indigo-500/10 p-3 rounded-xl border border-indigo-500/20">
                                    <div class="flex items-center justify-between mb-1">
                                        <span
                                            class="text-[10px] font-bold text-indigo-400 uppercase tracking-wider">Aduan
                                            Dibuat</span>
                                        <span class="text-[10px] text-gray-500">
                                            <%= moment(complaint.created_at).fromNow() %>
                                        </span>
                                    </div>
                                    <div class="text-xs text-gray-300">
                                        Oleh <span class="font-bold text-gray-100">
                                            <% if (complaint.is_anonim && complaint.nama_warga) { const
                                                words=complaint.nama_warga.split(' ');
                                                const parts = words.map(w => {
                                                    if (w.length <= 1) return { first: w, blur: '' };
                                                    return { first: w[0], blur: w.substring(1) };
                                                });
                                            %>
                                                <% parts.forEach((part, idx) => { %><%= part.first %><% if (part.blur) { %><span class="blur-sm select-none" style="filter: blur(4px)"><%= part.blur %></span><% } %><% if (idx < parts.length - 1) { %> <% } %><% }); %>
                                            <% } else { %>
                                                <%= complaint.nama_warga || ' User' %>
                                                <% } %>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Timeline Items -->
                            <% if(typeof timeline !=='undefined' && timeline.length> 0) { %>
                                <% timeline.forEach(item=> { %>
                                    <% if(item.type==='log' ) { %>
                                        <!-- Log Item -->
                                        <div class="timeline-item">
                                            <div class="timeline-dot log"></div>
                                            <div class="bg-purple-500/10 p-3 rounded-xl border border-purple-500/20">
                                                <div class="flex items-center justify-between mb-1">
                                                    <span
                                                        class="text-[10px] font-bold text-purple-400 uppercase tracking-wider">Aktivitas</span>
                                                    <span class="text-[10px] text-gray-500">
                                                        <%= moment(item.created_at).fromNow() %>
                                                    </span>
                                                </div>
                                                <div class="text-xs text-gray-200"><%-
                                                        item.konten.trim().replace(/\n/g, '<br>' ) %></div>
                                                <div class="text-[10px] text-gray-400 mt-1">
                                                    Oleh <span class="font-bold text-gray-300">
                                                        <%= item.warga_nama || item.username %>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <% } else { %>
                                            <!-- Comment Item -->
                                            <div class="timeline-item group">
                                                <div class="timeline-dot"></div>
                                                <div class="flex items-start gap-2 w-full">
                                                    <div
                                                        class="w-7 h-7 rounded-full bg-indigo-500/20 flex items-center justify-center text-indigo-400 font-bold text-xs flex-shrink-0">
                                                        <%= (item.warga_nama || item.username).charAt(0).toUpperCase()
                                                            %>
                                                    </div>
                                                    <div class="flex items-start gap-1 flex-1">
                                                        <div
                                                            class="flex flex-col max-w-[90%] leading-tight bg-white/5 rounded-2xl border border-white/10 px-3 py-2">
                                                            <div class="flex items-center gap-2 mb-1">
                                                                <span class="text-xs font-semibold text-indigo-400">
                                                                    <%= item.warga_nama || item.username %>
                                                                </span>
                                                                <span class="text-[10px] text-gray-500">
                                                                    <%= moment(item.created_at).fromNow() %>
                                                                </span>
                                                            </div>
                                                            <% if(item.parent_id) { %>
                                                                <div
                                                                    class="mb-2 p-2 bg-white/5 rounded-lg border-l-2 border-indigo-500/30">
                                                                    <div
                                                                        class="text-[10px] text-indigo-400 font-semibold mb-1">
                                                                        ‚Ü≥ Membalas <%= item.parent_warga_nama ||
                                                                            item.parent_username %>
                                                                    </div>
                                                                    <div
                                                                        class="text-[11px] text-gray-400 italic line-clamp-2 ql-editor prose prose-invert max-w-none !p-0 !m-0">
                                                                        <%- item.parent_konten %>
                                                                    </div>
                                                                </div>
                                                                <% } %>
                                                                    <div
                                                                        class="text-xs text-gray-300 ql-editor prose prose-invert max-w-none !p-0 !m-0">
                                                                        <%- item.konten %>
                                                                    </div>
                                                                    <% if(item.lampiran) { %>
                                                                        <div class="mt-2">
                                                                            <% if(item.lampiran.match(/\.(jpg|jpeg|png|gif)$/i))
                                                                                { %>
                                                                                <img src="/uploads/pengaduan/<%= item.lampiran %>"
                                                                                    class="max-h-48 rounded-lg border border-white/10 cursor-pointer hover:opacity-90 transition-opacity"
                                                                                    onclick="openPreview(this.src)">
                                                                                <% } else { %>
                                                                                    <a href="/uploads/pengaduan/<%= item.lampiran %>"
                                                                                        target="_blank"
                                                                                        class="flex items-center gap-2 p-2 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 transition-colors w-fit">
                                                                                        <svg class="w-4 h-4 text-indigo-400"
                                                                                            fill="none"
                                                                                            stroke="currentColor"
                                                                                            viewBox="0 0 24 24">
                                                                                            <path stroke-linecap="round"
                                                                                                stroke-linejoin="round"
                                                                                                stroke-width="2"
                                                                                                d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13">
                                                                                            </path>
                                                                                        </svg>
                                                                                        <span
                                                                                            class="text-xs text-indigo-300 truncate max-w-[150px]">
                                                                                            <%= item.lampiran %>
                                                                                        </span>
                                                                                    </a>
                                                                                    <% } %>
                                                                        </div>
                                                                        <% } %>
                                                                            <div class="hidden"
                                                                                data-comment-content-<%=item.id%>><%-
                                                                                    item.konten %></div>
                                                        </div>
                                                        <button type="button"
                                                            class="reply-btn text-gray-500 hover:text-indigo-400 transition-colors opacity-0 group-hover:opacity-100 p-1"
                                                            data-comment-id="<%= item.id %>"
                                                            data-user-name="<%= item.warga_nama || item.username %>"
                                                            title="Balas">
                                                            <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                                viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                                    stroke-width="2"
                                                                    d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6">
                                                                </path>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <% } %>
                                                <% }) %>
                                                    <% } %>
                        </div>

                        <!-- Comment Form -->
                        <form action="/pengaduan/comment" method="POST" id="commentForm" enctype="multipart/form-data">
                            <input type="hidden" name="pengaduan_id" value="<%= complaint.id %>">
                            <input type="hidden" name="parent_id" id="parentId" value="">
                            <div id="replyIndicator"
                                class="hidden mb-2 p-3 bg-indigo-500/10 rounded-lg border border-indigo-500/20">
                                <div class="flex items-start justify-between mb-2">
                                    <span class="text-xs text-indigo-400 font-semibold">Membalas: <span
                                            id="replyToName"></span></span>
                                    <button type="button" onclick="cancelReply()"
                                        class="text-xs text-gray-400 hover:text-gray-200">‚úï</button>
                                </div>
                                <div id="replyPreview"
                                    class="text-[11px] text-gray-400 italic line-clamp-2 pl-2 border-l-2 border-indigo-500/30">
                                </div>
                            </div>
                            <div class="mb-3">
                                <div id="commentEditor" class="bg-white/5 rounded-xl border border-white/10"></div>
                                <input type="hidden" name="konten" id="commentKonten">
                            </div>

                            <div class="mb-3">
                                <label class="block text-xs font-medium text-gray-400 mb-1">Lampiran (Opsional)</label>
                                <div id="dropzone"
                                    class="relative border-2 border-dashed border-gray-600 hover:border-indigo-400 bg-white/5 rounded-xl p-4 transition-all group cursor-pointer text-center">
                                    <input type="file" name="lampiran" id="lampiranInput"
                                        accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt" class="hidden">

                                    <!-- Default View -->
                                    <div id="dropzone-content"
                                        class="flex flex-col items-center justify-center space-y-2">
                                        <div
                                            class="w-10 h-10 bg-white/5 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform">
                                            <svg class="w-5 h-5 text-gray-400 group-hover:text-indigo-400" fill="none"
                                                stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                                </path>
                                            </svg>
                                        </div>
                                        <div class="text-xs text-gray-400 font-medium">Klik atau drop file di sini</div>
                                    </div>

                                    <!-- Preview View -->
                                    <div id="preview-container" class="hidden relative group/preview">
                                        <img id="preview-thumb" src="" alt="Preview"
                                            class="mx-auto max-h-32 rounded-lg shadow-lg object-contain hidden">

                                        <div id="preview-file"
                                            class="hidden flex flex-col items-center justify-center p-4">
                                            <svg class="w-12 h-12 text-indigo-400 mb-2" fill="none"
                                                stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                                                </path>
                                            </svg>
                                            <span id="preview-filename"
                                                class="text-xs text-gray-300 font-medium truncate max-w-[200px]"></span>
                                        </div>
                                        <div
                                            class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover/preview:opacity-100 transition-opacity rounded-lg">
                                            <button type="button" id="remove-file"
                                                class="bg-red-500 hover:bg-red-600 text-white p-1.5 rounded-full shadow-lg transform scale-90 hover:scale-110 transition-all">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="submit"
                                class="w-full py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold transition-all shadow-lg shadow-indigo-600/20 flex items-center justify-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                                Kirim Komentar
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function shareToWA() {
                const title = "<%= complaint.judul %>";
                const status = "<%= complaint.status.toUpperCase() %>";
                const statusText = status === 'PENDING' ? '‚è≥ Menunggu Respon' : status === 'PROSES' ? 'üõ† Sedang Diproses' : status === 'SELESAI' ? '‚úÖ Selesai' : '‚ùå Ditolak';
                const link = window.location.href;

                const text = `*PENGADUAN WARGA*\n\nJudul: ${title}\nStatus: ${statusText}\n\nLihat detail dan progress:\n${link}`;

                window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
            }
        </script>
        <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
        <script>









        </script>

        <!-- Image Preview Modal -->
        <div id="previewModal"
            class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm">
            <button onclick="closePreview()"
                class="absolute top-6 right-6 text-white/50 hover:text-white transition-colors">
                <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
            <img id="previewImage" src=""
                class="max-w-full max-h-full rounded-lg shadow-2xl transform transition-all duration-300 scale-95">
        </div>

        <!-- Giphy Modal -->
        <div id="giphyModal"
            class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
            <div class="glass-card w-full max-w-lg p-0 overflow-hidden flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-white/10 flex items-center justify-between bg-white/5">
                    <h3 class="text-lg font-bold text-gray-100 flex items-center gap-2">
                        <span class="text-xl">üëæ</span> Cari GIF
                    </h3>
                    <button onclick="closeGiphyModal()" class="text-gray-400 hover:text-white transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="p-4 bg-black/20">
                    <div class="relative">
                        <input type="text" id="giphySearch" placeholder="Cari GIF lucu..."
                            class="w-full glass-input py-2 px-4 rounded-lg pl-10 text-white placeholder-gray-500 focus:ring-2 focus:ring-indigo-500/50"
                            onkeyup="handleGiphySearch(event)">
                        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                </div>

                <div id="giphyResults"
                    class="flex-1 overflow-y-auto p-4 grid grid-cols-3 gap-2 md:gap-4 custom-scrollbar min-h-[300px]">
                    <!-- GIFs will appear here -->
                    <div class="col-span-3 text-center text-gray-500 py-10">Ketik sesuatu untuk mencari GIF...</div>
                </div>

                <div class="p-2 border-t border-white/10 bg-white/5 text-center">
                    <img src="https://developers.giphy.com/branch/master/static/header-logo-0fec0225d189bc0eae27dac3e3770582.gif"
                        alt="Powered by Giphy" class="h-6 mx-auto opacity-70">
                </div>
            </div>
        </div>



        <!-- Add a custom icon for the GIF button -->
        <style>
            .ql-snow .ql-picker.ql-header {
                width: auto !important;
            }

            .ql-snow .ql-toolbar button.ql-gif {
                width: 28px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .ql-snow .ql-toolbar button.ql-gif svg {
                width: 18px;
                height: 18px;
            }

            .gif-loading {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100px;
                grid-column: span 3;
                color: #a78bfa;
            }
        </style>

        <script>
            // Register GIF icon
            var icons = Quill.import('ui/icons');
            icons['gif'] = '<svg viewBox="0 0 24 24" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><path d="M9 10h-.5a2 2 0 0 0-2 2v1a2 2 0 0 0 2 2h.5"></path><path d="M9 13h-2"></path><path d="M13 10v6"></path><path d="M17 10v6"></path><path d="M17 10h1.5"></path><path d="M17 13h1.5"></path></svg>';

            var commentQuill = new Quill('#commentEditor', {
                theme: 'snow',
                placeholder: 'Tulis komentar...',
                modules: {
                    toolbar: {
                        container: [
                            ['bold', 'italic', 'underline'],
                            ['link'],
                            ['gif'] // Add custom GIF button
                        ],
                        handlers: {
                            'gif': function () {
                                openGiphyModal();
                            }
                        }
                    }
                }
            });

            // GIPHY LOGIC
            const GIPHY_API_KEY = 'SHdHxj0NpOMqzCEueq1puSL0fMN8RTLw';
            let searchTimeout;

            function openGiphyModal() {
                document.getElementById('giphyModal').classList.remove('hidden');
                document.getElementById('giphySearch').focus();
                // Load trending if empty
                if (document.getElementById('giphyResults').children.length <= 1) {
                    searchGiphy('trending');
                }
                document.body.style.overflow = 'hidden';
            }

            function closeGiphyModal() {
                document.getElementById('giphyModal').classList.add('hidden');
                document.body.style.overflow = '';
            }

            // Close on escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !document.getElementById('giphyModal').classList.contains('hidden')) {
                    closeGiphyModal();
                }
            });

            function handleGiphySearch(e) {
                clearTimeout(searchTimeout);
                const query = e.target.value;

                searchTimeout = setTimeout(() => {
                    searchGiphy(query);
                }, 500);
            }

            async function searchGiphy(query) {
                const container = document.getElementById('giphyResults');
                container.innerHTML = '<div class="gif-loading"><svg class="animate-spin h-8 w-8 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';

                try {
                    let url;
                    if (!query || query === 'trending') {
                        url = `https://api.giphy.com/v1/gifs/trending?api_key=${GIPHY_API_KEY}&limit=12&rating=g`;
                    } else {
                        url = `https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_API_KEY}&q=${encodeURIComponent(query)}&limit=12&rating=g`;
                    }

                    const response = await fetch(url);
                    const data = await response.json();

                    container.innerHTML = '';

                    if (data.data.length === 0) {
                        container.innerHTML = '<div class="col-span-3 text-center text-gray-500 py-10">Tidak ditemukan GIF...</div>';
                        return;
                    }

                    data.data.forEach(gif => {
                        const div = document.createElement('div');
                        div.className = 'cursor-pointer rounded-lg overflow-hidden border border-white/5 hover:border-indigo-500/50 transition-all aspect-square relative group bg-black/20 p-1 m-1';

                        const img = document.createElement('img');
                        img.src = gif.images.fixed_height_small.url;
                        img.className = 'w-full h-full object-cover rounded';

                        div.onclick = () => insertGif(gif.images.downsized.url);

                        div.appendChild(img);
                        container.appendChild(div);
                    });

                } catch (error) {
                    console.error('Error fetching Giphy:', error);
                    container.innerHTML = '<div class="col-span-3 text-center text-red-400 py-10">Gagal memuat GIF.</div>';
                }
            }

            function insertGif(url) {
                const range = commentQuill.getSelection(true);
                commentQuill.insertEmbed(range.index, 'image', url);
                commentQuill.setSelection(range.index + 1);
                closeGiphyModal();
            }

            document.getElementById('commentForm').onsubmit = function () {
                const fileInput = document.getElementById('lampiranInput');
                // Check if Quill has content (images, text, etc)
                const hasContent = commentQuill.getLength() > 1; // 1 because empty is newline
                const hasFile = fileInput.files.length > 0;

                if (!hasContent && !hasFile) {
                    alert('Mohon tulis komentar atau sertakan lampiran.');
                    return false;
                }
                document.getElementById('commentKonten').value = commentQuill.root.innerHTML;
            };

            // Event delegation for reply buttons
            document.addEventListener('click', function (e) {
                if (e.target.classList.contains('reply-btn') || e.target.closest('.reply-btn')) {
                    const btn = e.target.classList.contains('reply-btn') ? e.target : e.target.closest('.reply-btn');
                    const commentId = btn.dataset.commentId;
                    const userName = btn.dataset.userName;

                    // Get the content from the hidden div
                    const contentDiv = document.querySelector(`[data-comment-content-${commentId}]`);
                    const content = contentDiv ? contentDiv.innerHTML : '';

                    document.getElementById('parentId').value = commentId;
                    document.getElementById('replyToName').textContent = userName;
                    if (content) {
                        document.getElementById('replyPreview').innerHTML = content;
                        // Style images in preview
                        const images = document.getElementById('replyPreview').getElementsByTagName('img');
                        for (let img of images) {
                            img.style.maxHeight = '60px';
                            img.style.width = 'auto';
                            img.style.borderRadius = '4px';
                        }
                    } else {
                        document.getElementById('replyPreview').textContent = '(konten tidak tersedia)';
                    }
                    document.getElementById('replyIndicator').classList.remove('hidden');
                    commentQuill.focus();
                }
            });

            function cancelReply() {
                document.getElementById('parentId').value = '';
                document.getElementById('replyIndicator').classList.add('hidden');
                document.getElementById('replyPreview').textContent = '';
            }

            function openPreview(src) {
                const modal = document.getElementById('previewModal');
                const img = document.getElementById('previewImage');
                img.src = src;
                modal.classList.remove('hidden');
                setTimeout(() => {
                    img.classList.remove('scale-95');
                    img.classList.add('scale-100');
                }, 10);
                document.body.style.overflow = 'hidden';
            }

            function closePreview() {
                const modal = document.getElementById('previewModal');
                const img = document.getElementById('previewImage');
                img.classList.remove('scale-100');
                img.classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
                document.body.style.overflow = '';
            }

            // Close modal on escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closePreview();
            });

            // Dropzone Logic
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('lampiranInput');
            const previewContainer = document.getElementById('preview-container');
            const dropzoneContent = document.getElementById('dropzone-content');
            const previewImage = document.getElementById('preview-thumb');
            const previewFile = document.getElementById('preview-file');
            const previewFilename = document.getElementById('preview-filename');
            const removeBtn = document.getElementById('remove-file');

            // Handle Drag Events
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                // Ensure dropzone exists before adding listener
                if (dropzone) dropzone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                if (dropzone) dropzone.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                if (dropzone) dropzone.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                dropzone.classList.add('border-indigo-500', 'bg-white/10');
                dropzone.classList.remove('border-gray-600', 'bg-white/5');
            }

            function unhighlight(e) {
                dropzone.classList.remove('border-indigo-500', 'bg-white/10');
                dropzone.classList.add('border-gray-600', 'bg-white/5');
            }

            // Handle Drop
            if (dropzone) dropzone.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }

            // Handle Click
            if (dropzone) {
                dropzone.addEventListener('click', (e) => {
                    if (e.target !== removeBtn && !removeBtn.contains(e.target)) {
                        fileInput.click();
                    }
                });
            }

            if (fileInput) {
                fileInput.addEventListener('change', function () {
                    handleFiles(this.files);
                });
            }

            function handleFiles(files) {
                if (files.length > 0) {
                    const file = files[0];

                    // Show container
                    dropzoneContent.classList.add('hidden');
                    previewContainer.classList.remove('hidden');

                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            previewImage.src = e.target.result;
                            previewImage.classList.remove('hidden');
                            previewFile.classList.add('hidden');
                        }
                        reader.readAsDataURL(file);
                    } else {
                        // Document file
                        previewImage.classList.add('hidden');
                        previewFile.classList.remove('hidden');
                        previewFilename.textContent = file.name;
                    }

                    // If files came from drop, async assign to input
                    if (fileInput.files !== files) {
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        fileInput.files = dataTransfer.files;
                    }
                }
            }

            // Remove File
            if (removeBtn) {
                removeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    fileInput.value = ''; // Clear input
                    previewImage.src = '';
                    previewFilename.textContent = '';
                    previewImage.classList.add('hidden');
                    previewFile.classList.add('hidden');
                    previewContainer.classList.add('hidden');
                    dropzoneContent.classList.remove('hidden');
                });
            }
        </script>
        <%- include('../partials/footer') %>