<%- include('../partials/head') %>
    <%- include('../partials/navbar') %>

        <!-- Bento Grid Layout -->
        <% if(user && user.approval_status==='pending' ) { %>
            <div class="glass-card bg-white/5 border-l-2 border-white/20 p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-gray-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                            fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                                clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-gray-300 font-medium">
                            Akun Anda sedang menunggu persetujuan dari Admin/Ketua RT. Beberapa fitur mungkin dibatasi.
                        </p>
                    </div>
                </div>
            </div>
            <% } %>

                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-8 auto-rows-min">

                    <!-- 1. Finance Summary -->
                    <div class="md:col-span-2 lg:col-span-2 glass-card p-6 flex flex-col justify-between h-full group">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-gray-400 text-xs font-semibold uppercase tracking-wider">Saldo Kas RT
                                </h3>
                                <div class="text-4xl font-bold text-gray-100 mt-2">
                                    Rp <%= new Intl.NumberFormat('id-ID', { minimumFractionDigits: 0,
                                        maximumFractionDigits: 0 }).format(saldo) %>
                                </div>
                            </div>
                            <div
                                class="bg-white/5 p-3 rounded-lg backdrop-blur-sm border border-white/10 group-hover:bg-white/10 transition-all">
                                <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                    </path>
                                </svg>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div
                                class="bg-white/5 p-4 rounded-lg border border-white/10 hover:bg-white/8 transition-colors">
                                <div class="text-xs text-gray-400 font-medium mb-1">Pemasukan Bulan Ini</div>
                                <div class="text-lg font-bold text-gray-200">
                                    Rp <%= summary.pemasukan ? new Intl.NumberFormat('id-ID', { minimumFractionDigits:
                                        0, maximumFractionDigits: 0 }).format(summary.pemasukan) : 0 %>
                                </div>
                            </div>
                            <div
                                class="bg-white/5 p-4 rounded-lg border border-white/10 hover:bg-white/8 transition-colors">
                                <div class="text-xs text-gray-400 font-medium mb-1">Pengeluaran Bulan Ini</div>
                                <div class="text-lg font-bold text-gray-200">
                                    Rp <%= summary.pengeluaran ? new Intl.NumberFormat('id-ID', { minimumFractionDigits:
                                        0, maximumFractionDigits: 0 }).format(summary.pengeluaran) : 0 %>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Ronda Schedule -->
                    <div class="md:col-span-1 lg:col-span-1 glass-card p-6 flex flex-col h-full">
                        <h3 class="font-bold text-lg mb-4 flex items-center text-gray-100">
                            <svg class="w-5 h-5 mr-2 text-gray-400" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z">
                                </path>
                            </svg>
                            Jadwal Ronda
                        </h3>

                        <% const schedule=jadwalRonda.length> 0 ? jadwalRonda[0] : null; %>

                            <div class="flex-grow">
                                <div
                                    class="text-gray-300 text-sm mb-4 uppercase tracking-wider font-medium flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full bg-gray-400 animate-pulse"></span>
                                    <%= schedule ? schedule.day : 'Tidak ada jadwal' %>
                                </div>

                                <% if(schedule && schedule.petugas.length> 0) { %>
                                    <div class="relative">
                                        <div id="ronda-carousel" class="overflow-hidden">
                                            <div id="ronda-carousel-track"
                                                class="flex transition-transform duration-500 ease-in-out">
                                                <% schedule.petugas.forEach((p, index)=> { %>
                                                    <div class="w-full flex-shrink-0 px-2">
                                                        <div
                                                            class="flex flex-col items-center bg-white/5 backdrop-blur-md border border-white/10 p-5 rounded-xl">
                                                            <div
                                                                class="w-20 h-20 rounded-full bg-white/10 border-2 border-white/20 flex items-center justify-center text-3xl font-bold mb-4 text-gray-200 overflow-hidden">
                                                                <% if(p.foto_profil) { %>
                                                                    <img src="/uploads/profiles/<%= p.foto_profil %>"
                                                                        alt="<%= p.nama %>"
                                                                        class="w-full h-full object-cover grayscale">
                                                                    <% } else { %>
                                                                        <%= p.nama.charAt(0) %>
                                                                            <% } %>
                                                            </div>
                                                            <div class="text-center w-full">
                                                                <div
                                                                    class="text-lg font-bold text-gray-100 truncate px-2">
                                                                    <%= p.nama %>
                                                                </div>
                                                                <div
                                                                    class="text-sm text-gray-400 mt-1 bg-white/5 py-1 px-3 rounded-full inline-block backdrop-blur-sm border border-white/10">
                                                                    Blok <%= p.blok %>-<%= p.nomor_rumah %>
                                                                </div>
                                                                <% if(p.tim_ronda) { %>
                                                                    <div
                                                                        class="mt-3 inline-block px-4 py-1.5 bg-white/10 backdrop-blur-sm rounded-full text-xs font-medium border border-white/10">
                                                                        Tim <%= p.tim_ronda %>
                                                                    </div>
                                                                    <% } %>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <% }) %>
                                            </div>
                                        </div>

                                        <% if(schedule.petugas.length> 1) { %>
                                            <button onclick="prevRondaSlide()"
                                                class="absolute left-0 top-1/2 -translate-y-1/2 -ml-2 bg-white/10 hover:bg-white/20 text-gray-300 p-2 rounded-full transition backdrop-blur-sm border border-white/10">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                                </svg>
                                            </button>
                                            <button onclick="nextRondaSlide()"
                                                class="absolute right-0 top-1/2 -translate-y-1/2 -mr-2 bg-white/10 hover:bg-white/20 text-gray-300 p-2 rounded-full transition backdrop-blur-sm border border-white/10">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2" d="M9 5l7 7-7 7"></path>
                                                </svg>
                                            </button>
                                            <div class="flex justify-center mt-4 space-x-2">
                                                <% schedule.petugas.forEach((p, index)=> { %>
                                                    <button onclick="goToRondaSlide(<%= index %>)"
                                                        class="ronda-indicator w-2 h-2 rounded-full bg-gray-400 transition-all <%= index === 0 ? 'bg-opacity-100 w-4' : 'bg-opacity-40 hover:bg-opacity-60' %>"></button>
                                                    <% }) %>
                                            </div>
                                            <% } %>
                                    </div>

                                    <a href="/ronda"
                                        class="mt-5 w-full glass-button text-gray-200 text-center py-3 rounded-lg text-sm font-medium hover:bg-white/12 transition block border border-white/10">Lihat
                                        Jadwal Lengkap</a>
                                    <% } else { %>
                                        <div
                                            class="text-center py-12 text-gray-400 bg-white/5 rounded-xl border border-white/10 backdrop-blur-sm">
                                            <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none"
                                                stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <p class="text-sm font-medium">Tidak ada jadwal ronda<br>dalam waktu dekat.
                                            </p>
                                        </div>
                                        <div class="mt-4 pt-4 border-t border-white/10">
                                            <a href="/ronda"
                                                class="text-sm text-gray-400 hover:text-gray-200 flex items-center justify-center font-medium transition-colors">Lihat
                                                Jadwal Lengkap &rarr;</a>
                                        </div>
                                        <% } %>
                            </div>
                    </div>

                    <!-- 3. Announcements -->
                    <div class="md:col-span-1 lg:col-span-1 glass-card p-6 flex flex-col h-full">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-100 text-lg flex items-center">
                                <span class="bg-white/5 p-1.5 rounded-lg mr-2 text-gray-400 border border-white/10">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z">
                                        </path>
                                    </svg>
                                </span>
                                Pengumuman
                            </h3>
                            <button onclick="openEventModal()"
                                class="glass-button bg-white/5 hover:bg-white/10 text-gray-300 p-2 rounded-lg transition border border-white/10"
                                title="Tambah Pengumuman">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="space-y-3 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                            <% if (events && events.length> 0) { %>
                                <% events.forEach(event=> { %>
                                    <div onclick="openEventDetail(<%= JSON.stringify(event) %>)"
                                        class="glass-card bg-white/5 p-4 hover:bg-white/10 transition-all cursor-pointer group border border-white/10">
                                        <div
                                            class="text-xs text-gray-400 font-medium mb-1.5 uppercase tracking-wide group-hover:text-gray-300 bg-white/5 inline-block px-2 py-0.5 rounded-md">
                                            <%= new Date(event.tanggal).toLocaleDateString('id-ID', { weekday: 'long' ,
                                                day: 'numeric' , month: 'short' , year: 'numeric' }) %>
                                        </div>
                                        <div
                                            class="text-sm font-semibold text-gray-200 group-hover:text-gray-100 mt-1 line-clamp-2">
                                            <%= event.judul %>
                                        </div>
                                        <% if(event.lokasi) { %>
                                            <div class="text-xs text-gray-400 mt-2 flex items-center">
                                                <svg class="w-3 h-3 mr-1 text-gray-500" fill="none"
                                                    stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z">
                                                    </path>
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                </svg>
                                                <%= event.lokasi %>
                                            </div>
                                            <% } %>
                                    </div>
                                    <% }); %>
                                        <% } else { %>
                                            <div
                                                class="text-center py-8 text-gray-500 bg-white/5 rounded-xl border border-dashed border-white/10">
                                                Belum ada pengumuman</div>
                                            <% } %>
                        </div>
                    </div>

                    <!-- 4. Map -->
                    <div class="md:col-span-2 lg:col-span-3 glass-card rounded-xl overflow-hidden h-full">
                        <div class="p-4 border-b border-white/10 flex justify-between items-center bg-white/5">
                            <h3 class="font-bold text-gray-100">Peta Lingkungan</h3>
                            <div class="flex flex-wrap gap-x-4 gap-y-1 text-[10px] sm:text-xs">
                                <div class="flex items-center"><span
                                        class="w-3 h-3 bg-blue-500/30 border border-blue-500/50 rounded mr-1"></span><span
                                        class="text-gray-400">Tetap</span></div>
                                <div class="flex items-center"><span
                                        class="w-3 h-3 bg-amber-500/30 border border-amber-500/50 rounded mr-1"></span><span
                                        class="text-gray-400">Kontrak</span></div>
                                <div class="flex items-center"><span
                                        class="w-3 h-3 bg-white/5 border border-white/20 rounded mr-1"></span><span
                                        class="text-gray-400">Kosong</span></div>
                                <div class="flex items-center ml-2 border-l border-white/20 pl-2"><span
                                        class="w-2 h-2 bg-emerald-500 rounded-full mr-1"></span><span
                                        class="text-gray-400">Lunas</span></div>
                                <div class="flex items-center"><span
                                        class="w-2 h-2 bg-red-500 rounded-full mr-1"></span><span
                                        class="text-gray-400">Belum Bayar</span></div>
                            </div>
                        </div>
                        <div class="p-6 overflow-x-auto">
                            <div class="flex flex-row md:flex-col items-center justify-center w-full gap-4 md:gap-0">
                                <!-- Blok F7 -->
                                <div class="flex-1 md:flex-none w-0 md:w-full md:mb-6 order-3 md:order-1">
                                    <div
                                        class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 text-center">
                                        Blok F7</div>
                                    <div
                                        class="flex flex-col md:flex-row gap-2 items-end md:items-center md:justify-center">
                                        <% for(let i=36; i>=19; i--) {
                                            const house = mapData.find(h => h.blok == 'F7' && parseInt(h.nomor_rumah) ==
                                            i);
                                            let bgClass = 'bg-white/5 glass-strong';
                                            let showBadge = false;
                                            let badgeColor = '';

                                            if (house) {
                                            const status = (house.status_huni || '').toLowerCase();
                                            if (status === 'kontrak') {
                                            bgClass = 'bg-amber-500/20 glass-strong border-amber-500/30';
                                            } else if (status === 'tetap' || status === 'isi') {
                                            bgClass = 'bg-blue-500/20 glass-strong border-blue-500/30';
                                            }

                                            if (status !== 'kosong' && status !== '') {
                                            showBadge = true;
                                            if (house.status_iuran === 'lunas') {
                                            badgeColor = 'bg-emerald-500';
                                            } else {
                                            badgeColor = 'bg-red-500';
                                            }
                                            }
                                            }
                                            %>
                                            <div onclick="openHouseDetail('F7', <%= i %>)"
                                                class="w-8 h-8 <%= bgClass %> border border-white/20 rounded-lg cursor-pointer hover:scale-110 hover:bg-white/25 transition-transform relative group flex items-center justify-center">
                                                <span class="text-[10px] font-bold text-gray-300">
                                                    <%= i %>
                                                </span>
                                                <% if(showBadge) { %>
                                                    <div
                                                        class="absolute -top-1 -right-1 w-3 h-3 <%= badgeColor %> rounded-full border border-white/30">
                                                    </div>
                                                    <% } %>
                                            </div>
                                            <% } %>
                                    </div>
                                </div>

                                <!-- Road -->
                                <div
                                    class="relative order-2 md:order-2 flex items-center justify-center w-12 h-auto min-h-[500px] md:min-h-0 md:h-12 md:w-full bg-white/5 glass rounded-xl border-2 border-dashed border-white/10 md:mb-6 overflow-hidden backdrop-blur-sm">
                                    <div class="absolute inset-0 flex md:hidden items-center justify-center opacity-20">
                                        <div class="h-full border-l-4 border-dashed border-gray-400"></div>
                                    </div>
                                    <div class="absolute inset-0 hidden md:flex items-center justify-center opacity-20">
                                        <div class="w-full border-t-4 border-dashed border-gray-400"></div>
                                    </div>
                                    <div class="relative z-10 p-2 md:px-4">
                                        <div
                                            class="md:hidden text-xs text-gray-400 font-bold tracking-widest uppercase transform -rotate-90 whitespace-nowrap">
                                            GANG AMBYAR</div>
                                        <div
                                            class="hidden md:block text-xs text-gray-400 font-bold tracking-[0.5em] uppercase text-center">
                                            GANG AMBYAR</div>
                                    </div>
                                </div>

                                <!-- Blok F8 -->
                                <div class="flex-1 md:flex-none w-0 md:w-full order-1 md:order-3">
                                    <div
                                        class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 text-center">
                                        Blok F8</div>
                                    <div
                                        class="flex flex-col md:flex-row gap-2 items-start md:items-center md:justify-center">
                                        <% for(let i=1; i<=19; i++) { const house=mapData.find(h=> h.blok == 'F8' &&
                                            parseInt(h.nomor_rumah) == i);
                                            let bgClass = 'bg-white/5 glass-strong';
                                            let showBadge = false;
                                            let badgeColor = '';

                                            if (house) {
                                            const status = (house.status_huni || '').toLowerCase();
                                            if (status === 'kontrak') {
                                            bgClass = 'bg-amber-500/20 glass-strong border-amber-500/30';
                                            } else if (status === 'tetap' || status === 'isi') {
                                            bgClass = 'bg-blue-500/20 glass-strong border-blue-500/30';
                                            }

                                            if (status !== 'kosong' && status !== '') {
                                            showBadge = true;
                                            if (house.status_iuran === 'lunas') {
                                            badgeColor = 'bg-emerald-500';
                                            } else {
                                            badgeColor = 'bg-red-500';
                                            }
                                            }
                                            }
                                            %>
                                            <div onclick="openHouseDetail('F8', <%= i %>)"
                                                class="w-8 h-8 <%= bgClass %> border border-white/20 rounded-lg cursor-pointer hover:scale-110 hover:bg-white/25 transition-transform relative group flex items-center justify-center">
                                                <span class="text-[10px] font-bold text-gray-300">
                                                    <%= i %>
                                                </span>
                                                <% if(showBadge) { %>
                                                    <div
                                                        class="absolute -top-1 -right-1 w-3 h-3 <%= badgeColor %> rounded-full border border-white/30">
                                                    </div>
                                                    <% } %>
                                            </div>
                                            <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 5. Chart -->
                    <div class="md:col-span-1 lg:col-span-1 glass-card p-6 rounded-xl h-full">
                        <h3 class="font-bold text-gray-100 mb-4">Grafik Keuangan</h3>
                        <div class="h-40"><canvas id="kasChart"></canvas></div>
                    </div>

                </div>

                <!-- House Modal -->
                <div id="houseModal"
                    class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50 backdrop-blur-sm">
                    <div class="glass-card max-w-sm w-full mx-4 overflow-hidden transform transition-all">
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-xl font-bold text-gray-100" id="modalTitle">Detail Rumah</h3>
                                <button id="closeModal" class="text-gray-400 hover:text-gray-200"><svg class="w-6 h-6"
                                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M6 18L18 6M6 6l12 12"></path>
                                    </svg></button>
                            </div>
                            <div id="modalContent" class="space-y-3 text-sm text-gray-300"></div>
                            <div id="modalStatus" class="mt-6"></div>
                        </div>
                        <div class="bg-white/5 px-6 py-4 border-t border-white/10">
                            <button id="okBtn"
                                class="w-full glass-button text-gray-200 py-2 rounded-lg font-medium hover:bg-white/12 transition border border-white/10">Tutup</button>
                        </div>
                    </div>
                </div>

                <!-- Event Detail Modal -->
                <div id="eventDetailModal" class="fixed z-20 inset-0 overflow-y-auto hidden"
                    aria-labelledby="modal-title" role="dialog" aria-modal="true">
                    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                        <div class="fixed inset-0 bg-black/60 transition-opacity backdrop-blur-sm" aria-hidden="true"
                            onclick="closeEventDetail()"></div>
                        <span class="hidden sm:inline-block sm:align-middle sm:h-screen"
                            aria-hidden="true">&#8203;</span>
                        <div
                            class="inline-block align-bottom glass-card text-left overflow-hidden transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                            <div class="p-6">
                                <div class="sm:flex sm:items-start">
                                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                                        <h3 class="text-lg leading-6 font-medium text-gray-100 mb-2"
                                            id="event-detail-title"></h3>
                                        <div class="text-sm text-gray-400 mb-4" id="event-detail-meta"></div>
                                        <div class="text-sm text-gray-300 whitespace-pre-wrap" id="event-detail-desc">
                                        </div>
                                        <% if(user && user.role==='admin' ) { %>
                                            <div class="mt-6 grid grid-cols-2 gap-3 border-t border-white/10 pt-4">
                                                <button id="btn-edit-event" onclick="enableEditEvent()"
                                                    class="w-full glass-button text-gray-200 px-4 py-2 rounded-lg text-sm font-medium border border-white/10">Edit</button>
                                                <form id="form-delete-event" method="POST" class="w-full"
                                                    onsubmit="return confirm('Yakin ingin menghapus event ini?');">
                                                    <button type="submit"
                                                        class="w-full bg-white/10 hover:bg-white/15 text-gray-200 px-4 py-2 rounded-lg text-sm font-medium border border-white/10">Hapus</button>
                                                </form>
                                            </div>
                                            <form id="form-edit-event" method="POST" class="hidden mt-4 space-y-4">
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-300">Judul</label>
                                                    <input type="text" name="title" id="edit-title" required
                                                        class="glass-input mt-1 block w-full rounded-lg px-3 py-2">
                                                </div>
                                                <div>
                                                    <label
                                                        class="block text-sm font-medium text-gray-300">Tanggal</label>
                                                    <input type="datetime-local" name="date" id="edit-date" required
                                                        class="glass-input mt-1 block w-full rounded-lg px-3 py-2">
                                                </div>
                                                <div>
                                                    <label
                                                        class="block text-sm font-medium text-gray-300">Lokasi</label>
                                                    <input type="text" name="location" id="edit-location"
                                                        class="glass-input mt-1 block w-full rounded-lg px-3 py-2">
                                                </div>
                                                <div>
                                                    <label
                                                        class="block text-sm font-medium text-gray-300">Deskripsi</label>
                                                    <textarea name="description" id="edit-description" rows="3"
                                                        class="glass-input mt-1 block w-full rounded-lg px-3 py-2 resize-none"></textarea>
                                                </div>
                                                <div class="flex justify-end space-x-2">
                                                    <button type="button" onclick="cancelEditEvent()"
                                                        class="bg-white/5 text-gray-300 px-4 py-2 rounded-lg text-sm border border-white/10">Batal</button>
                                                    <button type="submit"
                                                        class="glass-button text-gray-200 px-4 py-2 rounded-lg text-sm border border-white/10">Simpan
                                                        Perubahan</button>
                                                </div>
                                            </form>
                                            <% } %>
                                    </div>
                                </div>
                            </div>
                            <div
                                class="bg-white/5 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-white/10">
                                <button type="button" onclick="closeEventDetail()"
                                    class="w-full inline-flex justify-center rounded-lg border border-white/10 px-4 py-2 glass-button text-base font-medium text-gray-200 hover:bg-white/12 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">Tutup</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Event Create Modal -->
                <div id="eventModal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title"
                    role="dialog" aria-modal="true">
                    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                        <div class="fixed inset-0 bg-black/60 transition-opacity backdrop-blur-sm" aria-hidden="true"
                            onclick="closeEventModal()"></div>
                        <span class="hidden sm:inline-block sm:align-middle sm:h-screen"
                            aria-hidden="true">&#8203;</span>
                        <div
                            class="inline-block align-bottom glass-card text-left overflow-hidden transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                            <form action="/dashboard/add-event" method="POST">
                                <div class="p-6">
                                    <div class="sm:flex sm:items-start">
                                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                                            <h3 class="text-lg leading-6 font-medium text-gray-100" id="modal-title">
                                                Tambah Pengumuman / Event</h3>
                                            <div class="mt-2 space-y-4">
                                                <div>
                                                    <label for="title"
                                                        class="block text-sm font-medium text-gray-300">Judul</label>
                                                    <input type="text" name="title" id="title" required
                                                        class="glass-input mt-1 block w-full rounded-lg px-3 py-2">
                                                </div>
                                                <div>
                                                    <label for="date"
                                                        class="block text-sm font-medium text-gray-300">Tanggal</label>
                                                    <input type="datetime-local" name="date" id="date" required
                                                        class="glass-input mt-1 block w-full rounded-lg px-3 py-2">
                                                </div>
                                                <div>
                                                    <label for="location"
                                                        class="block text-sm font-medium text-gray-300">Lokasi
                                                        (Opsional)</label>
                                                    <input type="text" name="location" id="location"
                                                        class="glass-input mt-1 block w-full rounded-lg px-3 py-2">
                                                </div>
                                                <div>
                                                    <label for="description"
                                                        class="block text-sm font-medium text-gray-300">Deskripsi
                                                        (Opsional)</label>
                                                    <textarea name="description" id="description" rows="3"
                                                        class="glass-input mt-1 block w-full rounded-lg px-3 py-2 resize-none"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div
                                    class="bg-white/5 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-white/10">
                                    <button type="submit"
                                        class="w-full inline-flex justify-center rounded-lg border border-white/10 px-4 py-2 glass-button text-base font-medium text-gray-200 hover:bg-white/12 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">Simpan</button>
                                    <button type="button" onclick="closeEventModal()"
                                        class="mt-3 w-full inline-flex justify-center rounded-lg border border-white/10 px-4 py-2 bg-white/5 text-base font-medium text-gray-300 hover:bg-white/10 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Batal</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <script>
                    function openEventModal() { document.getElementById('eventModal').classList.remove('hidden'); }
                    function closeEventModal() { document.getElementById('eventModal').classList.add('hidden'); }

                    function openEventDetail(event) {
                        const modal = document.getElementById('eventDetailModal');
                        if (!modal) return;
                        document.getElementById('event-detail-title').innerText = event.judul;
                        const date = new Date(event.tanggal);
                        const dateStr = date.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                        const timeStr = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

                        let meta = `<div class="flex items-center mb-1"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>${dateStr} pukul ${timeStr}</div>`;
                        if (event.lokasi) meta += `<div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>${event.lokasi}</div>`;

                        document.getElementById('event-detail-meta').innerHTML = meta;
                        document.getElementById('event-detail-desc').innerText = event.keterangan || 'Tidak ada deskripsi';

                        const editForm = document.getElementById('form-edit-event');
                        if (editForm) {
                            editForm.action = `/dashboard/edit-event/${event.id}`;
                            document.getElementById('edit-title').value = event.judul;
                            const tzOffset = date.getTimezoneOffset() * 60000;
                            const localISOTime = (new Date(date - tzOffset)).toISOString().slice(0, 16);
                            document.getElementById('edit-date').value = localISOTime.substring(0, 16);
                            document.getElementById('edit-location').value = event.lokasi || '';
                            document.getElementById('edit-description').value = event.keterangan || '';
                            editForm.classList.add('hidden');
                            if (document.getElementById('btn-edit-event')) document.getElementById('btn-edit-event').classList.remove('hidden');
                            if (document.getElementById('form-delete-event')) document.getElementById('form-delete-event').classList.remove('hidden');
                        }

                        const deleteForm = document.getElementById('form-delete-event');
                        if (deleteForm) deleteForm.action = `/dashboard/delete-event/${event.id}`;

                        modal.classList.remove('hidden');
                    }

                    function closeEventDetail() { document.getElementById('eventDetailModal').classList.add('hidden'); }
                    function enableEditEvent() {
                        document.getElementById('form-edit-event').classList.remove('hidden');
                        document.getElementById('btn-edit-event').classList.add('hidden');
                        document.getElementById('form-delete-event').classList.add('hidden');
                    }
                    function cancelEditEvent() {
                        document.getElementById('form-edit-event').classList.add('hidden');
                        document.getElementById('btn-edit-event').classList.remove('hidden');
                        document.getElementById('form-delete-event').classList.remove('hidden');
                    }
                </script>

                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

                <div id="debugData" class="hidden"
                    data-mapdata="<%= Buffer.from(JSON.stringify(mapData || [])).toString('base64') %>"
                    data-chartdata="<%= Buffer.from(JSON.stringify(chartData || {})).toString('base64') %>">
                </div>

                <script>
                    const mapDataElement = document.getElementById('debugData');
                    const mapDataRaw = mapDataElement ? mapDataElement.getAttribute('data-mapdata') : null;
                    const mapData = mapDataRaw ? JSON.parse(atob(mapDataRaw)) : [];

                    window.openHouseDetail = function (blok, nomor) {
                        try {
                            const house = mapData.find(h =>
                                String(h.blok).trim().toUpperCase() === String(blok).trim().toUpperCase() &&
                                String(h.nomor_rumah).trim() === String(nomor).trim()
                            );
                            const modal = document.getElementById('houseModal');
                            const title = document.getElementById('modalTitle');
                            const content = document.getElementById('modalContent');
                            const statusDiv = document.getElementById('modalStatus');

                            if (!modal) return;

                            if (!house || !house.status_huni || house.status_huni.toLowerCase() === 'kosong') {
                                title.innerText = `Blok ${blok} No. ${nomor}`;
                                content.innerHTML = `<p class='text-center text-gray-500 italic'>Rumah Kosong / Belum ada data.</p>`;
                                statusDiv.innerHTML = `<div class="w-full text-center py-2 rounded-lg font-bold text-sm bg-white/5 text-gray-400 border border-white/10">Status: Kosong</div>`;
                            } else {
                                title.innerText = `Blok ${house.blok} No. ${house.nomor_rumah}`;
                                let residentsHtml = '<ul class="space-y-2 mt-2">';
                                if (house.residents && house.residents.length > 0) {
                                    house.residents.forEach(r => {
                                        residentsHtml += `
                    <li class="flex justify-between items-center border-b border-white/10 pb-1">
                        <div class="flex flex-col">
                            <span class="font-medium text-gray-200">${r.nama}</span>
                            ${r.no_hp ? `<span class="text-[10px] text-gray-500">ðŸ“ž ${r.no_hp}</span>` : ''}
                        </div>
                        <span class="text-xs text-gray-400 bg-white/5 px-2 py-0.5 rounded border border-white/10">${r.status_keluarga}</span>
                    </li>`;
                                    });
                                } else {
                                    residentsHtml += '<li class="text-gray-500 italic text-xs">Data anggota keluarga belum lengkap</li>';
                                }
                                residentsHtml += '</ul>';

                                content.innerHTML = `
            <div class="mb-4">
                <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Status Huni</div>
                <div class="font-medium text-gray-200">${house.status_huni}</div>
            </div>
            <div>
                <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Anggota Keluarga</div>
                ${residentsHtml}
            </div>`;

                                // Status badge with colors
                                let statusClass, statusText;
                                if (house.status_iuran === 'lunas') {
                                    statusClass = 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30';
                                    statusText = 'âœ“ Iuran Lunas';
                                } else {
                                    statusClass = 'bg-red-500/20 text-red-400 border-red-500/30';
                                    statusText = 'âœ— Belum Bayar Iuran';
                                }

                                let iuranDetailsHtml = '';
                                if (house.status_iuran !== 'lunas' && house.unpaid_details && house.unpaid_details.length > 0) {
                                    iuranDetailsHtml = '<div class="mt-3 border-t border-white/10 pt-2"><p class="text-xs font-bold text-gray-500 uppercase mb-2">Rincian Belum Bayar:</p><ul class="space-y-1 text-xs max-h-32 overflow-y-auto pr-1 custom-scrollbar">';
                                    const formatter = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 });

                                    house.unpaid_details.forEach(d => {
                                        const date = new Date(d.periode);
                                        const month = date.toLocaleString('id-ID', { month: 'long', year: 'numeric' });
                                        const amount = formatter.format(d.jumlah);
                                        iuranDetailsHtml += `<li class="flex justify-between text-gray-400 bg-white/5 p-1.5 rounded border border-white/10"><span class="font-medium">${month} (${d.jenis})</span><span>${amount}</span></li>`;
                                    });
                                    iuranDetailsHtml += '</ul></div>';
                                }

                                statusDiv.innerHTML = `<div class="w-full text-center py-2 rounded-lg font-bold text-sm ${statusClass} mb-2 border">${statusText}</div>${iuranDetailsHtml}`;
                            }
                            modal.classList.remove('hidden');
                        } catch (error) {
                            console.error('Error in openHouseDetail:', error);
                        }
                    };

                    // Chart Logic - Monochrome
                    try {
                        const chartDataElement = document.getElementById('debugData');
                        const chartDataRaw = chartDataElement ? chartDataElement.getAttribute('data-chartdata') : null;
                        const chartData = chartDataRaw ? JSON.parse(atob(chartDataRaw)) : {};
                        if (chartData && chartData.pemasukan && chartData.pengeluaran) {
                            const ctx = document.getElementById('kasChart').getContext('2d');
                            new Chart(ctx, {
                                type: 'doughnut',
                                data: {
                                    labels: ['Masuk', 'Keluar'],
                                    datasets: [{
                                        data: [
                                            chartData.pemasukan.reduce((a, b) => a + b, 0),
                                            chartData.pengeluaran.reduce((a, b) => a + b, 0)
                                        ],
                                        backgroundColor: ['rgba(255, 255, 255, 0.3)', 'rgba(255, 255, 255, 0.1)'],
                                        borderColor: ['rgba(255, 255, 255, 0.5)', 'rgba(255, 255, 255, 0.3)'],
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: {
                                            position: 'bottom',
                                            labels: {
                                                boxWidth: 12,
                                                font: { size: 10 },
                                                color: '#d1d5db'
                                            }
                                        }
                                    },
                                    cutout: '70%'
                                }
                            });
                        }
                    } catch (e) { console.error("Chart error:", e); }

                    const closeModal = () => document.getElementById('houseModal').classList.add('hidden');
                    document.getElementById('okBtn').addEventListener('click', closeModal);
                    document.getElementById('closeModal').addEventListener('click', closeModal);

                    // Ronda Carousel Control
                    let currentRondaSlide = 0;
                    const rondaTrack = document.getElementById('ronda-carousel-track');
                    const rondaIndicators = document.querySelectorAll('.ronda-indicator');
                    const totalRondaSlides = rondaIndicators.length;

                    function updateRondaCarousel() {
                        if (!rondaTrack) return;
                        rondaTrack.style.transform = `translateX(-${currentRondaSlide * 100}%)`;
                        rondaIndicators.forEach((indicator, index) => {
                            if (index === currentRondaSlide) {
                                indicator.classList.remove('bg-opacity-30');
                                indicator.classList.add('bg-opacity-100');
                            } else {
                                indicator.classList.remove('bg-opacity-100');
                                indicator.classList.add('bg-opacity-30');
                            }
                        });
                    }

                    function nextRondaSlide() {
                        currentRondaSlide = (currentRondaSlide + 1) % totalRondaSlides;
                        updateRondaCarousel();
                    }

                    function prevRondaSlide() {
                        currentRondaSlide = (currentRondaSlide - 1 + totalRondaSlides) % totalRondaSlides;
                        updateRondaCarousel();
                    }

                    function goToRondaSlide(index) {
                        currentRondaSlide = index;
                        updateRondaCarousel();
                    }

                    if (totalRondaSlides > 1) {
                        setInterval(nextRondaSlide, 5000);
                    }
                </script>

                <%- include('../partials/footer') %>