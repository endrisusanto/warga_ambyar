<%- include('../partials/head') %>
    <%- include('../partials/navbar') %>

        <!-- Bento Grid Layout -->
        <% if(user && user.approval_status==='pending' ) { %>
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                            fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                                clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700">
                            Akun Anda sedang menunggu persetujuan dari Admin/Ketua RT. Beberapa fitur mungkin dibatasi.
                        </p>
                    </div>
                </div>
            </div>
            <% } %>

                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-8 auto-rows-min">

                    <!-- 1. Finance Summary (Large Card) -->
                    <div
                        class="md:col-span-2 lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between h-full">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-gray-500 text-sm font-medium uppercase tracking-wider">Saldo Kas RT</h3>
                                <div class="text-4xl font-extrabold text-gray-900 mt-1">Rp <%=
                                        saldo.toLocaleString('id-ID') %>
                                </div>
                            </div>
                            <div class="bg-green-100 p-2 rounded-lg">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                    </path>
                                </svg>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div class="bg-green-50 p-3 rounded-xl">
                                <div class="text-xs text-green-600 font-semibold mb-1">Pemasukan Bulan Ini</div>
                                <div class="text-lg font-bold text-green-700">Rp <%= summary.pemasukan ?
                                        summary.pemasukan.toLocaleString('id-ID') : 0 %>
                                </div>
                            </div>
                            <div class="bg-red-50 p-3 rounded-xl">
                                <div class="text-xs text-red-600 font-semibold mb-1">Pengeluaran Bulan Ini</div>
                                <div class="text-lg font-bold text-red-700">Rp <%= summary.pengeluaran ?
                                        summary.pengeluaran.toLocaleString('id-ID') : 0 %>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Ronda Schedule (Tall Card) -->
                    <div
                        class="md:col-span-1 lg:col-span-1 row-span-2 bg-indigo-600 text-white p-6 rounded-2xl shadow-sm flex flex-col h-full">
                        <h3 class="font-bold text-lg mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z">
                                </path>
                            </svg>
                            Jadwal Ronda
                        </h3>

                        <% const schedule=jadwalRonda.length> 0 ? jadwalRonda[0] : null;
                            %>

                            <div class="flex-grow">
                                <div class="text-indigo-200 text-sm mb-4 uppercase tracking-widest font-semibold">
                                    <%= schedule ? schedule.day : 'Tidak ada jadwal' %>
                                </div>

                                <% if(schedule && schedule.petugas.length> 0) { %>
                                    <div class="space-y-3">
                                        <% schedule.petugas.forEach(p=> { %>
                                            <div class="flex items-center bg-indigo-700 bg-opacity-50 p-2 rounded-lg">
                                                <div
                                                    class="w-8 h-8 rounded-full bg-indigo-400 flex items-center justify-center text-xs font-bold mr-3">
                                                    <%= p.nama.charAt(0) %>
                                                </div>
                                                <div>
                                                    <div class="text-sm font-medium">
                                                        <%= p.nama %>
                                                    </div>
                                                    <div class="text-xs text-indigo-300">Blok <%= p.blok %>-<%=
                                                                p.nomor_rumah %>
                                                    </div>
                                                </div>
                                            </div>
                                            <% }) %>
                                    </div>

                                    <a href="/ronda"
                                        class="mt-4 w-full bg-white text-indigo-600 text-center py-2 rounded-lg text-sm font-bold hover:bg-indigo-50 transition">
                                        Lihat Jadwal Lengkap
                                    </a>
                                    <% } else { %>
                                        <div class="text-center py-8 text-indigo-300">
                                            <p>Tidak ada jadwal ronda dalam waktu dekat.</p>
                                        </div>
                                        <div class="mt-4 pt-4 border-t border-indigo-500">
                                            <a href="/ronda"
                                                class="text-xs text-indigo-200 hover:text-white flex items-center justify-center">
                                                Lihat Jadwal Lengkap &rarr;
                                            </a>
                                        </div>
                                        <% } %>
                            </div>
                    </div>

                    <!-- 3. Announcements (Standard Card) -->
                    <div
                        class="md:col-span-1 lg:col-span-1 bg-yellow-50 p-6 rounded-2xl shadow-sm border border-yellow-100 h-full">
                        <h3 class="font-bold text-yellow-800 mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z">
                                </path>
                            </svg>
                            Pengumuman
                        </h3>
                        <div class="space-y-4">
                            <div class="bg-white p-3 rounded-xl shadow-sm border border-yellow-100">
                                <div class="text-xs text-yellow-600 font-bold mb-1">Minggu, 12 Jan 2026
                                </div>
                                <div class="text-sm font-medium text-gray-800">Kerja Bakti Lingkungan
                                </div>
                            </div>
                            <div class="bg-white p-3 rounded-xl shadow-sm border border-yellow-100">
                                <div class="text-xs text-yellow-600 font-bold mb-1">Selasa, 14 Jan 2026
                                </div>
                                <div class="text-sm font-medium text-gray-800">Posyandu Balita</div>
                            </div>
                        </div>
                    </div>

                    <!-- 4. Map (Wide Card) -->
                    <div
                        class="md:col-span-2 lg:col-span-3 bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden h-full">
                        <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                            <h3 class="font-bold text-gray-700">Peta Lingkungan</h3>
                            <div class="flex flex-wrap gap-x-4 gap-y-1 text-[10px] sm:text-xs">
                                <div class="flex items-center"><span
                                        class="w-3 h-3 bg-green-200 border border-gray-300 rounded mr-1"></span> Tetap
                                </div>
                                <div class="flex items-center"><span
                                        class="w-3 h-3 bg-blue-200 border border-gray-300 rounded mr-1"></span> Kontrak
                                </div>
                                <div class="flex items-center"><span
                                        class="w-3 h-3 bg-gray-200 border border-gray-300 rounded mr-1"></span> Kosong
                                </div>
                                <div class="flex items-center ml-2 border-l pl-2"><span
                                        class="w-2 h-2 bg-green-500 rounded-full mr-1"></span> Lunas</div>
                                <div class="flex items-center"><span
                                        class="w-2 h-2 bg-red-500 rounded-full mr-1"></span> Nunggak</div>
                            </div>
                        </div>
                        <div class="p-6 overflow-x-auto">
                            <div class="flex flex-col items-center" style="min-width: 600px;">
                                <!-- Blok F7 -->
                                <div class="w-full mb-6">
                                    <div
                                        class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 text-center">
                                        Blok
                                        F7</div>
                                    <div class="flex gap-2 justify-center">
                                        <% for(let i=20; i>=1; i--) {
                                            const house = mapData.find(h =>
                                            h.blok == 'F7' &&
                                            parseInt(h.nomor_rumah) == i
                                            );
                                            let bgClass = 'bg-gray-200';
                                            let showBadge = false;
                                            let badgeColor = '';

                                            if (house) {
                                            const status = (house.status_huni || '').toLowerCase();
                                            if (status === 'kontrak') bgClass = 'bg-blue-200';
                                            else if (status === 'tetap' || status === 'isi') bgClass = 'bg-green-200';

                                            if (status !== 'kosong' && status !== '') {
                                            showBadge = true;
                                            badgeColor = (house.status_iuran === 'lunas') ? 'bg-green-500' :
                                            'bg-red-500';
                                            }
                                            }
                                            %>
                                            <div onclick="openHouseDetail('F7', <%= i %>)"
                                                class="w-8 h-8 <%= bgClass %> border border-gray-300 rounded-lg cursor-pointer hover:scale-110 transition-transform relative group flex items-center justify-center shadow-sm">
                                                <span class="text-[10px] font-bold text-gray-700">
                                                    <%= i %>
                                                </span>
                                                <% if(showBadge) { %>
                                                    <div
                                                        class="absolute -top-1 -right-1 w-3 h-3 <%= badgeColor %> rounded-full border border-white shadow-sm">
                                                    </div>
                                                    <% } %>
                                            </div>
                                            <% } %>
                                    </div>
                                </div>

                                <!-- Road -->
                                <div
                                    class="w-full h-12 bg-gray-100 mb-6 rounded-xl flex items-center justify-center border-2 border-dashed border-gray-300 relative overflow-hidden">
                                    <div class="absolute inset-0 flex items-center justify-center opacity-10">
                                        <div class="w-full border-t-4 border-dashed border-gray-900">
                                        </div>
                                    </div>
                                    <div class="text-xs text-gray-500 font-bold tracking-[0.5em] z-10 bg-gray-100 px-4">
                                        JALAN
                                        GANG AMBYAR</div>
                                </div>

                                <!-- Blok F8 -->
                                <div class="w-full">
                                    <div
                                        class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 text-center">
                                        Blok
                                        F8</div>
                                    <div class="flex gap-2 justify-center">
                                        <% for(let i=1; i<=20; i++) { const house=mapData.find(h=>
                                            h.blok == 'F8' &&
                                            parseInt(h.nomor_rumah) == i
                                            );
                                            let bgClass = 'bg-gray-200';
                                            let showBadge = false;
                                            let badgeColor = '';

                                            if (house) {
                                            const status = (house.status_huni || '').toLowerCase();
                                            if (status === 'kontrak') bgClass = 'bg-blue-200';
                                            else if (status === 'tetap' || status === 'isi') bgClass = 'bg-green-200';

                                            if (status !== 'kosong' && status !== '') {
                                            showBadge = true;
                                            badgeColor = (house.status_iuran === 'lunas') ? 'bg-green-500' :
                                            'bg-red-500';
                                            }
                                            }
                                            %>
                                            <div onclick="openHouseDetail('F8', <%= i %>)"
                                                class="w-8 h-8 <%= bgClass %> border border-gray-300 rounded-lg cursor-pointer hover:scale-110 transition-transform relative group flex items-center justify-center shadow-sm">
                                                <span class="text-[10px] font-bold text-gray-700">
                                                    <%= i %>
                                                </span>
                                                <% if(showBadge) { %>
                                                    <div
                                                        class="absolute -top-1 -right-1 w-3 h-3 <%= badgeColor %> rounded-full border border-white shadow-sm">
                                                    </div>
                                                    <% } %>
                                            </div>
                                            <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 5. Chart (Standard Card) -->
                    <div
                        class="md:col-span-1 lg:col-span-1 bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-full">
                        <h3 class="font-bold text-gray-700 mb-4">Grafik Keuangan</h3>
                        <div class="h-40">
                            <canvas id="kasChart"></canvas>
                        </div>
                    </div>

                </div>

                <!-- House Modal -->
                <div id="houseModal"
                    class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50 backdrop-blur-sm">
                    <div
                        class="bg-white rounded-2xl shadow-xl max-w-sm w-full mx-4 overflow-hidden transform transition-all">
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-xl font-bold text-gray-900" id="modalTitle">Detail Rumah
                                </h3>
                                <button id="closeModal" class="text-gray-400 hover:text-gray-500">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div id="modalContent" class="space-y-3 text-sm text-gray-600">
                                <!-- Content populated by JS -->
                            </div>
                            <div id="modalStatus" class="mt-6"></div>
                        </div>
                        <div class="bg-gray-50 px-6 py-4">
                            <button id="okBtn"
                                class="w-full bg-indigo-600 text-white py-2 rounded-xl font-medium hover:bg-indigo-700 transition">
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Event Modal -->
                <div id="eventModal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title"
                    role="dialog" aria-modal="true">
                    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"
                            onclick="closeEventModal()"></div>
                        <span class="hidden sm:inline-block sm:align-middle sm:h-screen"
                            aria-hidden="true">&#8203;</span>
                        <div
                            class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                            <form action="/dashboard/add-event" method="POST">
                                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                    <div class="sm:flex sm:items-start">
                                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                                Tambah Pengumuman / Event</h3>
                                            <div class="mt-2 space-y-4">
                                                <div>
                                                    <label for="title"
                                                        class="block text-sm font-medium text-gray-700">Judul</label>
                                                    <input type="text" name="title" id="title" required
                                                        class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                                </div>
                                                <div>
                                                    <label for="date"
                                                        class="block text-sm font-medium text-gray-700">Tanggal</label>
                                                    <input type="datetime-local" name="date" id="date" required
                                                        class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                                </div>
                                                <div>
                                                    <label for="location"
                                                        class="block text-sm font-medium text-gray-700">Lokasi
                                                        (Opsional)</label>
                                                    <input type="text" name="location" id="location"
                                                        class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                                </div>
                                                <div>
                                                    <label for="description"
                                                        class="block text-sm font-medium text-gray-700">Deskripsi
                                                        (Opsional)</label>
                                                    <textarea name="description" id="description" rows="3"
                                                        class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                    <button type="submit"
                                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">Simpan</button>
                                    <button type="button" onclick="closeEventModal()"
                                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Batal</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <script>
                    function openEventModal() {
                        document.getElementById('eventModal').classList.remove('hidden');
                    }
                    function closeEventModal() {
                        document.getElementById('eventModal').classList.add('hidden');
                    }
                </script>

                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                <script>
                    // Pass data from backend
                    const mapData = <% - JSON.stringify(mapData || []) %>;

                    // Chart Logic
                    const ctx = document.getElementById('kasChart').getContext('2d');
                    const chartData = <% - JSON.stringify(chartData || {}) %>;
                    new Chart(ctx, {
                        type: 'doughnut', // Changed to doughnut for bento style fit
                        data: {
                            labels: ['Masuk', 'Keluar'],
                            datasets: [{
                                data: [
                                    chartData.pemasukan.reduce((a, b) => a + b, 0),
                                    chartData.pengeluaran.reduce((a, b) => a + b, 0)
                                ],
                                backgroundColor: ['#22c55e', '#ef4444'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } }
                            },
                            cutout: '70%'
                        }
                    });

                    // Modal Logic
                    function openHouseDetail(blok, nomor) {
                        try {
                            console.log('Opening modal for:', blok, nomor);
                            console.log('MapData available:', mapData);

                            const house = mapData.find(h => h.blok === blok && h.nomor_rumah == nomor);
                            console.log('Found house:', house);

                            const modal = document.getElementById('houseModal');
                            const title = document.getElementById('modalTitle');
                            const content = document.getElementById('modalContent');
                            const statusDiv = document.getElementById('modalStatus');

                            if (!modal) {
                                console.error('Modal element not found!');
                                return;
                            }

                            if (!house || !house.status_huni || house.status_huni.toLowerCase() === 'kosong') {
                                title.innerText = `Blok ${blok} No. ${nomor}`;
                                content.innerHTML = "<p class='text-center text-gray-400 italic'>Rumah Kosong / Belum ada data.</p>";
                                statusDiv.innerHTML = `
                            <div class="w-full text-center py-2 rounded-lg font-bold text-sm bg-gray-100 text-gray-500">
                                Status: Kosong
                            </div>
                        `;
                            } else {
                                title.innerText = `Blok ${house.blok} No. ${house.nomor_rumah}`;

                                let residentsHtml = '<ul class="space-y-2 mt-2">';
                                if (house.residents && house.residents.length > 0) {
                                    house.residents.forEach(r => {
                                        residentsHtml += `
                                    <li class="flex justify-between items-center border-b border-gray-100 pb-1">
                                        <span>${r.nama}</span>
                                        <span class="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded">${r.status_keluarga}</span>
                                    </li>
                                `;
                                    });
                                } else {
                                    residentsHtml += '<li class="text-gray-400 italic text-xs">Data anggota keluarga belum lengkap</li>';
                                }
                                residentsHtml += '</ul>';

                                content.innerHTML = `
                            <div class="mb-4">
                                <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Status Huni</div>
                                <div class="font-medium text-gray-900">${house.status_huni}</div>
                            </div>
                            <div>
                                <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Anggota Keluarga</div>
                                ${residentsHtml}
                            </div>
                        `;

                                const statusClass = house.status_iuran === 'lunas' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                                const statusText = house.status_iuran === 'lunas' ? 'Iuran Lunas' : 'Menunggak Iuran';

                                statusDiv.innerHTML = `
                            <div class="w-full text-center py-2 rounded-lg font-bold text-sm ${statusClass}">
                                ${statusText}
                            </div>
                        `;
                            }

                            console.log('Showing modal...');
                            modal.classList.remove('hidden');
                        } catch (error) {
                            console.error('Error in openHouseDetail:', error);
                            alert('Error: ' + error.message);
                        }
                    }

                    const closeModal = () => document.getElementById('houseModal').classList.add('hidden');
                    document.getElementById('okBtn').addEventListener('click', closeModal);
                    document.getElementById('closeModal').addEventListener('click', closeModal);
                </script>
                </div>
                <!-- Debug Data (Hidden) -->
                <div id="debugData" class="hidden" data-mapdata='<%- JSON.stringify(mapData) %>'></div>

                <%- include('../partials/footer') %>