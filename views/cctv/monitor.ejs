<%- include('../partials/head') %>
    <%- include('../partials/navbar') %>

        <style>
            .cctv-card {
                position: relative;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 12px;
                overflow: hidden;
                transition: all 0.3s ease;
                aspect-ratio: 16/9;
            }

            .cctv-card:hover {
                border-color: rgba(99, 102, 241, 0.5);
                box-shadow: 0 8px 32px rgba(99, 102, 241, 0.2);
                transform: translateY(-2px);
            }

            .cctv-video-wrapper {
                position: relative;
                width: 100%;
                height: 100%;
            }

            .cctv-video {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .cctv-loading {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                text-align: center;
                z-index: 10;
            }

            .loading-spinner {
                border: 3px solid rgba(99, 102, 241, 0.1);
                border-top: 3px solid rgb(99, 102, 241);
                border-radius: 50%;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
                margin: 0 auto;
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }

                100% {
                    transform: rotate(360deg);
                }
            }

            .cctv-overlay {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(to bottom, rgba(0, 0, 0, 0.6) 0%, transparent 30%, transparent 70%, rgba(0, 0, 0, 0.7) 100%);
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                padding: 1rem;
                opacity: 1;
                transition: opacity 0.3s ease;
            }

            .live-badge {
                align-self: flex-start;
                background: rgba(239, 68, 68, 0.9);
                color: white;
                padding: 0.25rem 0.75rem;
                border-radius: 6px;
                font-size: 0.75rem;
                font-weight: 600;
                letter-spacing: 0.5px;
                animation: pulse 2s ease-in-out infinite;
            }

            @keyframes pulse {

                0%,
                100% {
                    opacity: 1;
                }

                50% {
                    opacity: 0.7;
                }
            }

            .cctv-info {
                align-self: flex-start;
            }

            .expand-button {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(99, 102, 241, 0.2);
                backdrop-filter: blur(10px);
                border: 2px solid rgb(99, 102, 241);
                color: rgb(99, 102, 241);
                padding: 0.75rem;
                border-radius: 50%;
                cursor: pointer;
                transition: all 0.3s ease;
                opacity: 0;
            }

            .cctv-card:hover .expand-button {
                opacity: 1;
            }

            .expand-button:hover {
                background: rgba(99, 102, 241, 0.3);
                transform: translate(-50%, -50%) scale(1.1);
            }

            /* Modal Styles */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.9);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 2rem;
            }

            .modal-overlay.hidden {
                display: none;
            }

            .modal-content {
                position: relative;
                width: 100%;
                max-width: 1200px;
                background: rgba(26, 31, 58, 0.95);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 16px;
                overflow: hidden;
            }

            .modal-close {
                position: absolute;
                top: 1rem;
                right: 1rem;
                background: rgba(239, 68, 68, 0.9);
                border: none;
                color: white;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                font-size: 1.5rem;
                cursor: pointer;
                z-index: 10;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .modal-close:hover {
                background: rgb(239, 68, 68);
                transform: rotate(90deg);
            }

            .modal-video-container {
                position: relative;
                aspect-ratio: 16/9;
            }

            .modal-video {
                width: 100%;
                height: 100%;
                object-fit: contain;
                background: #000;
            }

            .modal-info {
                position: absolute;
                bottom: 1rem;
                left: 1rem;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                padding: 0.75rem 1rem;
            }
        </style>

        <div class="glass-card">
            <div class="px-4 py-5 sm:px-6 border-b border-white/10">
                <h3 class="text-lg leading-6 font-medium text-gray-100">Monitor CCTV Lalu Lintas</h3>
                <p class="mt-1 max-w-2xl text-sm text-gray-400">Live streaming dari 9 titik kamera CCTV di area
                    perjalanan kerja</p>
            </div>

            <div class="p-6">
                <!-- CCTV Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="cctvGrid"></div>
            </div>
        </div>

        <!-- Modal -->
        <div class="modal-overlay hidden" id="modalOverlay" onclick="closeModal()">
            <div class="modal-content" onclick="event.stopPropagation()">
                <button class="modal-close" onclick="closeModal()">×</button>
                <div class="modal-video-container">
                    <video class="modal-video" id="modalVideo" autoplay muted controls></video>
                    <div class="modal-info">
                        <div class="text-sm font-medium text-gray-200" id="modalCameraName"></div>
                        <div class="text-xs text-gray-400 mt-1" id="modalCameraId"></div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
        <script>
            // Camera Data
            const cameras = [
                { id: 'CT-01', name: 'Tambun Selatan (Showroom MG)', url: 'https://its.binamarga.pu.go.id:8989/play/hls/CT-01/index.m3u8' },
                { id: 'CT-02', name: 'RSUD Kab Bekasi (Cibitung)', url: 'https://its.binamarga.pu.go.id:8989/play/hls/CT-02/index.m3u8' },
                { id: 'CT-03', name: 'Stasiun Lemah Abang', url: 'https://its.binamarga.pu.go.id:8989/play/hls/CT-03/index.m3u8' },
                { id: 'CT-04', name: 'U-Turn Besar Perum BCL (Pintu Kereta Perum Graha Asri)', url: 'https://its.binamarga.pu.go.id:8989/play/hls/CT-04/index.m3u8' },
                { id: 'CT-05', name: 'Pintu Kereta Citarik (Michelin)', url: 'https://its.binamarga.pu.go.id:8989/play/hls/CT-05/index.m3u8' },
                { id: 'CT-06', name: 'KPU Kab Bekasi', url: 'https://its.binamarga.pu.go.id:8989/play/hls/CT-06/index.m3u8' },
                { id: 'CT-07', name: 'RS DKH Kedungwaringin (Hino Showroom)', url: 'https://its.binamarga.pu.go.id:8989/play/hls/CT-07/index.m3u8' },
                { id: 'CT-08', name: 'Jalan Lingkar Karawang (Hadap Cikarang)', url: 'https://its.binamarga.pu.go.id:8989/play/hls/CT-08/index.m3u8' },
                { id: 'CT-09', name: 'Pintu TOL Klari', url: 'https://its.binamarga.pu.go.id:8989/play/hls/CT-09/index.m3u8' }
            ];

            // Initialize HLS Player
            function initHLS(video, url) {
                if (Hls.isSupported()) {
                    const hls = new Hls({
                        enableWorker: true,
                        lowLatencyMode: true,
                        backBufferLength: 90
                    });
                    hls.loadSource(url);
                    hls.attachMedia(video);
                    return hls;
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = url;
                    return null;
                }
            }

            // Create CCTV Cards
            const grid = document.getElementById('cctvGrid');
            cameras.forEach(camera => {
                const card = document.createElement('div');
                card.className = 'cctv-card';
                card.innerHTML = `
            <div class="cctv-video-wrapper">
                <video class="cctv-video" autoplay muted playsinline></video>
                <div class="cctv-loading">
                    <div class="loading-spinner"></div>
                    <div class="text-xs text-gray-400 mt-2">Connecting...</div>
                </div>
                <div class="cctv-overlay">
                    <div class="live-badge">● LIVE</div>
                    <div class="cctv-info">
                        <div class="text-xs text-gray-300 font-medium">${camera.id}</div>
                        <div class="text-sm text-white font-semibold">${camera.name}</div>
                    </div>
                    <button class="expand-button" onclick="openModal('${camera.id}')">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                    </button>
                </div>
            </div>
        `;

                const video = card.querySelector('.cctv-video');
                const loading = card.querySelector('.cctv-loading');

                // Initialize HLS
                const hls = initHLS(video, camera.url);

                // Hide loading when video starts
                video.addEventListener('loadeddata', () => {
                    loading.style.display = 'none';
                });

                grid.appendChild(card);
            });

            // Modal Functions
            let modalHls = null;

            function openModal(cameraId) {
                const camera = cameras.find(c => c.id === cameraId);
                if (!camera) return;

                const modal = document.getElementById('modalOverlay');
                const video = document.getElementById('modalVideo');

                document.getElementById('modalCameraName').textContent = camera.name;
                document.getElementById('modalCameraId').textContent = camera.id;

                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';

                if (modalHls) {
                    modalHls.destroy();
                }

                modalHls = initHLS(video, camera.url);
            }

            function closeModal() {
                const modal = document.getElementById('modalOverlay');
                modal.classList.add('hidden');
                document.body.style.overflow = '';

                if (modalHls) {
                    modalHls.destroy();
                    modalHls = null;
                }
            }

            // Close modal on ESC key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
            });
        </script>

        <%- include('../partials/footer') %>