<%- include('../partials/head') %>
    <%- include('../partials/navbar', { useWideContainer: true }) %>
        <script src="/js/html2canvas.min.js"></script>

        <div class="glass-card mb-6">
            <div class="px-6 py-6 flex flex-col sm:flex-row justify-between items-center flex-wrap gap-4">
                <div>
                    <h3 class="text-2xl leading-6 font-bold text-gray-100 drop-shadow-lg flex items-center gap-3">
                        <svg class="h-7 w-7 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        Jadwal Ronda Malam Minggu
                    </h3>
                    <p class="mt-2 text-sm text-gray-400 font-medium ml-10">Bulan <%= moment(year + '-' + month + '-01'
                            ).format('MMMM YYYY') %>
                    </p>
                </div>
                <form action="/ronda" method="GET" class="flex flex-wrap items-center gap-3">
                    <select name="month"
                        class="glass-input rounded-xl text-sm text-gray-100 p-2.5 outline-none font-medium cursor-pointer transition-colors">
                        <% moment.months().forEach(function(m, index) { %>
                            <option value="<%= index + 1 %>" <%=(index + 1)==month ? 'selected' : '' %>><%= m %>
                            </option>
                            <% }) %>
                    </select>
                    <select name="year"
                        class="glass-input rounded-xl text-sm text-gray-100 p-2.5 outline-none font-medium cursor-pointer transition-colors">
                        <% for(let y=2024; y <=2030; y++) { %>
                            <option value="<%= y %>" <%=y==year ? 'selected' : '' %>><%= y %>
                            </option>
                            <% } %>
                    </select>
                    <button type="submit"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-xl font-bold flex items-center gap-2 shadow-lg transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        üîç Lihat
                    </button>
                    <% if(user.role==='admin' || user.role==='bendahara' ) { %>
                        <div class="h-8 w-px bg-white/20 mx-1 hidden sm:block"></div>
                        <a href="/ronda/control?month=<%= month %>&year=<%= year %>"
                            class="glass-button text-gray-300 hover:bg-white/10 px-4 py-2.5 rounded-xl font-bold flex items-center gap-2 border border-white/10">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                                </path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            ‚öôÔ∏è Control
                        </a>
                        <a href="/ronda/teams"
                            class="glass-button text-gray-300 hover:bg-white/10 px-4 py-2.5 rounded-xl font-bold flex items-center gap-2 border border-white/10">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                                </path>
                            </svg>
                            üë• Tim
                        </a>
                        <% } %>
                </form>
            </div>
        </div>


        <style>
            @keyframes glow-pulse {

                0%,
                100% {
                    box-shadow: 0 0 5px rgba(239, 68, 68, 0.5), 0 0 10px rgba(239, 68, 68, 0.3), 0 0 15px rgba(239, 68, 68, 0.2);
                }

                50% {
                    box-shadow: 0 0 10px rgba(239, 68, 68, 0.8), 0 0 20px rgba(239, 68, 68, 0.6), 0 0 30px rgba(239, 68, 68, 0.4);
                }
            }

            .glow-this-week {
                animation: glow-pulse 2s ease-in-out infinite;
            }
        </style>


        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
            <% Object.keys(groupedSchedule).forEach(function(date) { const schedules=groupedSchedule[date]; const
                teamCounts={}; schedules.forEach(function(s) { if(s.tim_ronda) {
                teamCounts[s.tim_ronda]=(teamCounts[s.tim_ronda] || 0) + 1; } }); let teamName=null; let maxCount=0;
                Object.entries(teamCounts).forEach(function([team, count]) { if(count> maxCount) {
                maxCount = count;
                teamName = team;
                }
                });

                // Get all members of this team
                const teamMembers = (teamName && teams[teamName]) ? teams[teamName] : [];

                // Check if this is upcoming (today or future)
                const isUpcoming = moment(date).isSameOrAfter(moment(), 'day');

                // Special handling for Saturday night (Malam Minggu)
                // Saturday night ronda should stay active until Sunday 6 AM
                const now = moment();
                const rondaDate = moment(date);
                const isSaturday = rondaDate.day() === 6;
                const isSunday = now.day() === 0;
                const currentHour = now.hour();

                let isPast;
                if (isSaturday && isSunday && currentHour < 6) { isPast=false; } else {
                    isPast=moment(date).isBefore(moment(), 'day' ); } const isToday=moment(date).isSame(moment(), 'day'
                    ); let isThisWeek; if (isSaturday && isSunday && currentHour < 6) { isThisWeek=true; } else {
                    isThisWeek=moment(date).isSame(moment(), 'week' ); } const isHighlighted=isThisWeek && !isPast; %>
                    <div id="card-<%= date %>"
                        class="glass-card overflow-hidden divide-y <%= isHighlighted ? 'divide-gray-200' : 'divide-white/10' %> <%= isHighlighted ? 'bg-slate-50 border-2 border-white shadow-2xl scale-[1.02] z-10' : '' %> <%= isToday ? '!border-green-400 !bg-green-50 ring-4 ring-green-400/20' : '' %> <%= isPast ? 'opacity-60 grayscale-[0.2]' : '' %> transition-all duration-300 hover:scale-[1.03]">
                        <div
                            class="px-4 py-5 sm:px-6 <%= isPast ? 'bg-white/5' : (isToday ? 'bg-green-100' : (isHighlighted ? 'bg-white border-b border-gray-200' : 'bg-white/5')) %> backdrop-blur-sm">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3
                                        class="text-lg font-bold <%= isPast ? 'text-gray-500' : (isToday ? 'text-green-700' : (isHighlighted ? 'text-gray-800' : 'text-indigo-300')) %> drop-shadow-lg">
                                        <%= moment(date).format('dddd, DD MMMM YYYY') %>
                                    </h3>
                                    <!-- Mobile Version (Text Buttons) -->
                                    <div class="flex flex-wrap items-center gap-2 mt-1 lg:hidden">
                                        <% if(isToday) { %>
                                            <span
                                                class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-bold bg-green-600/90 text-white shadow-sm">
                                                üîî Hari Ini
                                            </span>
                                            <% } else if(isThisWeek && !isPast) { %>
                                                <span
                                                    class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-bold bg-gray-600/90 text-white shadow-sm">
                                                    üìÖ Minggu Ini
                                                </span>
                                                <% } %>

                                                    <button onclick="shareSchedule('<%= date %>', this)"
                                                        class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-bold bg-gray-700/90 text-white hover:bg-gray-800 transition shadow-sm border border-gray-600/50">
                                                        üîó Share
                                                    </button>

                                                    <% if(user.role==='admin' || isToday || isThisWeek) { %>
                                                        <button onclick="openUploadConditionModal('<%= date %>')"
                                                            class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-bold bg-gray-600/90 text-white hover:bg-gray-700 transition shadow-sm border border-gray-500/50">
                                                            üì∑ Foto
                                                        </button>
                                                        <% } %>

                                                            <% if(isPast) { %>
                                                                <span
                                                                    class="inline-flex items-center px-2 py-0.5 rounded-full text-sm font-medium bg-gray-500/80 text-white shadow-sm">
                                                                    ‚úì Selesai
                                                                </span>
                                                                <% } %>
                                    </div>

                                    <!-- Desktop Version (Icon Toolbar) -->
                                    <div class="hidden lg:flex items-center gap-1 mt-1">
                                        <% if(isToday) { %>
                                            <span
                                                class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-green-500/20 text-green-300 border border-green-500/30"
                                                title="Hari Ini">
                                                üîî
                                            </span>
                                            <% } else if(isThisWeek && !isPast) { %>
                                                <span
                                                    class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-orange-100 text-orange-600 border border-orange-200"
                                                    title="Minggu Ini">
                                                    üìÖ
                                                </span>
                                                <% } %>

                                                    <button onclick="shareSchedule('<%= date %>', this)"
                                                        class="inline-flex items-center justify-center w-6 h-6 rounded-full <%= isHighlighted ? 'bg-white text-gray-500 hover:bg-gray-100 hover:text-gray-700 border-gray-200' : 'bg-white/5 text-gray-300 hover:bg-white/10 hover:text-white border-white/10' %> border transition-colors"
                                                        title="Share to WhatsApp">
                                                        üîó
                                                    </button>

                                                    <% if(user.role==='admin' || isToday || isThisWeek) { %>
                                                        <button onclick="openUploadConditionModal('<%= date %>')"
                                                            class="inline-flex items-center justify-center w-6 h-6 rounded-full <%= isHighlighted ? 'bg-white text-gray-500 hover:bg-gray-100 hover:text-gray-700 border-gray-200' : 'bg-white/5 text-gray-300 hover:bg-white/10 hover:text-white border-white/10' %> border transition-colors"
                                                            title="Upload Foto Ronda">
                                                            üì∑
                                                        </button>
                                                        <% } %>

                                                            <% if(isPast) { %>
                                                                <span
                                                                    class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-gray-500/20 text-gray-400 border border-gray-500/30"
                                                                    title="Selesai">
                                                                    ‚úì
                                                                </span>
                                                                <% } %>
                                    </div>
                                </div>
                                <% if(teamName) { %>
                                    <span
                                        class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold <%= isPast ? 'bg-gray-400 text-white' : 'bg-indigo-600 text-white' %> shadow-sm border <%= isPast ? 'border-gray-500' : 'border-indigo-400 glass-button' %>">
                                        Tim <%= teamName %>
                                    </span>
                                    <% } %>
                            </div>

                            <% if(teamMembers.length> 0) { %>
                                <div
                                    class="mt-2 pt-2 border-t <%= isPast ? 'border-gray-300' : (isToday ? 'border-green-200' : (isHighlighted ? 'border-gray-200' : 'border-indigo-200/50')) %>">
                                    <div
                                        class="text-xs font-semibold <%= isPast ? 'text-gray-500' : (isToday ? 'text-green-700' : (isHighlighted ? 'text-gray-600' : 'text-indigo-300')) %> mb-2">
                                        Anggota Tim:</div>
                                    <div class="flex items-center justify-between">
                                        <div class="flex flex-wrap gap-1.5">
                                            <% teamMembers.forEach(function(member) { %>
                                                <span
                                                    class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium backdrop-blur-sm <%= isPast ? 'bg-gray-500/20 text-gray-300 border border-gray-500/30' : (isToday ? 'bg-green-100 text-green-800 border border-green-200' : (isHighlighted ? 'bg-indigo-50 text-indigo-700 border border-indigo-100' : 'bg-indigo-500/20 text-indigo-200 border border-indigo-500/30')) %> shadow-sm">
                                                    <%= member.nama %>
                                                </span>
                                                <% }) %>
                                        </div>

                                        <!-- Photos for the night -->
                                        <% let allPhotos=[]; schedules.forEach(function(s) { if (s.parsedPhotos) {
                                            s.parsedPhotos.forEach(function(photo) { if(typeof photo==='string' ) {
                                            allPhotos.push({src: photo, type: 'individual' , uploader: s.nama}); } }); }
                                            }); if (groupedDocumentation && groupedDocumentation[date]) {
                                            groupedDocumentation[date].forEach(function(doc) { if (doc.parsedPhotos) {
                                            doc.parsedPhotos.forEach(function(photo) { if(typeof photo==='string' ) {
                                            allPhotos.push({src: photo, type: 'condition' , uploader: 'Kondisi' }); }
                                            }); } }); } if(allPhotos && allPhotos.length> 0) {
                                            const photoSources = allPhotos.map(function(p) { return p.src; });
                                            const safePhotosJson = JSON.stringify(photoSources).replace(/'/g, "&apos;");
                                            %>
                                            <div class="flex -space-x-2 ml-4 cursor-pointer"
                                                data-photos='<%- safePhotosJson %>'
                                                onclick="openCarouselFromData(this, 0)">
                                                <% allPhotos.slice(0, 5).forEach(function(photo) { const
                                                    isVideo=photo.src.match(/\.(mp4|mov|avi|webm)$/i); %>
                                                    <% if(isVideo) { %>
                                                        <div
                                                            class="inline-block w-8 h-8 aspect-square rounded-full ring-2 ring-gray-900 bg-black flex items-center justify-center relative overflow-hidden">
                                                            <video src="/uploads/ronda/<%= photo.src %>#t=1.0"
                                                                class="absolute inset-0 w-full h-full object-cover opacity-60"
                                                                preload="metadata"></video>
                                                            <span class="text-[8px] text-white font-bold z-10">‚ñ∂</span>
                                                        </div>
                                                        <% } else { %>
                                                            <div
                                                                class="inline-block w-8 h-8 aspect-square rounded-full ring-2 ring-gray-900 overflow-hidden">
                                                                <img class="w-full h-full object-cover"
                                                                    src="/uploads/ronda/<%= photo.src %>" alt="">
                                                            </div>
                                                            <% } %>
                                                                <% }) %>
                                                                    <% if(allPhotos.length> 5) { %>
                                                                        <div
                                                                            class="inline-flex items-center justify-center w-8 h-8 aspect-square rounded-full bg-gray-700 text-[10px] font-bold text-white ring-2 ring-gray-900">
                                                                            +<%= allPhotos.length - 5 %>
                                                                        </div>
                                                                        <% } %>
                                            </div>
                                            <% } %>
                                    </div>
                                </div>
                                <% } %>
                        </div>
                        <div class="px-4 py-5 sm:p-6">
                            <ul class="space-y-3">
                                <% let loopItems=[]; if (teamMembers && teamMembers.length> 0) {
                                    loopItems = [...teamMembers];
                                    const memberIds = new Set(teamMembers.map(function(m) { return m.id; }));
                                    schedules.forEach(function(sch) {
                                    if (!memberIds.has(sch.warga_id)) {
                                    loopItems.push(sch);
                                    }
                                    });
                                    } else {
                                    loopItems = schedules;
                                    }

                                    loopItems.forEach(function(item) {
                                    let s = schedules.find(function(sc) { return sc.warga_id === (item.warga_id ||
                                    item.id); });
                                    if (!s) {
                                    s = {
                                    id: '',
                                    warga_id: item.id,
                                    nama: item.nama,
                                    blok: item.blok,
                                    nomor_rumah: item.nomor_rumah,
                                    status: '',
                                    denda: 0,
                                    foto_bukti: []
                                    };
                                    }
                                    const isGuest = teamMembers && teamMembers.length > 0 &&
                                    !teamMembers.some(function(m) {
                                    return m.id === (item.warga_id || item.id);
                                    });
                                    %>
                                    <li
                                        class="flex justify-between items-center <%= isHighlighted ? 'bg-white shadow-sm hover:bg-gray-50 border-gray-200' : 'bg-white/5 border-white/5 hover:bg-white/10' %> rounded-2xl px-4 py-3 border transition-all group">
                                        <div class="flex-grow min-w-0 mr-3">
                                            <div class="flex items-center gap-2">
                                                <div
                                                    class="text-sm font-bold <%= isHighlighted ? 'text-gray-800' : 'text-gray-100' %> truncate">
                                                    <%= s.nama %>
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-2 mt-0.5">
                                                <div
                                                    class="text-xs <%= isHighlighted ? 'text-gray-500 bg-gray-100' : 'text-gray-400 bg-black/20' %> font-medium px-2 py-0.5 rounded-md inline-block">
                                                    <%= s.blok %>-<%= s.nomor_rumah %>
                                                </div>
                                                <% if (isGuest) { %>
                                                    <div
                                                        class="text-[10px] text-red-400 font-bold bg-red-500/10 px-2 py-0.5 rounded-md border border-red-500/20">
                                                        Ganti Hari
                                                    </div>
                                                    <% } %>
                                                        <% if(s.status !=='scheduled' ) { let statusText=s.status; let
                                                            statusClass='' ; if (s.status_bayar==='paid' ) {
                                                            statusText='Pay Up' ;
                                                            statusClass='bg-green-500/20 text-green-300 border border-green-500/30'
                                                            ; } else if (s.status==='hadir' ) {
                                                            statusClass='bg-green-500/20 text-green-300 border border-green-500/30'
                                                            ; } else if (s.status==='izin' || s.status==='reschedule' )
                                                            {
                                                            statusClass='bg-yellow-500/20 text-yellow-300 border border-yellow-500/30'
                                                            ; } else {
                                                            statusClass='bg-red-500/20 text-red-300 border border-red-500/30'
                                                            ; } %>
                                                            <span
                                                                class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider <%= statusClass %>">
                                                                <%= statusText %>
                                                            </span>
                                                            <% } %>
                                            </div>

                                            <% if(s.denda> 0) { %>
                                                <div
                                                    class="text-xs text-red-400 font-bold mt-1 flex items-center gap-1">
                                                    <span>üí∏</span> Denda: Rp <%= s.denda.toLocaleString('id-ID') %>
                                                </div>
                                                <% } %>

                                                    <!-- Display Photos -->
                                                    <% if(s.foto_bukti) { let photos=s.parsedPhotos || []; if(photos &&
                                                        photos.length> 0) {
                                                        const safePhotosJson = JSON.stringify(photos).replace(/'/g,
                                                        "&apos;");
                                                        %>
                                                        <div class="mt-2 flex overflow-x-auto space-x-2 pb-1 scrollbar-hide"
                                                            data-photos='<%- safePhotosJson %>'>
                                                            <% photos.forEach(function(photo, index) { if(!photo ||
                                                                typeof photo !=='string' ) return; const
                                                                isVideo=photo.match(/\.(mp4|mov|avi|webm)$/i); %>
                                                                <% if(isVideo) { %>
                                                                    <div onclick="openCarouselFromData(this, <%= index %>)"
                                                                        class="h-8 w-8 relative cursor-pointer rounded-lg border border-gray-600 hover:border-indigo-400 bg-black flex items-center justify-center shrink-0 transition-colors">
                                                                        <span class="text-[8px]">‚ñ∂</span>
                                                                    </div>
                                                                    <% } else { %>
                                                                        <img src="/uploads/ronda/<%= photo %>"
                                                                            onclick="openCarouselFromData(this, <%= index %>)"
                                                                            class="h-8 w-8 object-cover rounded-lg border border-gray-600 hover:border-indigo-400 cursor-pointer shrink-0 transition-colors">
                                                                        <% } %>
                                                                            <% }); %>
                                                        </div>
                                                        <% } } %>
                                        </div>

                                        <div class="flex items-center gap-2 shrink-0">
                                            <% if(user.role !=='warga' || user.warga_id==s.warga_id) { %>
                                                <% if((s.status==='scheduled' || s.status==='reschedule' ||
                                                    s.status==='' ) && s.id) { %>
                                                    <button onclick="openStatusModal('<%= s.id %>', '<%= s.nama %>')"
                                                        class="p-2 rounded-full bg-indigo-500/20 text-indigo-300 hover:bg-indigo-500/30 border border-indigo-400/30 transition-all"
                                                        title="Absensi">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                            viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                                stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                        </svg>
                                                    </button>
                                                    <% } %>
                                                        <% if(s.denda> 0) { %>
                                                            <% if(s.status_bayar==='pending' ) { %>
                                                                <% if(user.role==='admin' ) { %>
                                                                    <button
                                                                        onclick="openVerifyFineModal('<%= s.id %>', '<%= s.bukti_bayar %>')"
                                                                        class="p-2 rounded-full bg-blue-500/20 text-blue-300 hover:bg-blue-500/30 border border-blue-400/30 transition-all text-xs font-bold"
                                                                        title="Verifikasi Pembayaran">
                                                                        Verifikasi
                                                                    </button>
                                                                    <% } else { %>
                                                                        <span
                                                                            class="p-2 rounded-full bg-yellow-500/20 text-yellow-300 border border-yellow-400/30 text-xs font-bold cursor-help"
                                                                            title="Menunggu Verifikasi Admin">
                                                                            ‚è≥
                                                                        </span>
                                                                        <% } %>
                                                                            <% } else { %>
                                                                                <button
                                                                                    onclick="openPayFineModal('<%= s.id %>', '<%= s.denda %>')"
                                                                                    class="p-2 rounded-full bg-green-500/20 text-green-300 hover:bg-green-500/30 border border-green-400/30 transition-all"
                                                                                    title="Bayar Denda">
                                                                                    <svg class="w-4 h-4" fill="none"
                                                                                        stroke="currentColor"
                                                                                        viewBox="0 0 24 24">
                                                                                        <path stroke-linecap="round"
                                                                                            stroke-linejoin="round"
                                                                                            stroke-width="2"
                                                                                            d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                                                                        </path>
                                                                                    </svg>
                                                                                </button>
                                                                                <% } %>
                                                                                    <% } %>
                                                                                        <% } %>

                                                                                            <!-- Upload Foto Button -->
                                                                                            <% if((user.role==='admin'
                                                                                                || isToday || isThisWeek
                                                                                                || s.status==='hadir' )
                                                                                                && s.id) { %>
                                                                                                <button
                                                                                                    onclick="openUploadModal('<%= s.id %>', '<%= s.nama %>')"
                                                                                                    class="p-2 rounded-full bg-blue-500/20 text-blue-300 hover:bg-blue-500/30 border border-blue-400/30 transition-all"
                                                                                                    title="Upload Foto">
                                                                                                    <svg class="w-4 h-4"
                                                                                                        fill="none"
                                                                                                        stroke="currentColor"
                                                                                                        viewBox="0 0 24 24">
                                                                                                        <path
                                                                                                            stroke-linecap="round"
                                                                                                            stroke-linejoin="round"
                                                                                                            stroke-width="2"
                                                                                                            d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z">
                                                                                                        </path>
                                                                                                        <path
                                                                                                            stroke-linecap="round"
                                                                                                            stroke-linejoin="round"
                                                                                                            stroke-width="2"
                                                                                                            d="M15 13a3 3 0 11-6 0 3 3 0 016 0z">
                                                                                                        </path>
                                                                                                    </svg>
                                                                                                </button>
                                                                                                <% } %>
                                        </div>
                                    </li>
                                    <% }) %>
                            </ul>
                        </div>
                    </div>
                    <% }) %>
        </div>

        <!-- Status Modal -->
        <div id="statusModal"
            class="fixed inset-0 bg-black/60 hidden overflow-y-auto h-full w-full z-50 backdrop-blur-sm">
            <div class="relative top-20 mx-auto p-6 glass-card w-full max-w-md shadow-2xl">
                <h3 class="text-lg font-bold text-gray-100 mb-6 flex items-center gap-2">
                    <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Absensi Ronda
                </h3>
                <form action="/ronda/update-status" method="POST">
                    <input type="hidden" id="scheduleId" name="id">
                    <div class="mb-5">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Nama
                            Warga</label>
                        <div id="wargaName"
                            class="text-gray-100 font-bold bg-white/5 p-3 rounded-xl border border-white/10"></div>
                    </div>
                    <div class="mb-5">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Status
                            Kehadiran</label>
                        <select name="status"
                            class="glass-input mt-1 block w-full rounded-xl p-3 outline-none cursor-pointer">
                            <option value="hadir">Hadir</option>
                            <option value="reschedule">Reschedule (Ganti Minggu Depan)</option>
                            <option value="alpa">Alpa (Denda 50rb)</option>
                        </select>
                    </div>
                    <div class="mb-6">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Keterangan
                            (Opsional)</label>
                        <textarea name="keterangan" rows="3" placeholder="Tambahkan catatan jika diperlukan..."
                            class="glass-input mt-1 block w-full rounded-xl p-3 outline-none resize-none"></textarea>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="document.getElementById('statusModal').classList.add('hidden')"
                            class="px-6 py-2.5 rounded-xl text-sm font-bold text-gray-400 hover:text-gray-200 transition-colors">
                            Batal
                        </button>
                        <button type="submit"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-2.5 rounded-xl font-bold shadow-lg transition-all">
                            Simpan
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Upload Modal -->
        <div id="uploadModal"
            class="fixed inset-0 bg-black/60 hidden overflow-y-auto h-full w-full z-50 backdrop-blur-sm">
            <div class="relative top-20 mx-auto p-6 glass-card w-full max-w-md shadow-2xl">
                <h3 class="text-lg font-bold text-gray-100 mb-6 flex items-center gap-2">
                    <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Upload Bukti Ronda
                </h3>
                <form id="uploadForm" action="" method="POST" enctype="multipart/form-data">
                    <div class="mb-5">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Nama
                            Warga /
                            Kegiatan</label>
                        <div id="uploadWargaName"
                            class="text-gray-100 font-bold bg-white/5 p-3 rounded-xl border border-white/10"></div>
                    </div>
                    <div class="mb-6">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Pilih
                            File
                            (Foto/Video)</label>
                        <div
                            class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-white/10 border-dashed rounded-xl bg-white/5 hover:bg-white/10 transition-colors cursor-pointer relative">
                            <div class="space-y-1 text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none"
                                    viewBox="0 0 48 48" aria-hidden="true">
                                    <path
                                        d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <div class="flex text-sm text-gray-400">
                                    <label for="file-upload"
                                        class="relative cursor-pointer rounded-md font-bold text-blue-400 hover:text-blue-300">
                                        <span>Upload files</span>
                                        <input id="file-upload" name="foto_bukti" type="file" class="sr-only" multiple
                                            accept="image/*,video/*" required onchange="updateFileName(this)">
                                    </label>
                                    <p class="pl-1">or drag and drop</p>
                                </div>
                                <p class="text-xs text-gray-500">PNG, JPG, MP4 up to 10 files</p>
                                <div id="file-name-display" class="text-xs text-indigo-400 font-bold mt-2"></div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="document.getElementById('uploadModal').classList.add('hidden')"
                            class="px-6 py-2.5 rounded-xl text-sm font-bold text-gray-400 hover:text-gray-200 transition-colors">
                            Batal
                        </button>
                        <button type="submit"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-2.5 rounded-xl font-bold shadow-lg transition-all">
                            Upload
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Carousel Modal -->
        <div id="carouselModal"
            class="fixed inset-0 bg-black bg-opacity-90 hidden z-50 flex items-center justify-center"
            onclick="if(event.target === this) closeCarousel()">
            <button onclick="closeCarousel()" class="absolute top-4 right-4 text-white hover:text-gray-300 z-50">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
            <button onclick="prevSlide()"
                class="absolute left-4 text-white hover:text-gray-300 z-50 bg-black bg-opacity-50 rounded-full p-2">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                    </path>
                </svg>
            </button>
            <button onclick="nextSlide()"
                class="absolute right-4 text-white hover:text-gray-300 z-50 bg-black bg-opacity-50 rounded-full p-2">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>
            <div class="relative max-w-4xl max-h-screen p-4 flex justify-center items-center">
                <img id="carouselImage" src=""
                    class="max-h-[85vh] max-w-full object-contain rounded-lg shadow-2xl hidden">
                <video id="carouselVideo" src=""
                    class="max-h-[85vh] max-w-full object-contain rounded-lg shadow-2xl hidden" controls></video>
                <div id="carouselCounter"
                    class="absolute bottom-[-30px] left-1/2 transform -translate-x-1/2 text-white font-medium">
                </div>

                <% if(user.role==='admin' || user.role==='ketua' || user.role==='warga' ) { %>
                    <form id="deletePhotoForm" action="/ronda/delete-photo" method="POST"
                        class="absolute top-4 left-4 z-50" onsubmit="return confirm('Hapus foto ini?')">
                        <input type="hidden" name="filename" id="deleteFilename">
                        <button type="submit"
                            class="text-white hover:text-red-500 bg-black bg-opacity-50 rounded-full p-2">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                </path>
                            </svg>
                        </button>
                    </form>
                    <% } %>
            </div>
        </div>

        <script>
            let currentPhotos = [];
            let currentIndex = 0;



            function openCarouselFromData(element, index) {
                const parent = element.closest('[data-photos]');
                if (parent) {
                    const photosJson = parent.getAttribute('data-photos');
                    openCarousel(photosJson, index);
                }
            }

            function openCarousel(photosJson, startIndex = 0) {
                try {
                    currentPhotos = JSON.parse(photosJson);
                    if (currentPhotos.length > 0) {
                        currentIndex = startIndex;
                        showSlide(currentIndex);
                        document.getElementById('carouselModal').classList.remove('hidden');
                    }
                } catch (e) {
                    console.error("Error parsing photos for carousel", e);
                }
            }

            function closeCarousel() {
                document.getElementById('carouselModal').classList.add('hidden');
            }

            function showSlide(index) {
                if (index < 0) index = currentPhotos.length - 1;
                if (index >= currentPhotos.length) index = 0;
                currentIndex = index;

                const filename = currentPhotos[currentIndex];
                const isVideo = filename.match(/\.(mp4|mov|avi|webm)$/i);

                const img = document.getElementById('carouselImage');
                const vid = document.getElementById('carouselVideo');

                vid.pause();

                if (isVideo) {
                    img.classList.add('hidden');
                    vid.classList.remove('hidden');
                    vid.src = '/uploads/ronda/' + filename;
                } else {
                    vid.classList.add('hidden');
                    img.classList.remove('hidden');
                    img.src = '/uploads/ronda/' + filename;
                }

                document.getElementById('carouselCounter').innerText = (currentIndex + 1) + ' / ' + currentPhotos.length;

                // Update delete form filename
                document.getElementById('deleteFilename').value = filename;
            }

            function nextSlide() {
                showSlide(currentIndex + 1);
            }

            function prevSlide() {
                showSlide(currentIndex - 1);
            }

            // Keyboard navigation
            document.addEventListener('keydown', function (e) {
                if (document.getElementById('carouselModal').classList.contains('hidden')) return;
                if (e.key === 'ArrowLeft') prevSlide();
                if (e.key === 'ArrowRight') nextSlide();
                if (e.key === 'Escape') closeCarousel();
            });

            function openStatusModal(id, name) {
                document.getElementById('scheduleId').value = id;
                document.getElementById('wargaName').innerText = name;
                document.getElementById('statusModal').classList.remove('hidden');
            }

            function openUploadModal(id, name) {
                document.getElementById('uploadForm').action = '/ronda/upload-photos/' + id;
                document.getElementById('uploadWargaName').innerText = name;
                document.getElementById('uploadModal').classList.remove('hidden');
            }

            function openUploadConditionModal(date) {
                document.getElementById('uploadForm').action = '/ronda/upload-condition/' + date;
                document.getElementById('uploadWargaName').innerText = 'Kondisi Ronda (' + date + ')';
                document.getElementById('uploadModal').classList.remove('hidden');
            }

            function updateFileName(input) {
                const display = document.getElementById('file-name-display');
                if (input.files && input.files.length > 0) {
                    display.innerText = input.files.length + ' file(s) selected';
                } else {
                    display.innerText = '';
                }
            }
        </script>

        <script>
            async function shareSchedule(date, btn) {
                const originalText = btn.innerHTML;

                if (typeof html2canvas === 'undefined') {
                    alert('Fitur share sedang dimuat, coba sesaat lagi.');
                    return;
                }

                const card = document.getElementById('card-' + date);
                if (!card) return;

                // Processing...
                btn.innerHTML = '‚è≥ ...';
                btn.disabled = true;

                try {
                    const canvas = await html2canvas(card, { scale: 2, useCORS: true, logging: false });

                    canvas.toBlob(async (blob) => {
                        const formData = new FormData();
                        formData.append('image', blob, 'schedule-' + date + '.png');

                        const response = await fetch('/ronda/share-image', {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();
                        if (result.success) {
                            if (result.shareId) {
                                window.location.href = `/ronda/v/${result.shareId}`;
                            } else {
                                window.location.href = `/ronda/view?date=${date}&img=${result.filename}`;
                            }
                        } else {
                            alert('Gagal generate view: ' + (result.error || 'Unknown error'));
                        }

                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 'image/png');

                } catch (e) {
                    console.error(e);
                    alert('Error processing view');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        </script>

        <!-- Pay Fine Modal -->
        <div id="payFineModal" class="fixed inset-0 z-[10000] hidden overflow-y-auto" aria-labelledby="modal-title"
            role="dialog" aria-modal="true">
            <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" aria-hidden="true"
                    onclick="closePayFineModal()"></div>
                <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                <div
                    class="inline-block align-bottom bg-gray-900/90 backdrop-blur-xl rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full border border-white/10">
                    <div class="px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <h3 class="text-lg leading-6 font-medium text-white" id="modal-title">Bayar Denda Ronda</h3>
                        <div class="mt-4 text-center">
                            <p class="text-sm text-gray-300 mb-4">Scan QRIS di bawah ini untuk membayar denda sebesar
                                <span class="font-bold text-red-400" id="payFineAmount">Rp 50.000</span>
                            </p>
                            <div class="flex justify-center bg-white p-4 rounded-xl mx-auto w-fit">
                                <canvas id="qrisCanvas"></canvas>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">NMID: ID1020020020020 (Warga Ambyar)</p>
                        </div>
                        <form action="/ronda/pay-fine-upload" method="POST" enctype="multipart/form-data" class="mt-4">
                            <input type="hidden" name="id" id="payFineId">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-300 mb-1">Upload Bukti
                                    Transfer</label>
                                <input type="file" name="foto_bukti" accept="image/*" required
                                    class="w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700">
                            </div>
                            <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                                <button type="submit"
                                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:col-start-2 sm:text-sm">
                                    Kirim Bukti
                                </button>
                                <button type="button" onclick="closePayFineModal()"
                                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-600 shadow-sm px-4 py-2 bg-gray-800 text-base font-medium text-gray-300 hover:text-white hover:bg-gray-700 focus:outline-none sm:mt-0 sm:col-start-1 sm:text-sm">
                                    Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
        <script>
            function openPayFineModal(id, denda) {
                document.getElementById('payFineId').value = id;
                document.getElementById('payFineAmount').innerText = 'Rp ' + parseInt(denda).toLocaleString('id-ID');
                document.getElementById('payFineModal').classList.remove('hidden');

                // Generate QRIS (Base String from ENV + ID for uniqueness)
                const qrisData = "<%= typeof staticQris !== 'undefined' ? staticQris : '' %>" + id;

                QRCode.toCanvas(document.getElementById('qrisCanvas'), qrisData, { width: 200, margin: 2 }, function (error) {
                    if (error) console.error(error)
                })
            }

            function closePayFineModal() {
                document.getElementById('payFineModal').classList.add('hidden');
            }

            function openVerifyFineModal(id, proof) {
                document.getElementById('verifyFineId').value = id;
                document.getElementById('verifyProofImage').src = '/uploads/ronda/' + proof;
                document.getElementById('verifyFineModal').classList.remove('hidden');
            }

            function closeVerifyFineModal() {
                document.getElementById('verifyFineModal').classList.add('hidden');
            }
        </script>

        <!-- Verify Fine Modal -->
        <div id="verifyFineModal" class="fixed inset-0 z-[10000] hidden overflow-y-auto" aria-labelledby="modal-title"
            role="dialog" aria-modal="true">
            <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" aria-hidden="true"
                    onclick="closeVerifyFineModal()"></div>
                <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                <div
                    class="inline-block align-bottom bg-gray-900/90 backdrop-blur-xl rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full border border-white/10">
                    <div class="px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <h3 class="text-lg leading-6 font-medium text-white" id="modal-title">Verifikasi Pembayaran
                            Denda</h3>
                        <div class="mt-4 text-center">
                            <p class="text-sm text-gray-300 mb-4">Bukti Pembayaran:</p>
                            <div class="flex justify-center bg-black/50 p-2 rounded-xl mx-auto w-fit mb-4">
                                <img id="verifyProofImage" src="" class="max-h-[60vh] object-contain rounded-lg">
                            </div>
                        </div>
                        <form action="/ronda/verify-fine" method="POST" class="mt-4">
                            <input type="hidden" name="id" id="verifyFineId">
                            <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                                <button type="submit" name="action" value="approve"
                                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none sm:col-start-2 sm:text-sm">
                                    Setujui (Lunas)
                                </button>
                                <button type="submit" name="action" value="reject"
                                    class="mt-3 w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:mt-0 sm:col-start-1 sm:text-sm">
                                    Tolak
                                </button>
                            </div>
                            <div class="mt-3">
                                <button type="button" onclick="closeVerifyFineModal()"
                                    class="w-full inline-flex justify-center rounded-md border border-gray-600 shadow-sm px-4 py-2 bg-gray-800 text-base font-medium text-gray-300 hover:text-white hover:bg-gray-700 focus:outline-none sm:text-sm">
                                    Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <%- include('../partials/footer') %>