<%- include('../partials/head') %>
    <%- include('../partials/navbar') %>
        <% function safeJson(obj) { if (!obj) return 'null' ; return JSON.stringify(obj).replace(/"/g, '&quot;' ); } %>

            <div class="glass-card">
                <div class="glass-card relative z-30">
                    <div
                        class="px-4 py-5 sm:px-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 border-b border-white/10">
                        <div class="w-full md:w-auto flex justify-between items-center">
                            <div>
                                <h3 class="text-lg leading-6 font-medium text-emerald-400">Data Iuran</h3>
                                <p class="mt-1 max-w-2xl text-sm text-emerald-100/70">Daftar tagihan dan pembayaran
                                    iuran
                                    warga.</p>
                            </div>
                        </div>

                        <!-- Mobile Action Bar (Visible < md) -->
                        <div class="w-full md:hidden mt-4 space-y-3">
                            <a href="/iuran/pay"
                                class="w-full glass-button inline-flex justify-center items-center px-4 py-3 text-base font-bold rounded-xl text-white bg-gradient-to-r from-emerald-500 to-teal-600 shadow-lg border border-white/20">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Input Bayar
                            </a>
                            <button onclick="toggleFilters()"
                                class="w-full glass-button inline-flex justify-between items-center px-4 py-2 text-sm font-medium rounded-lg text-gray-300 border border-white/10 bg-white/5">
                                <span>Filters & Options</span>
                                <svg id="filter-icon" class="w-5 h-5 transform transition-transform duration-200"
                                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- Desktop & Expanded Mobile Filters -->
                        <div id="filter-container"
                            class="hidden md:flex w-full md:w-auto mt-2 md:mt-0 flex-col md:flex-row gap-2">
                            <div class="grid grid-cols-1 md:flex md:items-center gap-2 md:space-x-2">
                                <!-- Year Filter -->
                                <select onchange="window.location.href='/iuran?year='+this.value"
                                    class="glass-input w-full md:w-auto rounded-lg text-sm py-2 px-3 cursor-pointer">
                                    <% for(let y=2024; y<=parseInt(moment().format('YYYY')) + 1; y++) { %>
                                        <option value="<%= y %>" <%=y==year ? 'selected' : '' %>><%= y %>
                                        </option>
                                        <% } %>
                                </select>



                                <!-- Empty House Filter Switch -->
                                <div
                                    class="flex items-center justify-center gap-2 bg-white/5 p-1.5 rounded-lg border border-white/10 h-[38px]">
                                    <span id="toggle-empty-label"
                                        class="text-xs text-gray-400 font-medium whitespace-nowrap w-[45px] text-center">Huni</span>
                                    <button id="toggle-empty-btn" onclick="toggleEmptyRows()" type="button"
                                        class="relative inline-flex h-5 w-9 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none bg-emerald-500"
                                        role="switch" aria-checked="true">
                                        <span aria-hidden="true"
                                            class="translate-x-4 pointer-events-none inline-block h-4 w-4 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                                    </button>
                                </div>

                                <!-- Export Dropdown -->
                                <div class="relative inline-block text-left w-full md:w-auto">
                                    <button onclick="toggleExportDropdown(event)" type="button"
                                        class="glass-button w-full md:w-auto justify-center inline-flex items-center px-3 py-2 text-sm font-medium rounded-lg text-gray-300 transition-colors border border-white/10"
                                        id="menu-button" aria-expanded="true" aria-haspopup="true">
                                        Export
                                        <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                            <path fill-rule="evenodd"
                                                d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                                clip-rule="evenodd" />
                                        </svg>
                                    </button>

                                    <div id="export-dropdown"
                                        class="hidden origin-top-right absolute right-0 mt-2 w-36 rounded-md shadow-lg bg-gray-900/95 backdrop-blur-xl border border-white/20 ring-1 ring-black ring-opacity-5 focus:outline-none z-50"
                                        role="menu" aria-orientation="vertical" aria-labelledby="menu-button"
                                        tabindex="-1">
                                        <div class="py-1" role="none">
                                            <button onclick="exportToImage(); toggleExportDropdown(event)"
                                                class="text-gray-300 hover:bg-white/10 block px-4 py-2 text-sm w-full text-left"
                                                role="menuitem" tabindex="-1">
                                                Image
                                            </button>
                                            <button onclick="exportToPDF(); toggleExportDropdown(event)"
                                                class="text-gray-300 hover:bg-white/10 block px-4 py-2 text-sm w-full text-left"
                                                role="menuitem" tabindex="-1">
                                                PDF
                                            </button>
                                            <% if(user && (user.role==='admin' || user.role==='bendahara' )) { %>
                                                <a href="/iuran/export"
                                                    class="text-gray-300 hover:bg-white/10 block px-4 py-2 text-sm w-full text-left"
                                                    role="menuitem" tabindex="-1">
                                                    Excel
                                                </a>
                                                <% } %>
                                        </div>
                                    </div>
                                </div>

                                <% if(user && (user.role==='admin' || user.role==='bendahara' )) { %>
                                    <form action="/iuran/generate" method="POST" class="w-full md:w-auto">
                                        <button type="submit"
                                            class="glass-button w-full md:w-auto justify-center inline-flex items-center px-3 py-2 text-sm font-medium rounded-lg text-gray-300 transition-colors border border-white/10">
                                            Generate
                                        </button>
                                    </form>
                                    <a href="/iuran/arrears"
                                        class="glass-button w-full md:w-auto justify-center inline-flex items-center px-3 py-2 text-sm font-medium rounded-lg text-gray-300 bg-white/10 hover:bg-white/15 transition-colors border border-white/15">
                                        Tunggakan
                                    </a>
                                    <% } %>
                            </div>

                            <!-- Desktop Input Bayar (Hidden on Mobile) -->
                            <a href="/iuran/pay"
                                class="hidden md:inline-flex glass-button items-center px-4 py-2 text-sm font-medium rounded-lg text-gray-200 bg-white/10 hover:bg-white/15 border border-white/15 ml-2">
                                Input Bayar
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Table View (Matrix) -->
                <div id="view-table" class="mt-6 glass-card overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-white/10 text-xs">
                            <thead class="bg-emerald-500/10">
                                <tr>
                                    <th
                                        class="px-2 py-2 text-left font-medium text-emerald-400 uppercase tracking-wider sticky left-0 bg-[#0f1115] z-20 min-w-[100px] shadow-[2px_0_5px_-2px_rgba(0,0,0,0.3)] border-b border-emerald-500/20">
                                        Warga / Blok</th>
                                    <% ['Jan', 'Feb' , 'Mar' , 'Apr' , 'Mei' , 'Jun' , 'Jul' , 'Agt' , 'Sep' , 'Okt'
                                        , 'Nov' , 'Des' ].forEach(m=> { %>
                                        <th
                                            class="px-2 py-3 text-center font-medium text-emerald-400 uppercase tracking-wider border-l border-emerald-500/10 border-b border-emerald-500/20 min-w-[60px]">
                                            <%= m %>
                                        </th>
                                        <% }) %>
                                </tr>
                            </thead>
                            <tbody class="bg-white/5 divide-y divide-white/10">
                                <% warga.forEach(w=> { %>
                                    <tr
                                        class="transition-colors border-l-2 status-<%= w.status_huni.replace(/\s+/g, '-') %> <%= w.status_huni === 'kosong' ? 'bg-black/40 border-l-gray-600 hover:bg-black/60' : w.status_huni === 'kontrak' ? 'bg-amber-500/10 border-l-amber-500 hover:bg-amber-500/20' : w.status_huni === 'tidak huni' ? 'bg-blue-500/5 border-l-blue-500 hover:bg-blue-500/10' : 'hover:bg-white/10 border-l-transparent' %>">
                                        <td
                                            class="px-2 py-1 whitespace-nowrap sticky left-0 z-10 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.3)] <%= w.status_huni === 'kosong' ? 'bg-gray-900' : w.status_huni === 'kontrak' ? 'bg-[#1a1500]' : w.status_huni === 'tidak huni' ? 'bg-[#000d1a]' : 'bg-[#0f1115]' %>">
                                            <div class="font-medium text-gray-200">
                                                <%= w.nama %>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <div class="text-[10px] text-gray-500">Blok <%= w.blok %>-<%=
                                                            w.nomor_rumah %>
                                                </div>
                                                <% if(w.status_huni !=='tetap' ) { %>
                                                    <span
                                                        class="text-[9px] px-1.5 py-0.5 rounded-full uppercase tracking-wider font-bold <%= w.status_huni === 'kosong' ? 'bg-gray-700 text-gray-300' : 'bg-amber-500/20 text-amber-500' %>">
                                                        <%= w.status_huni %>
                                                    </span>
                                                    <% } %>
                                            </div>
                                        </td>

                                        <% matrix[w.id].forEach(status=> { %>
                                            <td
                                                class="px-2 py-2 whitespace-nowrap text-center border-l border-white/10">
                                                <div class="flex justify-center space-x-1">
                                                    <!-- KAS RT -->
                                                    <div class="inline-block px-1.5 py-1.5 rounded-full text-[7px] font-bold text-gray-900 min-w-[22px] text-center
                                    <%= status.kas_rt && status.kas_rt.status === 'lunas' ? 'bg-emerald-500' : 
                                        status.kas_rt && status.kas_rt.status === 'menunggu_konfirmasi' ? 'bg-amber-500' :
                                        status.kas_rt ? 'bg-red-500' : 'bg-white/10 text-gray-500' %>
                                    <%= status.kas_rt ? 'cursor-pointer hover:opacity-80' : '' %>"
                                                        title="<%= status.kas_rt ? 'Kas RT: ' + status.kas_rt.status.replace('_', ' ') : 'Belum Ditagih' %>"
                                                        onclick="showDetail(this)"
                                                        data-payment="<%- safeJson(status.kas_rt) %>">
                                                        <span
                                                            style="display: inline-block; transform: translateY(-0.5px); line-height: 1;">RT</span>
                                                    </div>
                                                    <!-- KAS GANG -->
                                                    <div class="inline-block px-1.5 py-1.5 rounded-full text-[7px] font-bold text-gray-900 min-w-[22px] text-center
                                    <%= status.kas_gang && status.kas_gang.status === 'lunas' ? 'bg-emerald-500' : 
                                        status.kas_gang && status.kas_gang.status === 'menunggu_konfirmasi' ? 'bg-amber-500' :
                                        status.kas_gang ? 'bg-red-500' : 'bg-white/10 text-gray-500' %>
                                    <%= status.kas_gang ? 'cursor-pointer hover:opacity-80' : '' %>"
                                                        title="<%= status.kas_gang ? 'Kas Gang: ' + status.kas_gang.status.replace('_', ' ') : 'Belum Ditagih' %>"
                                                        onclick="showDetail(this)"
                                                        data-payment="<%- safeJson(status.kas_gang) %>">
                                                        <span
                                                            style="display: inline-block; transform: translateY(-0.5px); line-height: 1;">GG</span>
                                                    </div>
                                                    <!-- SAMPAH -->
                                                    <div class="inline-block px-1.5 py-1.5 rounded-full text-[7px] font-bold text-gray-900 min-w-[22px] text-center
                                    <%= status.sampah && status.sampah.status === 'lunas' ? 'bg-emerald-500' : 
                                        status.sampah && status.sampah.status === 'menunggu_konfirmasi' ? 'bg-amber-500' :
                                        status.sampah ? 'bg-red-500' : 'bg-white/10 text-gray-500' %>
                                    <%= status.sampah ? 'cursor-pointer hover:opacity-80' : '' %>"
                                                        title="<%= status.sampah ? 'Sampah: ' + status.sampah.status.replace('_', ' ') : 'Belum Ditagih' %>"
                                                        onclick="showDetail(this)"
                                                        data-payment="<%- safeJson(status.sampah) %>">
                                                        <span
                                                            style="display: inline-block; transform: translateY(-0.5px); line-height: 1;">SP</span>
                                                    </div>
                                                </div>
                                            </td>
                                            <% }) %>
                                    </tr>
                                    <% }) %>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 bg-white/5 border-t border-white/10">
                        <div class="flex flex-wrap gap-4 text-xs text-gray-400">
                            <div class="flex items-center"><span
                                    class="w-3 h-3 bg-emerald-500 rounded-full mr-2"></span>Lunas
                            </div>
                            <div class="flex items-center"><span
                                    class="w-3 h-3 bg-amber-500 rounded-full mr-2"></span>Menunggu Konfirmasi</div>
                            <div class="flex items-center"><span
                                    class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>Belum
                                Lunas</div>
                            <div class="flex items-center"><span
                                    class="w-3 h-3 bg-white/10 rounded-full mr-2"></span>Belum
                                Ditagih</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Detail Modal -->
            <div id="paymentModal" class="hidden fixed inset-0 z-50" aria-labelledby="modal-title" role="dialog"
                aria-modal="true">
                <!-- Backdrop -->
                <div class="fixed inset-0 bg-black/60 transition-opacity backdrop-blur-sm" aria-hidden="true"
                    onclick="closePaymentModal()"></div>

                <!-- Modal Container (Centered) -->
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
                    <!-- Modal Content -->
                    <div
                        class="glass-card w-full max-w-lg transform overflow-hidden transition-all pointer-events-auto max-h-[90vh] flex flex-col">
                        <div class="p-6 overflow-y-auto">
                            <h3 class="text-lg leading-6 font-medium text-gray-100 mb-4" id="modal-title">Detail
                                Pembayaran</h3>
                            <div class="space-y-3">
                                <p class="text-sm text-gray-300" id="modal-warga"></p>
                                <p class="text-sm text-gray-300" id="modal-jenis"></p>
                                <p class="text-sm text-gray-300" id="modal-nominal"></p>
                                <div class="flex items-center gap-2">
                                    <p class="text-sm text-gray-300">Status:</p>
                                    <span id="modal-status-badge"
                                        class="px-3 py-1 rounded-full text-xs font-semibold"></span>
                                </div>
                                <div id="modal-proof" class="hidden mt-4 border border-white/10 rounded p-2 bg-white/5">
                                    <p class="text-xs font-bold mb-2 text-gray-300">Bukti Transfer:</p>
                                    <img src="" class="w-full object-contain max-h-64 rounded">
                                    <a href="#" target="_blank"
                                        class="block mt-2 text-gray-400 text-xs hover:underline text-center hover:text-gray-200">Lihat
                                        Ukuran Penuh</a>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white/5 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-white/10"
                            id="modal-actions">
                            <button type="button"
                                class="glass-button mt-3 w-full inline-flex justify-center rounded-lg px-4 py-2 text-base font-medium text-gray-300 hover:bg-white/12 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm border border-white/10"
                                onclick="closePaymentModal()">Close</button>

                            <% if (user && user.role==='admin' ) { %>
                                <button type="button" id="btn-reset-payment"
                                    class="hidden glass-button mt-3 w-full inline-flex justify-center rounded-lg px-4 py-2 text-base font-medium text-red-400 hover:bg-red-500/10 focus:outline-none sm:mt-0 sm:mr-3 sm:w-auto sm:text-sm border border-red-500/30"
                                    onclick="resetPayment()">
                                    Reset to Belum Ditagih
                                </button>
                                <% } %>
                        </div>
                    </div>
                </div>
            </div>


            <script src="/js/html2canvas.min.js"></script>
            <script>
                let currentPaymentId = null;

                function showDetail(element) {
                    const dataStr = element.getAttribute('data-payment');
                    if (!dataStr || dataStr === 'null') return;

                    try {
                        const data = JSON.parse(dataStr);
                        currentPaymentId = data.id;

                        const modal = document.getElementById('paymentModal');
                        if (!modal) return;

                        document.getElementById('modal-warga').innerText = `Warga: ${data.nama} (Blok ${data.blok}-${data.nomor_rumah})`;
                        if (data.payer_name) {
                            const payerInfo = document.createElement('div');
                            payerInfo.className = "text-xs text-emerald-400 mt-1 font-bold";
                            payerInfo.innerText = `(Dibayar oleh: ${data.payer_name})`;
                            document.getElementById('modal-warga').appendChild(payerInfo);
                        }
                        const date = new Date(data.periode);
                        const monthYear = date.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });

                        // Map 'keamanan' to 'KAS' for display consistency
                        const displayJenis = data.jenis === 'keamanan' ? 'KAS' : data.jenis.toUpperCase();
                        document.getElementById('modal-jenis').innerText = `Jenis: ${displayJenis} - ${monthYear}`;

                        document.getElementById('modal-nominal').innerText = `Nominal: Rp ${parseInt(data.jumlah).toLocaleString('id-ID')}`;

                        // Status badge with color
                        const statusBadge = document.getElementById('modal-status-badge');
                        const statusText = data.status.replace('_', ' ').toUpperCase();
                        statusBadge.innerText = statusText;

                        // Apply color based on status
                        if (data.status === 'lunas') {
                            statusBadge.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-emerald-500/20 text-emerald-400 border border-emerald-500/30';
                        } else if (data.status === 'menunggu_konfirmasi') {
                            statusBadge.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-amber-500/20 text-amber-400 border border-amber-500/30';
                        } else {
                            statusBadge.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-red-500/20 text-red-400 border border-red-500/30';
                        }

                        const proofDiv = document.getElementById('modal-proof');
                        const img = proofDiv.querySelector('img');
                        const link = proofDiv.querySelector('a');

                        if (data.bukti_bayar) {
                            proofDiv.classList.remove('hidden');
                            const src = data.bukti_bayar.startsWith('/uploads/') ? data.bukti_bayar : '/uploads/' + data.bukti_bayar;
                            img.src = src;
                            link.href = src;
                        } else {
                            proofDiv.classList.add('hidden');
                        }

                        const actionsDiv = document.getElementById('modal-actions');
                        const userRole = "<%= user ? user.role : '' %>";

                        let buttonsHtml = `
                            <button type="button" class="glass-button mt-3 w-full inline-flex justify-center rounded-lg px-4 py-2 text-base font-medium text-gray-300 hover:bg-white/12 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm border border-white/10" onclick="closePaymentModal()">Close</button>
                        `;

                        if (userRole === 'admin') {
                            buttonsHtml += `
                                <button type="button" class="glass-button mt-3 w-full inline-flex justify-center rounded-lg px-4 py-2 text-base font-medium text-red-400 hover:bg-red-500/10 focus:outline-none sm:mt-0 sm:mr-3 sm:w-auto sm:text-sm border border-red-500/30" onclick="resetPayment()">Reset to Belum Ditagih</button>
                             `;
                        }

                        if ((userRole === 'admin' || userRole === 'bendahara') && data.status === 'menunggu_konfirmasi') {
                            buttonsHtml = `
                                <a href="/iuran/confirm/${data.id}" class="w-full inline-flex justify-center rounded-lg px-4 py-2 bg-white/15 text-base font-medium text-gray-200 hover:bg-white/20 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm border border-white/15">Approve</a>
                                <a href="/iuran/reject/${data.id}" onclick="return confirm('Tolak pembayaran?')" class="w-full inline-flex justify-center rounded-lg px-4 py-2 bg-white/10 text-base font-medium text-gray-300 hover:bg-white/15 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm border border-white/10">Reject</a>
                            ` + buttonsHtml;
                        }

                        actionsDiv.innerHTML = buttonsHtml;

                        modal.classList.remove('hidden');
                    } catch (e) {
                        console.error(e);
                    }
                }

                function closePaymentModal() {
                    document.getElementById('paymentModal').classList.add('hidden');
                }

                async function resetPayment() {
                    if (!currentPaymentId) return;
                    if (!confirm('Apakah Anda yakin ingin mereset status pembayaran ini menjadi Belum Ditagih? Data pembayaran akan dihapus.')) return;

                    try {
                        const response = await fetch('/iuran/reset', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ id: currentPaymentId })
                        });

                        const result = await response.json();
                        if (result.success) {
                            alert('Status berhasil direset');
                            location.reload();
                        } else {
                            alert('Gagal reset: ' + result.message);
                        }
                    } catch (err) {
                        alert('Error: ' + err.message);
                    }
                }

                function toggleExportDropdown(event) {
                    if (event) event.stopPropagation();
                    const dropdown = document.getElementById('export-dropdown');
                    dropdown.classList.toggle('hidden');
                }

                function toggleFilters() {
                    const container = document.getElementById('filter-container');
                    const icon = document.getElementById('filter-icon');
                    container.classList.toggle('hidden');
                    // Reset rotation if hidden, rotate if shown
                    if (container.classList.contains('hidden')) {
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        icon.style.transform = 'rotate(180deg)';
                    }
                }

                // Close dropdown when clicking outside
                window.onclick = function (event) {
                    if (!event.target.closest('#menu-button') && !event.target.closest('#export-dropdown')) {
                        const dropdown = document.getElementById('export-dropdown');
                        if (dropdown && !dropdown.classList.contains('hidden')) {
                            dropdown.classList.add('hidden');
                        }
                    }
                }

                function exportToImage() {
                    const tableElement = document.querySelector('#view-table table');

                    if (!tableElement) return alert('Table not found');

                    const btn = document.getElementById('menu-button');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '⏳ Processing...';

                    html2canvas(tableElement, {
                        scale: 2,
                        useCORS: true,
                        logging: true,
                        backgroundColor: '#0a0a0a'
                    }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = 'Data_Iuran_' + new Date().getTime() + '.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                        btn.innerHTML = originalText;
                    }).catch(err => {
                        console.error(err);
                        alert('Gagal export image');
                        btn.innerHTML = originalText;
                    });
                }

                // Export to PDF function
                async function exportToPDF() {
                    const btn = document.getElementById('menu-button');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '⏳ Processing...';

                    try {
                        // Check if html2canvas is available
                        if (typeof html2canvas === 'undefined') {
                            throw new Error('html2canvas library not loaded');
                        }

                        // Load jsPDF library dynamically
                        if (typeof window.jspdf === 'undefined') {
                            const script = document.createElement('script');
                            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                            document.head.appendChild(script);
                            await new Promise((resolve, reject) => {
                                script.onload = resolve;
                                script.onerror = () => reject(new Error('Failed to load jsPDF'));
                            });
                        }

                        const { jsPDF } = window.jspdf;
                        const tableElement = document.getElementById('view-table');

                        if (!tableElement) {
                            throw new Error('Table element not found');
                        }

                        // Capture table as canvas
                        const canvas = await html2canvas(tableElement, {
                            scale: 2,
                            useCORS: true,
                            logging: false,
                            backgroundColor: '#0a0a0a'
                        });

                        const imgData = canvas.toDataURL('image/png');
                        const imgWidth = 210; // A4 width in mm
                        const pageHeight = 297; // A4 height in mm
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;

                        const pdf = new jsPDF('p', 'mm', 'a4');
                        let heightLeft = imgHeight;
                        let position = 0;

                        // Add first page
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;

                        // Add additional pages if needed
                        while (heightLeft >= 0) {
                            position = heightLeft - imgHeight;
                            pdf.addPage();
                            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                            heightLeft -= pageHeight;
                        }

                        // Download PDF
                        const filename = 'Data_Iuran_' + new Date().toISOString().slice(0, 10) + '.pdf';
                        pdf.save(filename);
                        btn.innerHTML = originalText;
                    } catch (err) {
                        console.error('Export PDF Error:', err);
                        alert('Gagal export PDF: ' + err.message);
                        btn.innerHTML = originalText;
                    }
                }
            </script>

            <script>
                let hideEmpty = true;

                function toggleEmptyRows() {
                    hideEmpty = !hideEmpty;
                    updateEmptyRowsVisibility();
                }

                function updateEmptyRowsVisibility() {
                    const btn = document.getElementById('toggle-empty-btn');
                    const span = btn.querySelector('span');
                    const label = document.getElementById('toggle-empty-label');
                    const rows = document.querySelectorAll('.status-kosong, .status-tidak-huni');

                    if (hideEmpty) {
                        // Hidden state (Switch ON - Green) -> Show "Huni"
                        btn.classList.remove('bg-gray-700');
                        btn.classList.add('bg-emerald-500');
                        span.classList.remove('translate-x-0');
                        span.classList.add('translate-x-4');
                        if (label) {
                            label.innerText = 'Huni';
                            label.classList.add('text-emerald-400');
                            label.classList.remove('text-gray-400');
                        }

                        rows.forEach(r => r.classList.add('hidden'));
                    } else {
                        // Visible state (Switch OFF - Gray) -> Show "Semua"
                        btn.classList.remove('bg-emerald-500');
                        btn.classList.add('bg-gray-700');
                        span.classList.remove('translate-x-4');
                        span.classList.add('translate-x-0');
                        if (label) {
                            label.innerText = 'Semua';
                            label.classList.remove('text-emerald-400');
                            label.classList.add('text-gray-400');
                        }

                        rows.forEach(r => r.classList.remove('hidden'));
                    }
                    localStorage.setItem('hideEmptyRows', hideEmpty);
                }

                document.addEventListener('DOMContentLoaded', () => {
                    const saved = localStorage.getItem('hideEmptyRows');
                    hideEmpty = saved === null ? true : saved === 'true'; // Default true
                    updateEmptyRowsVisibility();
                });
            </script>
            <!-- Payment Detail Modal (Moved to Root) -->
            <div id="paymentModal" class="hidden fixed inset-0 z-50" aria-labelledby="modal-title" role="dialog"
                aria-modal="true">
                <!-- Backdrop -->
                <div class="fixed inset-0 bg-black/60 transition-opacity backdrop-blur-sm" aria-hidden="true"
                    onclick="closePaymentModal()"></div>

                <!-- Modal Container (Centered) -->
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
                    <!-- Modal Content -->
                    <div
                        class="glass-card w-full max-w-lg transform overflow-hidden transition-all pointer-events-auto max-h-[90vh] flex flex-col">
                        <div class="p-6 overflow-y-auto">
                            <h3 class="text-lg leading-6 font-medium text-gray-100 mb-4" id="modal-title">Detail
                                Pembayaran</h3>
                            <div class="space-y-3">
                                <p class="text-sm text-gray-300" id="modal-warga"></p>
                                <p class="text-sm text-gray-300" id="modal-jenis"></p>
                                <p class="text-sm text-gray-300" id="modal-nominal"></p>
                                <div class="flex items-center gap-2">
                                    <p class="text-sm text-gray-300">Status:</p>
                                    <span id="modal-status-badge"
                                        class="px-3 py-1 rounded-full text-xs font-semibold"></span>
                                </div>
                                <div id="modal-proof" class="hidden mt-4 border border-white/10 rounded p-2 bg-white/5">
                                    <p class="text-xs font-bold mb-2 text-gray-300">Bukti Transfer:</p>
                                    <img src="" class="w-full object-contain max-h-64 rounded">
                                    <a href="#" target="_blank"
                                        class="block mt-2 text-gray-400 text-xs hover:underline text-center hover:text-gray-200">Lihat
                                        Ukuran Penuh</a>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white/5 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-white/10"
                            id="modal-actions">
                            <button type="button"
                                class="glass-button mt-3 w-full inline-flex justify-center rounded-lg px-4 py-2 text-base font-medium text-gray-300 hover:bg-white/12 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm border border-white/10"
                                onclick="closePaymentModal()">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            <%- include('../partials/footer') %>