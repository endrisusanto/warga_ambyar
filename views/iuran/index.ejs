<%- include('../partials/head') %>
    <%- include('../partials/navbar') %>
        <% function safeJson(obj) { if (!obj) return 'null' ; return JSON.stringify(obj).replace(/"/g, '&quot;' ); } %>

            <div class="glass-card">
                <div class="glass-card relative z-30">
                    <div
                        class="px-4 py-5 sm:px-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 border-b border-white/10">
                        <div class="w-full md:w-auto flex justify-between items-center">
                            <div>
                                <h3 class="text-lg leading-6 font-medium text-emerald-400">Data Iuran</h3>
                                <p class="mt-1 max-w-2xl text-sm text-emerald-100/70">Daftar tagihan dan pembayaran
                                    iuran
                                    warga.</p>
                            </div>
                        </div>

                        <!-- Mobile Action Bar (Visible < md) -->
                        <div class="w-full md:hidden mt-4 space-y-3">
                            <a href="/iuran/pay"
                                class="w-full glass-button inline-flex justify-center items-center px-4 py-3 text-base font-bold rounded-xl text-white bg-gradient-to-r from-emerald-500 to-teal-600 shadow-lg border border-white/20">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Input Bayar
                            </a>
                            <button onclick="toggleFilters()"
                                class="w-full glass-button inline-flex justify-between items-center px-4 py-2 text-sm font-medium rounded-lg text-gray-700 dark:text-gray-300 border border-white/10 bg-gray-100 dark:bg-white/5">
                                <span>Filters & Options</span>
                                <svg id="filter-icon" class="w-5 h-5 transform transition-transform duration-200"
                                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- Desktop & Expanded Mobile Filters -->
                        <div id="filter-container"
                            class="hidden md:flex w-full md:w-auto mt-2 md:mt-0 flex-col md:flex-row gap-2">
                            <div class="grid grid-cols-1 md:flex md:items-center gap-2 md:space-x-2">
                                <!-- Year Filter -->
                                <select onchange="window.location.href='/iuran?year='+this.value"
                                    class="glass-input w-full md:w-auto rounded-lg text-sm py-2 px-3 cursor-pointer">
                                    <% for(let y=2024; y<=parseInt(moment().format('YYYY')) + 1; y++) { %>
                                        <option value="<%= y %>" <%=y==year ? 'selected' : '' %>><%= y %>
                                        </option>
                                        <% } %>
                                </select>



                                <!-- Empty House Filter Switch -->
                                <div
                                    class="flex items-center justify-center gap-2 bg-gray-100 dark:bg-white/5 p-1.5 rounded-lg border border-white/10 h-[38px]">
                                    <span id="toggle-empty-label"
                                        class="text-xs text-gray-600 dark:text-gray-400 font-medium whitespace-nowrap w-[45px] text-center">Huni</span>
                                    <button id="toggle-empty-btn" onclick="toggleEmptyRows()" type="button"
                                        class="relative inline-flex h-5 w-9 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none bg-emerald-500"
                                        role="switch" aria-checked="true">
                                        <span aria-hidden="true"
                                            class="translate-x-4 pointer-events-none inline-block h-4 w-4 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                                    </button>
                                </div>

                                <!-- Export Dropdown -->
                                <div class="relative inline-block text-left w-full md:w-auto">
                                    <button onclick="toggleExportDropdown(event)" type="button"
                                        class="glass-button w-full md:w-auto justify-center inline-flex items-center px-3 py-2 text-sm font-medium rounded-lg text-gray-700 dark:text-gray-300 transition-colors border border-white/10"
                                        id="menu-button" aria-expanded="true" aria-haspopup="true">
                                        Export
                                        <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                            <path fill-rule="evenodd"
                                                d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                                clip-rule="evenodd" />
                                        </svg>
                                    </button>

                                    <div id="export-dropdown"
                                        class="hidden origin-top-right absolute right-0 mt-2 w-36 rounded-xl shadow-2xl bg-white/70 dark:bg-black/40 backdrop-blur-xl border border-white/20 dark:border-white/10 ring-1 ring-black ring-opacity-5 focus:outline-none z-50 overflow-hidden"
                                        role="menu" aria-orientation="vertical" aria-labelledby="menu-button"
                                        tabindex="-1">
                                        <div class="py-1" role="none">
                                            <button onclick="exportToImage(); toggleExportDropdown(event)"
                                                class="text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-white/10 hover:text-indigo-600 dark:hover:text-indigo-400 block px-4 py-2.5 text-sm w-full text-left transition-colors font-medium border-b border-gray-100 dark:border-white/5"
                                                role="menuitem" tabindex="-1">
                                                ðŸ“· Image
                                            </button>
                                            <button onclick="exportToPDF(); toggleExportDropdown(event)"
                                                class="text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-white/10 hover:text-indigo-600 dark:hover:text-indigo-400 block px-4 py-2.5 text-sm w-full text-left transition-colors font-medium border-b border-gray-100 dark:border-white/5"
                                                role="menuitem" tabindex="-1">
                                                ðŸ“„ PDF
                                            </button>
                                            <% if(user && (user.role==='admin' || user.role==='bendahara' )) { %>
                                                <a href="/iuran/export"
                                                    class="text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-white/10 hover:text-indigo-600 dark:hover:text-indigo-400 block px-4 py-2.5 text-sm w-full text-left transition-colors font-medium"
                                                    role="menuitem" tabindex="-1">
                                                    ðŸ“Š Excel
                                                </a>
                                                <% } %>
                                        </div>
                                    </div>
                                </div>

                                <% if(user && (user.role==='admin' || user.role==='bendahara' )) { %>
                                    <form action="/iuran/generate" method="POST" class="w-full md:w-auto">
                                        <button type="submit"
                                            class="glass-button w-full md:w-auto justify-center inline-flex items-center px-3 py-2 text-sm font-medium rounded-lg text-gray-700 dark:text-gray-300 transition-colors border border-white/10">
                                            Generate
                                        </button>
                                    </form>
                                    <a href="/iuran/arrears"
                                        class="glass-button w-full md:w-auto justify-center inline-flex items-center px-3 py-2 text-sm font-medium rounded-lg text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-white/10 hover:bg-white/15 transition-colors border border-white/15">
                                        Tunggakan
                                    </a>
                                    <% } %>
                            </div>

                            <!-- Desktop Input Bayar (Hidden on Mobile) -->
                            <a href="/iuran/pay"
                                class="hidden md:inline-flex glass-button items-center px-4 py-2 text-sm font-medium rounded-lg text-gray-200 bg-gray-200 dark:bg-white/10 hover:bg-white/15 border border-white/15 ml-2">
                                Input Bayar
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Table View (Matrix) -->
                <div id="view-table" class="mt-6 glass-card overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-white/10 text-xs">
                            <thead class="bg-emerald-500/10">
                                <tr>
                                    <th
                                        class="px-2 py-2 text-left font-medium text-emerald-400 uppercase tracking-wider sticky left-0 bg-[#0f1115] z-20 min-w-[100px] shadow-[2px_0_5px_-2px_rgba(0,0,0,0.3)] border-b border-emerald-500/20">
                                        Warga / Blok</th>
                                    <% ['Jan', 'Feb' , 'Mar' , 'Apr' , 'Mei' , 'Jun' , 'Jul' , 'Agt' , 'Sep' , 'Okt'
                                        , 'Nov' , 'Des' ].forEach(m=> { %>
                                        <th
                                            class="px-2 py-3 text-center font-medium text-emerald-400 uppercase tracking-wider border-l border-emerald-500/10 border-b border-emerald-500/20 min-w-[60px]">
                                            <%= m %>
                                        </th>
                                        <% }) %>
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-white/5 divide-y divide-white/10">
                                <% warga.forEach(w=> { %>
                                    <tr
                                        class="transition-colors border-l-2 status-<%= w.status_huni.replace(/\s+/g, '-') %> <%= w.status_huni === 'kosong' ? 'bg-black/40 border-l-gray-600 hover:bg-black/60' : w.status_huni === 'kontrak' ? 'bg-amber-500/10 border-l-amber-500 hover:bg-amber-500/20' : w.status_huni === 'tidak huni' ? 'bg-blue-500/5 border-l-blue-500 hover:bg-blue-500/10' : 'hover:bg-gray-200 dark:bg-white/10 border-l-transparent' %>">
                                        <td
                                            class="px-2 py-1 whitespace-nowrap sticky left-0 z-10 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.3)] <%= w.status_huni === 'kosong' ? 'bg-gray-900' : w.status_huni === 'kontrak' ? 'bg-[#1a1500]' : w.status_huni === 'tidak huni' ? 'bg-[#000d1a]' : 'bg-[#0f1115]' %>">
                                            <div class="font-medium text-gray-200">
                                                <%= w.nama %>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <div class="text-[10px] text-gray-500">Blok <%= w.blok %>-<%=
                                                            w.nomor_rumah %>
                                                </div>
                                                <% if(w.status_huni !=='tetap' ) { %>
                                                    <span
                                                        class="text-[9px] px-1.5 py-0.5 rounded-full uppercase tracking-wider font-bold <%= w.status_huni === 'kosong' ? 'bg-gray-700 text-gray-700 dark:text-gray-300' : 'bg-amber-500/20 text-amber-500' %>">
                                                        <%= w.status_huni %>
                                                    </span>
                                                    <% } %>
                                            </div>
                                        </td>

                                        <% matrix[w.id].forEach(status=> { %>
                                            <td
                                                class="px-2 py-2 whitespace-nowrap text-center border-l border-white/10">
                                                <div class="flex justify-center space-x-1">
                                                    <!-- KAS RT -->
                                                    <div class="inline-block px-1.5 py-1.5 rounded-full text-[7px] font-bold text-gray-900 min-w-[22px] text-center
                                    <%= status.kas_rt && status.kas_rt.status === 'lunas' ? 'bg-emerald-500' : 
                                        status.kas_rt && status.kas_rt.status === 'menunggu_konfirmasi' ? 'bg-amber-500' :
                                        status.kas_rt ? 'bg-red-500' : 'bg-gray-200 dark:bg-white/10 text-gray-500 dark:text-gray-300' %>
                                    <%= status.kas_rt ? 'cursor-pointer hover:opacity-80' : '' %>"
                                                        title="<%= status.kas_rt ? 'Kas RT: ' + status.kas_rt.status.replace('_', ' ') : 'Belum Ditagih' %>"
                                                        onclick="showDetail(this)"
                                                        data-payment="<%- safeJson(status.kas_rt) %>">
                                                        <span
                                                            style="display: inline-block; transform: translateY(-0.5px); line-height: 1;">RT</span>
                                                    </div>
                                                    <!-- KAS GANG -->
                                                    <div class="inline-block px-1.5 py-1.5 rounded-full text-[7px] font-bold text-gray-900 min-w-[22px] text-center
                                    <%= status.kas_gang && status.kas_gang.status === 'lunas' ? 'bg-emerald-500' : 
                                        status.kas_gang && status.kas_gang.status === 'menunggu_konfirmasi' ? 'bg-amber-500' :
                                        status.kas_gang ? 'bg-red-500' : 'bg-gray-200 dark:bg-white/10 text-gray-500 dark:text-gray-300' %>
                                    <%= status.kas_gang ? 'cursor-pointer hover:opacity-80' : '' %>"
                                                        title="<%= status.kas_gang ? 'Kas Gang: ' + status.kas_gang.status.replace('_', ' ') : 'Belum Ditagih' %>"
                                                        onclick="showDetail(this)"
                                                        data-payment="<%- safeJson(status.kas_gang) %>">
                                                        <span
                                                            style="display: inline-block; transform: translateY(-0.5px); line-height: 1;">GG</span>
                                                    </div>
                                                    <!-- SAMPAH -->
                                                    <div class="inline-block px-1.5 py-1.5 rounded-full text-[7px] font-bold text-gray-900 min-w-[22px] text-center
                                    <%= status.sampah && status.sampah.status === 'lunas' ? 'bg-emerald-500' : 
                                        status.sampah && status.sampah.status === 'menunggu_konfirmasi' ? 'bg-amber-500' :
                                        status.sampah ? 'bg-red-500' : 'bg-gray-200 dark:bg-white/10 text-gray-500 dark:text-gray-300' %>
                                    <%= status.sampah ? 'cursor-pointer hover:opacity-80' : '' %>"
                                                        title="<%= status.sampah ? 'Sampah: ' + status.sampah.status.replace('_', ' ') : 'Belum Ditagih' %>"
                                                        onclick="showDetail(this)"
                                                        data-payment="<%- safeJson(status.sampah) %>">
                                                        <span
                                                            style="display: inline-block; transform: translateY(-0.5px); line-height: 1;">SP</span>
                                                    </div>
                                                </div>
                                            </td>
                                            <% }) %>
                                    </tr>
                                    <% }) %>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 bg-gray-100 dark:bg-white/5 border-t border-white/10">
                        <div class="flex flex-wrap gap-4 text-xs text-gray-600 dark:text-gray-400">
                            <div class="flex items-center"><span
                                    class="w-3 h-3 bg-emerald-500 rounded-full mr-2"></span>Lunas
                            </div>
                            <div class="flex items-center"><span
                                    class="w-3 h-3 bg-amber-500 rounded-full mr-2"></span>Menunggu Konfirmasi</div>
                            <div class="flex items-center"><span
                                    class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>Belum
                                Lunas</div>
                            <div class="flex items-center"><span
                                    class="w-3 h-3 bg-gray-200 dark:bg-white/10 rounded-full mr-2"></span>Belum
                                Ditagih</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Detail Modal -->
            <!-- Payment Detail Modal moved to bottom -->


            <script src="/js/html2canvas.min.js"></script>
            <script>
                let currentPaymentId = null;

                function showDetail(element) {
                    const dataStr = element.getAttribute('data-payment');
                    if (!dataStr || dataStr === 'null') return;

                    try {
                        const data = JSON.parse(dataStr);
                        currentPaymentId = data.id;

                        const modal = document.getElementById('paymentModal');
                        if (!modal) return;

                        document.getElementById('modal-warga').innerText = `Warga: ${data.nama} (Blok ${data.blok}-${data.nomor_rumah})`;
                        if (data.payer_name) {
                            const payerInfo = document.createElement('div');
                            payerInfo.className = "text-xs text-emerald-400 mt-1 font-bold";
                            payerInfo.innerText = `(Dibayar oleh: ${data.payer_name})`;
                            document.getElementById('modal-warga').appendChild(payerInfo);
                        }
                        const date = new Date(data.periode);
                        const monthYear = date.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });

                        // Map 'keamanan' to 'KAS' for display consistency
                        const displayJenis = data.jenis === 'keamanan' ? 'KAS' : data.jenis.toUpperCase();
                        document.getElementById('modal-jenis').innerText = `Jenis: ${displayJenis} - ${monthYear}`;

                        document.getElementById('modal-nominal').innerText = `Nominal: Rp ${parseInt(data.jumlah).toLocaleString('id-ID')}`;

                        // Timeline Breadcrumb
                        const timelineContainer = document.getElementById('modal-timeline');
                        if (timelineContainer) {
                            timelineContainer.innerHTML = '';
                            if (data.tanggal_bayar) {
                                const bayarObj = new Date(data.tanggal_bayar);
                                const bayarStr = bayarObj.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }).replace('.', ':');

                                let html = `
                                    <div class="flex items-center bg-gray-200 dark:bg-white/10 border border-white/10 rounded-full px-1 py-1">
                                        <div class="flex items-center gap-2 px-3 py-1">
                                            <span class="text-xs text-gray-600 dark:text-gray-400 font-bold uppercase tracking-wider">Bayar</span>
                                            <span class="text-xs text-gray-200">${bayarStr}</span>
                                        </div>
                                `;

                                if (data.tanggal_konfirmasi) {
                                    const approveObj = new Date(data.tanggal_konfirmasi);
                                    const approveStr = approveObj.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }).replace('.', ':');

                                    html += `
                                        <div class="px-1 text-gray-600">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                            </svg>
                                        </div>
                                        <div class="flex items-center gap-2 px-3 py-1 bg-emerald-500/20 rounded-full border border-emerald-500/20">
                                            <span class="text-xs text-emerald-400 font-bold uppercase tracking-wider">Approved</span>
                                            <span class="text-xs text-emerald-300 font-medium">${approveStr}</span>
                                        </div>
                                    `;
                                }

                                html += `</div>`;
                                timelineContainer.innerHTML = html;
                                timelineContainer.classList.remove('hidden');
                            } else {
                                timelineContainer.classList.add('hidden');
                            }
                        }

                        // Status badge with color
                        const statusBadge = document.getElementById('modal-status-badge');
                        const statusText = data.status.replace('_', ' ').toUpperCase();
                        statusBadge.innerText = statusText;

                        // Apply color based on status
                        if (data.status === 'lunas') {
                            statusBadge.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-emerald-500/20 text-emerald-400 border border-emerald-500/30';
                        } else if (data.status === 'menunggu_konfirmasi') {
                            statusBadge.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-amber-500/20 text-amber-400 border border-amber-500/30';
                        } else {
                            statusBadge.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-red-500/20 text-red-400 border border-red-500/30';
                        }

                        const proofDiv = document.getElementById('modal-proof');
                        const img = proofDiv.querySelector('img');
                        const link = proofDiv.querySelector('a');

                        if (data.bukti_bayar) {
                            proofDiv.classList.remove('hidden');
                            const src = data.bukti_bayar.startsWith('/uploads/') ? data.bukti_bayar : '/uploads/' + data.bukti_bayar;
                            img.src = src;
                            link.href = src;

                            // Populate related transactions
                            const relatedDiv = document.getElementById('modal-related-transactions');
                            const relatedList = document.getElementById('modal-related-list');

                            if (relatedList) {
                                relatedList.innerHTML = '';
                                try {
                                    const rawTrans = document.getElementById('allTransactionsData').getAttribute('data-transactions');
                                    const allTrans = JSON.parse(rawTrans);

                                    // Filter by same proof file
                                    const related = allTrans.filter(t => t.bukti_bayar === data.bukti_bayar);

                                    if (related.length > 0 && data.status === 'lunas') {
                                        let total = 0;
                                        related.forEach(t => {
                                            const amount = parseInt(t.jumlah);
                                            total += amount;
                                            const date = new Date(t.periode).toLocaleDateString('id-ID', { month: 'short', year: '2-digit' });
                                            const type = t.jenis === 'keamanan' ? 'Kas RT' : (t.jenis === 'kas_gang' ? 'Kas Gang' : 'Sampah');

                                            const div = document.createElement('div');
                                            div.className = 'flex justify-between text-xs text-gray-700 dark:text-gray-300';
                                            div.innerHTML = `
                                            <span>${type} - ${date}</span>
                                            <span class="font-bold text-emerald-400">Rp ${amount.toLocaleString('id-ID')}</span>
                                        `;
                                            relatedList.appendChild(div);
                                        });

                                        if (related.length > 1) {
                                            const totalDiv = document.createElement('div');
                                            totalDiv.className = 'flex justify-between text-xs font-bold text-white pt-1 border-t border-white/10 mt-1';
                                            totalDiv.innerHTML = `
                                            <span>Total</span>
                                            <span>Rp ${total.toLocaleString('id-ID')}</span>
                                        `;
                                            relatedList.appendChild(totalDiv);
                                        }
                                        relatedDiv.classList.remove('hidden');
                                    } else {
                                        relatedDiv.classList.add('hidden');
                                    }
                                } catch (e) {
                                    console.error(e);
                                    relatedDiv.classList.add('hidden');
                                }
                            }

                        } else {
                            proofDiv.classList.add('hidden');
                        }

                        const actionsDiv = document.getElementById('modal-actions');
                        const userRole = "<%= user ? user.role : '' %>";

                        let buttonsHtml = `
                            <button type="button" class="glass-button mt-3 w-full inline-flex justify-center rounded-lg px-4 py-2 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-white/12 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm border border-white/10" onclick="closePaymentModal()">Close</button>
                        `;

                        if (userRole === 'admin') {
                            buttonsHtml += `
                                <button type="button" class="glass-button mt-3 w-full inline-flex justify-center rounded-lg px-4 py-2 text-base font-medium text-red-400 hover:bg-red-500/10 focus:outline-none sm:mt-0 sm:mr-3 sm:w-auto sm:text-sm border border-red-500/30" onclick="resetPayment()">Reset to Belum Ditagih</button>
                             `;
                        }

                        if ((userRole === 'admin' || userRole === 'bendahara') && data.status === 'menunggu_konfirmasi') {
                            buttonsHtml = `
                                <a href="/iuran/confirm/${data.id}" class="w-full inline-flex justify-center rounded-lg px-4 py-2 bg-white/15 text-base font-medium text-gray-200 hover:bg-white/20 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm border border-white/15">Approve</a>
                                <a href="/iuran/reject/${data.id}" onclick="return confirm('Tolak pembayaran?')" class="w-full inline-flex justify-center rounded-lg px-4 py-2 bg-gray-200 dark:bg-white/10 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-white/15 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm border border-white/10">Reject</a>
                            ` + buttonsHtml;
                        }

                        actionsDiv.innerHTML = buttonsHtml;

                        // Check for other pending items if this one is pending
                        if ((userRole === 'admin' || userRole === 'bendahara') && data.status === 'menunggu_konfirmasi') {
                            fetch('/iuran/get-pending-items', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ warga_id: data.warga_id })
                            })
                                .then(res => res.json())
                                .then(resp => {
                                    if (resp.success && resp.items.length > 1) {
                                        // Show batch selection
                                        const container = document.createElement('div');
                                        container.className = "mt-4 p-3 bg-gray-100 dark:bg-white/5 rounded-lg border border-white/10";

                                        let totalAmount = 0;
                                        let html = `<p class="text-xs font-bold text-gray-700 dark:text-gray-300 mb-2">Pembayaran Menunggu Konfirmasi Lainnya:</p>
                                                    <div class="space-y-2 max-h-40 overflow-y-auto">`;

                                        resp.items.forEach(item => {
                                            const date = new Date(item.periode);
                                            const mY = date.toLocaleDateString('id-ID', { month: 'short', year: '2-digit' });
                                            const j = item.jenis === 'keamanan' ? 'Kas RT' : (item.jenis === 'kas_gang' ? 'Kas Gang' : 'Sampah');
                                            const amount = parseInt(item.jumlah);
                                            totalAmount += amount;

                                            html += `
                                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 dark:bg-white/5 p-1 rounded">
                                                    <input type="checkbox" name="batch_ids" value="${item.id}" data-amount="${amount}" checked onchange="updateBatchTotal()" class="rounded border-gray-500 text-emerald-500 focus:ring-emerald-500 bg-gray-700">
                                                    <span class="text-xs text-gray-700 dark:text-gray-300 flex-1">${j} - ${mY}</span>
                                                    <span class="text-xs text-gray-600 dark:text-gray-400">Rp ${amount.toLocaleString('id-ID')}</span>
                                                </label>
                                            `;
                                        });

                                        html += `</div>
                                                 <div class="mt-3 pt-2 border-t border-white/10 flex justify-between items-center">
                                                     <span class="text-xs font-bold text-gray-700 dark:text-gray-300">Grand Total:</span>
                                                     <span id="batch-total" class="text-sm font-bold text-emerald-400">Rp ${totalAmount.toLocaleString('id-ID')}</span>
                                                 </div>`;

                                        container.innerHTML = html;

                                        // Insert before actions
                                        document.querySelector('#modal-actions').parentNode.insertBefore(container, document.querySelector('#modal-actions'));

                                        // Update Approve Button
                                        const approveBtn = actionsDiv.querySelector('a[href^="/iuran/confirm"]');
                                        if (approveBtn) {
                                            approveBtn.removeAttribute('href');
                                            approveBtn.setAttribute('onclick', 'approveBatch()');
                                            approveBtn.innerText = 'Approve Selected (' + resp.items.length + ')';
                                            approveBtn.className = approveBtn.className.replace('bg-white/15', 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30').replace('text-gray-200', '');
                                        }
                                    }
                                });
                        }

                        modal.classList.remove('hidden');
                    } catch (e) {
                        console.error(e);
                    }
                }

                async function approveBatch() {
                    const checkboxes = document.querySelectorAll('input[name="batch_ids"]:checked');
                    if (checkboxes.length === 0) return alert('Pilih minimal satu item');

                    const ids = Array.from(checkboxes).map(cb => cb.value);
                    if (!confirm(`Verifikasi ${ids.length} pembayaran terpilih?`)) return;

                    const btn = document.querySelector('button[onclick="approveBatch()"]');
                    if (btn) btn.innerText = 'Processing...';

                    try {
                        const response = await fetch('/iuran/confirm-batch', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ ids })
                        });
                        const result = await response.json();

                        if (result.success) {
                            if (result.waUrl) {
                                // Show Success Modal manually
                                const modal = document.getElementById('successModal');
                                const btn = document.getElementById('wa-link-btn');
                                const backBtn = modal.querySelector('button'); // The "Kembali ke Web" button

                                if (modal && btn) {
                                    btn.href = result.waUrl;

                                    // Update text for Admin context
                                    modal.querySelector('h3').innerText = 'Verifikasi Berhasil';
                                    modal.querySelector('p').innerText = 'Pembayaran telah diverifikasi. Kirim notifikasi ke Warga via WhatsApp?';

                                    // Ensure closing reloads the page to update table
                                    backBtn.onclick = function () { location.reload(); };
                                    btn.onclick = function () {
                                        setTimeout(() => location.reload(), 1000); // Reload after clicking WA
                                    };

                                    // Hide payment modal first
                                    document.getElementById('paymentModal').classList.add('hidden');
                                    modal.classList.remove('hidden');
                                } else {
                                    location.reload();
                                }
                            } else {
                                location.reload();
                            }
                        } else {
                            alert('Gagal: ' + result.message);
                        }
                    } catch (e) {
                        alert('Error: ' + e.message);
                    }
                }

                function updateBatchTotal() {
                    const checkboxes = document.querySelectorAll('input[name="batch_ids"]:checked');
                    let total = 0;
                    checkboxes.forEach(cb => {
                        total += parseInt(cb.getAttribute('data-amount') || 0);
                    });

                    const totalEl = document.getElementById('batch-total');
                    if (totalEl) totalEl.innerText = 'Rp ' + total.toLocaleString('id-ID');

                    // Update button count
                    const btn = document.querySelector('button[onclick="approveBatch()"]'); // It's actually an <a> tag converted to button-like
                    // Or find by text content or class? The previous code modified the <a> tag.
                    // Let's find the element that has onclick="approveBatch()"
                    const approveBtn = document.querySelector('[onclick="approveBatch()"]');
                    if (approveBtn) {
                        approveBtn.innerText = 'Approve Selected (' + checkboxes.length + ')';
                    }
                }

                function closePaymentModal() {
                    document.getElementById('paymentModal').classList.add('hidden');
                }

                async function resetPayment() {
                    if (!currentPaymentId) return;
                    if (!confirm('Apakah Anda yakin ingin mereset status pembayaran ini menjadi Belum Ditagih? Data pembayaran akan dihapus.')) return;

                    try {
                        const response = await fetch('/iuran/reset', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ id: currentPaymentId })
                        });

                        const result = await response.json();
                        if (result.success) {
                            alert('Status berhasil direset');
                            location.reload();
                        } else {
                            alert('Gagal reset: ' + result.message);
                        }
                    } catch (err) {
                        alert('Error: ' + err.message);
                    }
                }

                function toggleExportDropdown(event) {
                    if (event) event.stopPropagation();
                    const dropdown = document.getElementById('export-dropdown');
                    dropdown.classList.toggle('hidden');
                }

                function toggleFilters() {
                    const container = document.getElementById('filter-container');
                    const icon = document.getElementById('filter-icon');
                    container.classList.toggle('hidden');
                    // Reset rotation if hidden, rotate if shown
                    if (container.classList.contains('hidden')) {
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        icon.style.transform = 'rotate(180deg)';
                    }
                }

                // Close dropdown when clicking outside
                window.onclick = function (event) {
                    if (!event.target.closest('#menu-button') && !event.target.closest('#export-dropdown')) {
                        const dropdown = document.getElementById('export-dropdown');
                        if (dropdown && !dropdown.classList.contains('hidden')) {
                            dropdown.classList.add('hidden');
                        }
                    }
                }

                function exportToImage() {
                    const tableElement = document.querySelector('#view-table table');

                    if (!tableElement) return alert('Table not found');

                    const btn = document.getElementById('menu-button');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = 'â³ Processing...';

                    html2canvas(tableElement, {
                        scale: 2,
                        useCORS: true,
                        logging: true,
                        backgroundColor: '#0a0a0a'
                    }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = 'Data_Iuran_' + new Date().getTime() + '.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                        btn.innerHTML = originalText;
                    }).catch(err => {
                        console.error(err);
                        alert('Gagal export image');
                        btn.innerHTML = originalText;
                    });
                }

                // Export to PDF function
                async function exportToPDF() {
                    const btn = document.getElementById('menu-button');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = 'â³ Processing...';

                    try {
                        // Check if html2canvas is available
                        if (typeof html2canvas === 'undefined') {
                            throw new Error('html2canvas library not loaded');
                        }

                        // Load jsPDF library dynamically
                        if (typeof window.jspdf === 'undefined') {
                            const script = document.createElement('script');
                            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                            document.head.appendChild(script);
                            await new Promise((resolve, reject) => {
                                script.onload = resolve;
                                script.onerror = () => reject(new Error('Failed to load jsPDF'));
                            });
                        }

                        const { jsPDF } = window.jspdf;
                        const tableElement = document.getElementById('view-table');

                        if (!tableElement) {
                            throw new Error('Table element not found');
                        }

                        // Capture table as canvas
                        const canvas = await html2canvas(tableElement, {
                            scale: 2,
                            useCORS: true,
                            logging: false,
                            backgroundColor: '#0a0a0a'
                        });

                        const imgData = canvas.toDataURL('image/png');
                        const imgWidth = 297; // A4 landscape width in mm
                        const pageHeight = 210; // A4 landscape height in mm
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;

                        const pdf = new jsPDF('l', 'mm', 'a4');
                        let heightLeft = imgHeight;
                        let position = 0;

                        // Add first page
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;

                        // Add additional pages if needed
                        while (heightLeft >= 0) {
                            position = heightLeft - imgHeight;
                            pdf.addPage();
                            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                            heightLeft -= pageHeight;
                        }

                        // Download PDF
                        const filename = 'Data_Iuran_' + new Date().toISOString().slice(0, 10) + '.pdf';
                        pdf.save(filename);
                        btn.innerHTML = originalText;
                    } catch (err) {
                        console.error('Export PDF Error:', err);
                        alert('Gagal export PDF: ' + err.message);
                        btn.innerHTML = originalText;
                    }
                }
            </script>

            <script>
                let hideEmpty = true;

                function toggleEmptyRows() {
                    hideEmpty = !hideEmpty;
                    updateEmptyRowsVisibility();
                }

                function updateEmptyRowsVisibility() {
                    const btn = document.getElementById('toggle-empty-btn');
                    const span = btn.querySelector('span');
                    const label = document.getElementById('toggle-empty-label');
                    const rows = document.querySelectorAll('.status-kosong, .status-tidak-huni');

                    if (hideEmpty) {
                        // Hidden state (Switch ON - Green) -> Show "Huni"
                        btn.classList.remove('bg-gray-400');
                        btn.classList.add('bg-emerald-500');
                        span.classList.remove('translate-x-0');
                        span.classList.add('translate-x-4');
                        if (label) {
                            label.innerText = 'Huni';
                            label.classList.add('text-emerald-400');
                            label.classList.remove('text-gray-600', 'dark:text-gray-400');
                        }

                        rows.forEach(r => r.style.display = 'none');
                    } else {
                        // Visible state (Switch OFF - Gray) -> Show "Semua"
                        btn.classList.remove('bg-emerald-500');
                        btn.classList.add('bg-gray-400');
                        span.classList.remove('translate-x-4');
                        span.classList.add('translate-x-0');
                        if (label) {
                            label.innerText = 'Semua';
                            label.classList.remove('text-emerald-400');
                            label.classList.add('text-gray-600', 'dark:text-gray-400');
                        }

                        rows.forEach(r => r.style.display = '');
                    }
                    localStorage.setItem('hideEmptyRows', hideEmpty);
                }

                document.addEventListener('DOMContentLoaded', () => {
                    const saved = localStorage.getItem('hideEmptyRows');
                    hideEmpty = saved === null ? true : saved === 'true'; // Default true
                    updateEmptyRowsVisibility();
                });
            </script>
            <!-- Payment Detail Modal (Moved to Root) -->
            <div id="paymentModal" class="hidden fixed inset-0 z-50" aria-labelledby="modal-title" role="dialog"
                aria-modal="true">
                <!-- Backdrop -->
                <div class="fixed inset-0 bg-black/60 transition-opacity backdrop-blur-sm" aria-hidden="true"
                    onclick="closePaymentModal()"></div>

                <!-- Modal Container (Centered) -->
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
                    <!-- Modal Content -->
                    <div
                        class="glass-card w-full max-w-lg transform overflow-hidden transition-all pointer-events-auto max-h-[90vh] flex flex-col">
                        <div class="p-6 overflow-y-auto">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100 mb-4"
                                id="modal-title">Detail
                                Pembayaran</h3>
                            <div class="space-y-3">
                                <p class="text-sm text-gray-700 dark:text-gray-300" id="modal-warga"></p>
                                <p class="text-sm text-gray-700 dark:text-gray-300" id="modal-jenis"></p>
                                <p class="text-sm text-gray-700 dark:text-gray-300" id="modal-nominal"></p>
                                <div id="modal-timeline" class="hidden py-2 flex justify-center"></div>
                                <div class="flex items-center gap-2 pt-1 justify-center">
                                    <p class="text-sm text-gray-700 dark:text-gray-300">Status:</p>
                                    <span id="modal-status-badge"
                                        class="px-3 py-1 rounded-full text-xs font-semibold"></span>
                                </div>
                                <div id="modal-proof"
                                    class="hidden mt-4 border border-white/10 rounded p-2 bg-gray-100 dark:bg-white/5">
                                    <p class="text-xs font-bold mb-2 text-gray-700 dark:text-gray-300">Bukti Transfer:
                                    </p>
                                    <img src="" class="w-full object-contain max-h-64 rounded">
                                    <a href="#" target="_blank"
                                        class="block mt-2 text-gray-600 dark:text-gray-400 text-xs hover:underline text-center hover:text-gray-200">Lihat
                                        Ukuran Penuh</a>

                                    <div id="modal-related-transactions"
                                        class="mt-3 pt-3 border-t border-white/10 hidden">
                                        <p class="text-xs font-bold mb-2 text-emerald-400">Transaksi Terkait:</p>
                                        <div id="modal-related-list"
                                            class="space-y-1 max-h-32 overflow-y-auto custom-scrollbar"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-100 dark:bg-white/5 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-white/10"
                            id="modal-actions">
                            <button type="button"
                                class="glass-button mt-3 w-full inline-flex justify-center rounded-lg px-4 py-2 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-white/12 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm border border-white/10"
                                onclick="closePaymentModal()">Close</button>

                            <% if (user && user.role==='admin' ) { %>
                                <button type="button" id="btn-reset-payment"
                                    class="hidden glass-button mt-3 w-full inline-flex justify-center rounded-lg px-4 py-2 text-base font-medium text-red-400 hover:bg-red-500/10 focus:outline-none sm:mt-0 sm:mr-3 sm:w-auto sm:text-sm border border-red-500/30"
                                    onclick="resetPayment()">
                                    Reset to Belum Ditagih
                                </button>
                                <% } %>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Success Notification Modal -->
            <div id="successModal" class="hidden fixed inset-0 z-[60]" aria-labelledby="modal-title" role="dialog"
                aria-modal="true">
                <div class="fixed inset-0 bg-black/60 transition-opacity backdrop-blur-sm"></div>
                <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
                    <div class="glass-card w-full max-w-md transform overflow-hidden transition-all p-6 text-center">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                            <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100 mb-2">Pembayaran
                            Berhasil Diinput</h3>
                        <p class="text-sm text-gray-700 dark:text-gray-300 mb-6">
                            Data pembayaran telah tersimpan. Apakah Anda ingin mengirim notifikasi ke Admin via WhatsApp
                            sekarang?
                        </p>
                        <div class="flex flex-col sm:flex-row gap-3 justify-center">
                            <a id="wa-link-btn" href="#" target="_blank" onclick="closeSuccessModal()"
                                class="inline-flex justify-center px-4 py-2 text-sm font-bold rounded-xl text-white bg-[#25D366] hover:bg-[#128C7E] shadow-lg transition-all items-center gap-2">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                    <path
                                        d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z" />
                                </svg>
                                Kirim Notifikasi (WA)
                            </a>
                            <button type="button" onclick="closeSuccessModal()"
                                class="inline-flex justify-center px-4 py-2 text-sm font-medium rounded-xl text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-white/10 hover:bg-white/20 border border-white/10 transition-all">
                                Kembali ke Web
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <% if (typeof newPaymentWaUrl !=='undefined' && newPaymentWaUrl) { %>
                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        const modal = document.getElementById('successModal');
                        const btn = document.getElementById('wa-link-btn');
                        if (modal && btn) {
                            btn.href = "<%- newPaymentWaUrl %>";
                            modal.classList.remove('hidden');
                        }
                    });

                    function closeSuccessModal() {
                        document.getElementById('successModal').classList.add('hidden');
                    }
                </script>
                <% } %>

                    <div id="allTransactionsData" data-transactions="<%= JSON.stringify(allTransactions) %>"
                        class="hidden"></div>
                    <%- include('../partials/footer') %>