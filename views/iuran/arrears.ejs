<%- include('../partials/head') %>
    <%- include('../partials/navbar') %>

        <div class="glass-card">
            <div
                class="px-4 py-5 sm:px-6 border-b border-white/10 flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h3 class="text-lg leading-6 font-medium text-gray-100">Laporan Tunggakan</h3>
                    <p class="mt-1 max-w-2xl text-sm text-gray-400">Daftar warga yang belum melunasi iuran.</p>
                </div>
                <div class="flex gap-2">
                    <a href="/iuran"
                        class="glass-button px-4 py-2 text-sm font-medium rounded-lg text-gray-300 border border-white/10 hover:bg-white/5 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        Kembali
                    </a>
                    <div class="relative inline-block text-left">
                        <button id="export-main-btn" onclick="toggleExportDropdown(event)" type="button"
                            class="glass-button px-4 py-2 text-sm font-medium rounded-lg text-emerald-400 border border-emerald-500/20 bg-emerald-500/10 hover:bg-emerald-500/20 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            Export
                            <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd"
                                    d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                    clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div id="export-dropdown"
                            class="hidden origin-top-right absolute right-0 mt-2 w-36 rounded-md shadow-lg bg-gray-900/95 backdrop-blur-xl border border-white/20 ring-1 ring-black ring-opacity-5 focus:outline-none z-50">
                            <div class="py-1" role="none">
                                <button onclick="exportToImage(); toggleExportDropdown(event)"
                                    class="text-gray-300 hover:bg-white/10 block px-4 py-2 text-sm w-full text-left">Image</button>
                                <button onclick="exportToPDF(); toggleExportDropdown(event)"
                                    class="text-gray-300 hover:bg-white/10 block px-4 py-2 text-sm w-full text-left">PDF</button>
                                <button onclick="exportToExcel(); toggleExportDropdown(event)"
                                    class="text-gray-300 hover:bg-white/10 block px-4 py-2 text-sm w-full text-left">Excel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="report-content" class="overflow-x-auto">
                <table class="min-w-full divide-y divide-white/10">
                    <thead class="bg-white/5">
                        <tr>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                Rumah</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                Nama Warga</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                No HP</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                Periode</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                Jenis</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                Jumlah</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                Status</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/10 bg-transparent">
                        <% tunggakan.forEach(item=> { %>
                            <tr class="hover:bg-white/5 transition-colors">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                    <div class="font-bold text-gray-200">Blok <%= item.blok %> - <%= item.nomor_rumah %>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-200">
                                    <%= item.nama %>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">
                                    <%= item.no_hp || '-' %>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                    <%= moment(item.periode).format('MMMM YYYY') %>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300 capitalize">
                                    <span
                                        class="px-2 py-0.5 rounded text-xs font-medium <%= item.jenis === 'keamanan' ? 'bg-blue-500/20 text-blue-300' : 'bg-orange-500/20 text-orange-300' %>">
                                        <%= item.jenis==='keamanan' ? 'Kas' : item.jenis %>
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-200 font-mono">
                                    Rp <%= item.jumlah.toLocaleString('id-ID') %>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span
                                        class="px-2 py-1 inline-flex text-xs leading-5 font-bold rounded-full bg-red-500/20 text-red-300 border border-red-500/30">
                                        <%= item.status.replace('_', ' ' ).toUpperCase() %>
                                    </span>
                                </td>
                            </tr>
                            <% }) %>
                    </tbody>
                </table>
                <% if (tunggakan.length===0) { %>
                    <div class="text-center py-10 text-gray-500">
                        Tidak ada data tunggakan.
                    </div>
                    <% } %>
            </div>
        </div>

        <script src="/js/html2canvas.min.js"></script>
        <script>
            function toggleExportDropdown(event) {
                if (event) event.stopPropagation();
                const dropdown = document.getElementById('export-dropdown');
                dropdown.classList.toggle('hidden');
            }

            // Close dropdown when clicking outside
            window.onclick = function (event) {
                if (!event.target.closest('button') && !event.target.closest('#export-dropdown')) {
                    const dropdown = document.getElementById('export-dropdown');
                    if (dropdown && !dropdown.classList.contains('hidden')) {
                        dropdown.classList.add('hidden');
                    }
                }
            }

            async function exportToImage() {
                const btn = document.getElementById('export-main-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '⏳ Processing...';

                const element = document.getElementById('report-content');
                if (!element) {
                    btn.innerHTML = originalText;
                    return;
                }

                // Ensure html2canvas is loaded
                if (typeof html2canvas === 'undefined') {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                    document.head.appendChild(script);
                    await new Promise(r => script.onload = r);
                }

                html2canvas(element, { scale: 2, backgroundColor: '#0a0a0a' }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'Laporan_Tunggakan_' + new Date().getTime() + '.png';
                    link.href = canvas.toDataURL();
                    link.click();
                    btn.innerHTML = originalText;
                }).catch(err => {
                    console.error(err);
                    btn.innerHTML = originalText;
                });
            }

            function exportToExcel() {
                const table = document.querySelector('table');
                let csv = [];
                const rows = table.querySelectorAll('tr');

                rows.forEach(row => {
                    const cols = row.querySelectorAll('td, th');
                    let rowData = [];
                    cols.forEach(col => {
                        // Clean up text: remove newlines, extra spaces
                        let text = col.innerText.replace(/(\r\n|\n|\r)/gm, " ").replace(/\s+/g, " ").trim();
                        rowData.push('"' + text + '"');
                    });
                    csv.push(rowData.join(","));
                });

                const csvFile = new Blob([csv.join("\n")], { type: "text/csv" });
                const downloadLink = document.createElement("a");
                downloadLink.download = "Laporan_Tunggakan_" + new Date().toISOString().slice(0, 10) + ".csv";
                downloadLink.href = window.URL.createObjectURL(csvFile);
                downloadLink.style.display = "none";
                document.body.appendChild(downloadLink);
                downloadLink.click();
            }

            async function exportToPDF() {
                const btn = document.getElementById('export-main-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '⏳ Processing...';

                try {
                    // Check if html2canvas is available
                    if (typeof html2canvas === 'undefined') {
                        // Fallback if local script not found
                        const script = document.createElement('script');
                        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                        document.head.appendChild(script);
                        await new Promise((resolve, reject) => {
                            script.onload = resolve;
                            script.onerror = () => reject(new Error('Failed to load html2canvas'));
                        });
                    }

                    // Load jsPDF library dynamically
                    if (typeof window.jspdf === 'undefined') {
                        const script = document.createElement('script');
                        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                        document.head.appendChild(script);
                        await new Promise((resolve, reject) => {
                            script.onload = resolve;
                            script.onerror = () => reject(new Error('Failed to load jsPDF'));
                        });
                    }

                    const { jsPDF } = window.jspdf;
                    const element = document.getElementById('report-content');

                    if (!element) {
                        throw new Error('Content element not found');
                    }

                    // Capture content as canvas
                    const canvas = await html2canvas(element, {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#0a0a0a' // Dark background for PDF
                    });

                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 210; // A4 width in mm
                    const pageHeight = 297; // A4 height in mm
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    const pdf = new jsPDF('p', 'mm', 'a4');
                    let heightLeft = imgHeight;
                    let position = 0;

                    // Add first page
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    // Add additional pages if needed
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    // Download PDF
                    const filename = 'Laporan_Tunggakan_' + new Date().toISOString().slice(0, 10) + '.pdf';
                    pdf.save(filename);
                    btn.innerHTML = originalText;
                } catch (err) {
                    console.error('Export PDF Error:', err);
                    alert('Gagal export PDF: ' + err.message);
                    btn.innerHTML = originalText;
                }
            }
        </script>

        <%- include('../partials/footer') %>