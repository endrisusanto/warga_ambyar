<%- include('../partials/head') %>
    <%- include('../partials/navbar') %>

        <div class="max-w-2xl mx-auto glass-card p-8 m-4">
            <h3 class="text-2xl font-bold text-gray-100 mb-6 flex items-center gap-3">
                <span class="text-3xl">üí≥</span>
                Input Pembayaran Iuran
            </h3>
            <form action="/iuran/pay" method="POST" enctype="multipart/form-data">
                <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">

                    <div class="sm:col-span-6">
                        <label for="warga_id" class="block text-sm font-medium text-gray-300 mb-2">Nama Warga</label>
                        <div>
                            <select id="warga_id" name="warga_id"
                                class="glass-input block w-full sm:text-sm text-gray-100 rounded-xl p-3" <% if(user &&
                                user.role==='warga' && warga.length===1) { %>disabled<% } %>>
                                    <% warga.forEach(w=> { %>
                                        <option value="<%= w.id %>">
                                            <%= w.nama %> - Blok <%= w.blok %> No. <%= w.nomor_rumah %>
                                        </option>
                                        <% }) %>
                            </select>
                            <% if(user && user.role==='warga' && warga.length===1) { %>
                                <input type="hidden" name="warga_id" value="<%= warga[0].id %>">
                                <p class="mt-2 text-xs text-gray-400">Anda hanya dapat membayar iuran untuk rumah Anda
                                    sendiri.</p>
                                <% } %>
                        </div>
                    </div>

                    <div class="sm:col-span-6">
                        <label for="tahun" class="block text-sm font-medium text-gray-300 mb-2">Tahun</label>
                        <div>
                            <select id="tahun" name="tahun"
                                class="glass-input block w-full sm:text-sm text-gray-100 rounded-xl p-3">
                                <% const currentYear=new Date().getFullYear(); for(let y=currentYear - 1; y
                                    <=currentYear + 1; y++) { %>
                                    <option value="<%= y %>" <%=y===currentYear ? 'selected' : '' %>><%= y %>
                                    </option>
                                    <% } %>
                            </select>
                        </div>
                    </div>

                    <div class="sm:col-span-6">
                        <label class="block text-sm font-medium text-gray-300 mb-3">Pilih Bulan (Checkbox)</label>
                        <div class="grid grid-cols-3 sm:grid-cols-4 gap-2" id="month-grid">
                            <!-- Generated by JS -->
                        </div>
                        <p class="text-xs text-gray-400 mt-2">*Bulan yang sudah lunas tidak dapat dipilih.</p>
                    </div>

                    <div class="sm:col-span-6">
                        <label class="block text-sm font-medium text-gray-300 mb-3">Jenis Pembayaran</label>
                        <div class="flex flex-wrap items-center gap-4">
                            <div class="flex items-center">
                                <input id="iuran_kas_rt" name="jenis_iuran[]" value="kas_rt" type="checkbox" checked
                                    class="h-4 w-4 text-indigo-500 focus:ring-indigo-500 bg-white/10 border-white/20 rounded">
                                <label for="iuran_kas_rt" class="ml-2 block text-sm text-gray-100">
                                    üí∞ Kas RT (10k)
                                </label>
                            </div>
                            <div class="flex items-center">
                                <input id="iuran_kas_gang" name="jenis_iuran[]" value="kas_gang" type="checkbox" checked
                                    class="h-4 w-4 text-indigo-500 focus:ring-indigo-500 bg-white/10 border-white/20 rounded">
                                <label for="iuran_kas_gang" class="ml-2 block text-sm text-gray-100">
                                    üèòÔ∏è Kas Gang (10k)
                                </label>
                            </div>
                            <div class="flex items-center">
                                <input id="iuran_sampah" name="jenis_iuran[]" value="sampah" type="checkbox" checked
                                    class="h-4 w-4 text-indigo-500 focus:ring-indigo-500 bg-white/10 border-white/20 rounded">
                                <label for="iuran_sampah" class="ml-2 block text-sm text-gray-100">
                                    üóëÔ∏è Sampah (25k)
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="sm:col-span-6">
                        <label for="bukti_bayar" class="block text-sm font-medium text-gray-300 mb-2">Bukti Transfer
                            (Gambar)</label>
                        <div>
                            <input type="file" name="bukti_bayar" id="bukti_bayar" accept="image/*"
                                class="glass-input block w-full sm:text-sm text-gray-100 rounded-xl p-3 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-500/20 file:text-indigo-300 hover:file:bg-indigo-500/30">
                        </div>
                        <p class="mt-2 text-sm text-gray-400">Opsional jika bayar tunai langsung.</p>
                    </div>

                </div>

                <div class="mt-6 border-t border-white/10 pt-6">
                    <div class="flex justify-between items-center mb-6">
                        <div class="text-lg font-bold text-gray-200">Total Tagihan:</div>
                        <div id="total-display" class="text-2xl font-bold text-indigo-300">Rp 0</div>
                    </div>

                    <div id="qris-container"
                        class="hidden flex flex-col items-center justify-center bg-white/5 backdrop-blur-xl p-6 rounded-xl border border-white/20">
                        <p class="text-sm font-bold text-gray-200 mb-3 flex items-center gap-2">
                            <span class="text-2xl">üì±</span>
                            Scan QRIS untuk Pembayaran
                        </p>
                        <canvas id="qrcode-canvas"></canvas>
                        <p class="text-xs text-gray-400 mt-3">Merchant: <span id="merchant-name-display"></span></p>
                        <button type="button" id="download-qris-btn" onclick="downloadQris()"
                            class="mt-4 inline-flex items-center px-6 py-3 text-sm font-bold rounded-xl shadow-lg text-white bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 transition-all">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            Download QRIS
                        </button>
                    </div>
                </div>

                <div class="mt-8 flex justify-end gap-3">
                    <a href="/iuran"
                        class="px-6 py-3 rounded-xl text-sm font-medium text-gray-300 hover:bg-white/5 transition-all border border-white/10">
                        ‚Üê Batal
                    </a>
                    <button type="submit"
                        class="inline-flex items-center justify-center px-8 py-3 text-sm font-bold rounded-xl text-white bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 shadow-lg transition-all">
                        üí≥ Submit Payment
                    </button>
                </div>
            </form>
        </div>

        <!-- QRCode Lib -->
        <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

        <script>
            const wargaSelect = document.getElementById('warga_id');
            const tahunSelect = document.getElementById('tahun');
            const monthGrid = document.getElementById('month-grid');
            const typeCheckboxes = document.querySelectorAll('input[name="jenis_iuran[]"]');
            const totalDisplay = document.getElementById('total-display');
            const qrisContainer = document.getElementById('qris-container');
            const qrCanvas = document.getElementById('qrcode-canvas');
            const merchantNameDisplay = document.getElementById('merchant-name-display');

            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agt', 'Sep', 'Okt', 'Nov', 'Des'];

            // Listeners
            wargaSelect.addEventListener('change', refreshGrid);
            tahunSelect.addEventListener('change', refreshGrid);
            typeCheckboxes.forEach(cb => cb.addEventListener('change', () => {
                // Re-check lunas status when types change (e.g. maybe Kas Lunas but Sampah Not)
                // Actually status check returns all types status. Logic UI needs to combine.
                // Simpler: Just refresh Grid logic (which handles partials)
                refreshCheckboxesState();
                calculateTotal();
            }));

            // Generate Month Grid Buttons
            function renderGrid(year) {
                monthGrid.innerHTML = '';
                months.forEach((m, index) => {
                    const mm = String(index + 1).padStart(2, '0');
                    const value = `${year}-${mm}`;

                    const label = document.createElement('label');
                    label.className = "cursor-pointer border border-white/20 rounded-xl p-3 flex flex-col items-center justify-center transition-all hover:bg-white/10 bg-white/5 backdrop-blur-xl relative";

                    const input = document.createElement('input');
                    input.type = "checkbox";
                    input.name = "months[]";
                    input.value = value;
                    input.className = "hidden peer";
                    input.onchange = calculateTotal; // Recalc on toggle

                    const text = document.createElement('span');
                    text.innerText = m;
                    text.className = "font-semibold text-gray-300 peer-checked:text-indigo-300";

                    // Visual for checked state
                    const ring = document.createElement('div');
                    ring.className = "absolute inset-0 border-2 border-transparent peer-checked:border-indigo-400 peer-checked:bg-indigo-500/10 rounded-xl pointer-events-none";

                    // Status indicator (dot)
                    const dot = document.createElement('div');
                    dot.id = `status-${value}`;
                    dot.className = "w-2 h-2 rounded-full bg-gray-600 mt-1";

                    label.appendChild(input);
                    label.appendChild(text);
                    label.appendChild(ring);
                    label.appendChild(dot);

                    monthGrid.appendChild(label);
                });
            }

            let statusCache = []; // Store fetched status items

            async function refreshGrid() {
                const year = tahunSelect.value;
                const warga_id = wargaSelect.value;

                // Render grid checkboxes first
                renderGrid(year);

                // Fetch status
                if (!warga_id) return;

                try {
                    const response = await fetch('/iuran/check-status', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ warga_id, year })
                    });
                    const data = await response.json();
                    if (data.success) {
                        statusCache = data.items;
                        refreshCheckboxesState();
                    }
                } catch (e) { console.error(e); }

                calculateTotal();
            }

            function refreshCheckboxesState() {
                // Logic: Disable month IF ALL selected types are PAID.
                // If one selected type is unpaid, allow toggle. 
                // Or strictly: if ANY selected type is PAID, warn? 
                // User request: "disable button bulan yang sudah lunas".
                // Interpretasi: Jika user pilih "Kas" dan "Sampah", dan bulan Jan Kas=Lunas Sampah=Lunas -> Disable.
                // Jika Kas=Lunas, Sampah=Belum -> Enable (user bayar sampah).
                // Jika user hanya pilih "Kas", dan Kas=Lunas -> Disable.

                const selectedTypes = [];
                typeCheckboxes.forEach(cb => { if (cb.checked) selectedTypes.push(cb.value); });

                const checkboxes = monthGrid.querySelectorAll('input[type="checkbox"]');

                checkboxes.forEach(cb => { // cb.value = YYYY-MM
                    const ym = cb.value;
                    const label = cb.parentElement;
                    const dot = label.querySelector(`#status-${ym}`);

                    // Find status for this month
                    // statusCache contains items with .ym = "YYYY-MM", .jenis, .status
                    const monthItems = statusCache.filter(item => item.ym === ym);

                    let isFullyPaid = true;
                    let isPartiallyPaid = false;
                    let isPending = false;

                    // Check against SELECTED types
                    if (selectedTypes.length === 0) {
                        isFullyPaid = false; // logic fallback
                    } else {
                        for (const type of selectedTypes) {
                            // Mapping types might differ (keamanan/kas)
                            // Controller returns exact DB jenis.
                            // Frontend values: 'kas', 'sampah'.
                            // DB values: 'kas'/'keamanan', 'sampah'.
                            let dbType = type;

                            const item = monthItems.find(i => {
                                return (i.jenis === type) || (type === 'kas' && i.jenis === 'keamanan');
                            });

                            if (!item || item.status !== 'lunas') {
                                isFullyPaid = false;
                            }
                            if (item && item.status === 'lunas') {
                                isPartiallyPaid = true; // At least one selected type is paid
                            }
                            if (item && item.status === 'menunggu_konfirmasi') {
                                isPending = true;
                            }
                        }
                    }

                    // UI Update
                    if (selectedTypes.length > 0 && isFullyPaid) {
                        cb.disabled = true;
                        label.classList.add('opacity-50', 'bg-gray-100', 'cursor-not-allowed');
                        label.classList.remove('bg-white', 'hover:bg-gray-50');
                        dot.className = "w-2 h-2 rounded-full bg-green-500 mt-1"; // Green = Lunas
                        cb.checked = false;
                    } else if (isPending) {
                        // Maybe disable?
                        dot.className = "w-2 h-2 rounded-full bg-yellow-400 mt-1";
                    } else if (isPartiallyPaid) {
                        // Warning/Orange? User can still pay remainder.
                        dot.className = "w-2 h-2 rounded-full bg-orange-400 mt-1"; // Partial
                        cb.disabled = false;
                        label.classList.remove('opacity-50', 'bg-gray-100', 'cursor-not-allowed');
                    } else {
                        // Clean / Unpaid
                        cb.disabled = false;
                        label.classList.remove('opacity-50', 'bg-gray-100', 'cursor-not-allowed');
                        dot.className = "w-2 h-2 rounded-full bg-gray-200 mt-1";
                    }
                });
            }

            let qrisDebounce;

            function calculateTotal() {
                // Count selected months
                const selectedMonths = monthGrid.querySelectorAll('input:checked');
                const count = selectedMonths.length;

                let typePrice = 0;
                typeCheckboxes.forEach(cb => {
                    if (cb.checked) {
                        // Kas RT and Kas Gang = 10k, Sampah = 25k
                        if (cb.value === 'kas' || cb.value === 'kas_rt' || cb.value === 'kas_gang') {
                            typePrice += 10000;
                        } else if (cb.value === 'sampah') {
                            typePrice += 25000;
                        }
                    }
                });

                const total = count * typePrice;

                totalDisplay.innerText = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(total);

                if (total > 0) {
                    clearTimeout(qrisDebounce);
                    qrisDebounce = setTimeout(() => generateQris(total, count), 500);
                } else {
                    qrisContainer.classList.add('hidden');
                }
            }

            // QRIS Logic (similar to before but adapted)
            async function generateQris(amount, count) {
                // Merchant Name Generation
                // ... Similar logic ...
                const firstMonth = monthGrid.querySelector('input:checked')?.value;
                // Use first selected month for naming?
                // E.g. JAN24, etc.

                const wargaText = wargaSelect.options[wargaSelect.selectedIndex].text;
                const match = wargaText.match(/Blok\s+(.+)\s+No\.\s+(\d+)/i);
                let houseLabel = match ? `${match[1].trim()}/${match[2].trim().padStart(2, '0')}` : 'WARGA';

                let monthLabel = "MNTH";
                if (firstMonth) {
                    const d = new Date(firstMonth + '-01');
                    monthLabel = d.toLocaleString('id-ID', { month: 'short' }).toUpperCase() + String(d.getFullYear()).slice(-2);
                }
                if (count > 1) monthLabel += `(${count}BLN)`;

                const checked = [];
                typeCheckboxes.forEach(cb => { if (cb.checked) checked.push(cb.value); });
                let prefix = 'IURAN';
                if (checked.includes('kas') && checked.includes('sampah')) prefix = "KAS+SMPH";
                else if (checked.includes('kas')) prefix = "KAS";
                else if (checked.includes('sampah')) prefix = "SAMPAH";

                let merchantName = `${prefix} ${houseLabel} ${monthLabel}`.toUpperCase();
                if (merchantName.length > 25) merchantName = merchantName.substring(0, 25);
                merchantNameDisplay.innerText = merchantName;

                // Fetch API
                try {
                    const response = await fetch('/iuran/generate-qris', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ amount, merchantName })
                    });
                    const data = await response.json();
                    if (data.success) {
                        qrisContainer.classList.remove('hidden');
                        QRCode.toCanvas(qrCanvas, data.qr_string, { width: 250, margin: 2 }, function (error) {
                            if (error) console.error(error);
                        });
                    }
                } catch (e) { }
            }

            function downloadQris() {
                // ... same ...
                const qrCanvas = document.getElementById('qrcode-canvas');
                const merchantName = merchantNameDisplay.innerText || 'QRIS';
                const totalText = totalDisplay.innerText || 'Rp 0';
                const compositeCanvas = document.createElement('canvas');
                const ctx = compositeCanvas.getContext('2d');
                const qrSize = 250;
                const padding = 20;
                const textHeight = 80;
                compositeCanvas.width = qrSize + (padding * 2);
                compositeCanvas.height = qrSize + textHeight + (padding * 2);
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, compositeCanvas.width, compositeCanvas.height);
                ctx.drawImage(qrCanvas, padding, padding, qrSize, qrSize);
                ctx.fillStyle = '#1F2937';
                ctx.font = 'bold 16px Arial, sans-serif';
                ctx.textAlign = 'center';
                const textY = qrSize + padding + 25;
                ctx.fillText(merchantName, compositeCanvas.width / 2, textY);
                ctx.fillStyle = '#4F46E5';
                ctx.font = 'bold 20px Arial, sans-serif';
                ctx.fillText(totalText, compositeCanvas.width / 2, textY + 30);
                const filename = merchantName.replace(/[^a-zA-Z0-9]/g, '_') + '.png';
                compositeCanvas.toBlob(function (blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = filename;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                });
            }

            // Init
            refreshGrid();
        </script>

        <%- include('../partials/footer') %>